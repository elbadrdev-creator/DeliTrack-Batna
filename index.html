<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0A0E1A">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>DeliTrack</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- SheetJS pour export Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root {
  --bg:#0A0E1A; --surface:#111827; --card:#1A2236; --border:#1E2D45;
  --accent:#F97316; --accent2:#3B82F6; --accent3:#10B981;
  --text:#F1F5F9; --muted:#64748B; --danger:#EF4444; --yellow:#F59E0B;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
.screen{display:none;min-height:100vh;flex-direction:column}
.screen.active{display:flex}

/* CONFIG BANNER */
#configBanner{background:linear-gradient(135deg,#F97316,#EA580C);color:white;padding:14px 20px;font-size:13px;font-weight:600;text-align:center;cursor:pointer;display:none}
#configBanner.show{display:block}

/* LOGIN */
#login{background:var(--bg);align-items:center;justify-content:center;padding:32px 24px;position:relative;overflow:hidden}
.orb{position:absolute;border-radius:50%;filter:blur(80px);pointer-events:none}
.orb1{width:300px;height:300px;background:rgba(249,115,22,0.15);top:-100px;right:-80px}
.orb2{width:250px;height:250px;background:rgba(59,130,246,0.12);bottom:50px;left:-80px}
.login-logo{font-family:'Syne',sans-serif;font-size:36px;font-weight:800;letter-spacing:-1px;margin-bottom:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-sub{color:var(--muted);font-size:14px;margin-bottom:40px;letter-spacing:1px;text-transform:uppercase}
.role-selector{display:flex;gap:12px;margin-bottom:28px;width:100%;max-width:360px}
.role-btn{flex:1;padding:16px 8px;border-radius:16px;border:2px solid var(--border);background:var(--card);color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s;text-align:center}
.role-btn.selected{border-color:var(--accent);background:rgba(249,115,22,0.1);color:var(--accent)}
.role-icon{font-size:24px;display:block;margin-bottom:6px}
.fg{width:100%;max-width:360px;margin-bottom:14px}
.fl{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px;display:block}
.fi{width:100%;padding:14px 16px;background:var(--card);border:1.5px solid var(--border);border-radius:12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;outline:none;transition:border-color 0.2s}
.fi:focus{border-color:var(--accent)}
.btn-p{width:100%;max-width:360px;padding:16px;background:linear-gradient(135deg,var(--accent),#EA580C);border:none;border-radius:14px;color:white;font-family:'Syne',sans-serif;font-size:16px;font-weight:700;cursor:pointer;letter-spacing:0.5px;transition:opacity 0.2s,transform 0.1s;margin-top:8px}
.btn-p:active{transform:scale(0.98);opacity:0.9}
.login-err{color:var(--danger);font-size:13px;text-align:center;margin-top:10px;max-width:360px;display:none}

/* TOPBAR */
.topbar{background:var(--surface);padding:14px 18px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.topbar-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:700}
.tbadge{background:var(--accent);color:white;font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px;text-transform:uppercase}
.live-dot{display:inline-block;width:8px;height:8px;background:var(--accent3);border-radius:50%;margin-right:5px;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(0.85)}}

/* MAP */
.map-box{background:var(--surface);position:relative;overflow:hidden;height:320px;flex-shrink:0}
.leaflet-container{background:#0D1520 !important}
.leaflet-tile{filter:brightness(0.85) saturate(0.9) hue-rotate(180deg) invert(1) !important}
.leaflet-control-zoom a{background:var(--card)!important;color:var(--text)!important;border-color:var(--border)!important}
.livreur-marker{
  width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-family:'Syne',sans-serif;font-weight:800;font-size:13px;color:white;
  border:3px solid white;box-shadow:0 2px 12px rgba(0,0,0,0.4);cursor:pointer;
  transition:transform 0.2s;
}
.livreur-marker:hover{transform:scale(1.15)}
.livreur-marker.pulse::after{
  content:'';position:absolute;width:48px;height:48px;border-radius:50%;
  border:2px solid currentColor;animation:ripple 1.5s infinite;top:-9px;left:-9px;
}
@keyframes ripple{0%{opacity:0.8;transform:scale(0.8)}100%{opacity:0;transform:scale(1.6)}}
.delivery-marker{
  width:24px;height:24px;border-radius:50%;background:var(--accent3);
  border:2px solid white;box-shadow:0 1px 6px rgba(0,0,0,0.3);
  display:flex;align-items:center;justify-content:center;font-size:11px;
}
.leaflet-popup-content-wrapper{background:var(--card)!important;border:1px solid var(--border)!important;border-radius:14px!important;color:var(--text)!important;box-shadow:0 8px 24px rgba(0,0,0,0.4)!important}
.leaflet-popup-tip{background:var(--card)!important}
.popup-name{font-family:'Syne',sans-serif;font-weight:700;font-size:14px;margin-bottom:4px}
.popup-info{font-size:12px;color:var(--muted);margin-bottom:2px}
.map-badge{position:absolute;top:10px;left:10px;background:rgba(10,14,26,0.85);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:10px;padding:7px 12px;font-size:12px}

/* CONTENT */
.content{flex:1;overflow-y:auto;padding:18px;padding-bottom:90px}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}
.scard{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 10px;text-align:center}
.sval{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;line-height:1;margin-bottom:4px}
.slbl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}

/* SECTION TITLE */
.sec-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
.bcnt{background:var(--border);color:var(--text);font-size:11px;padding:2px 8px;border-radius:20px}

/* LIVREUR CARD */
.lcard{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:10px;cursor:pointer;transition:border-color 0.2s,transform 0.1s;position:relative;overflow:hidden}
.lcard::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:3px 0 0 3px}
.lcard.sa::before{background:var(--accent3)}
.lcard.sp::before{background:var(--yellow)}
.lcard.sd::before{background:var(--muted)}
.lcard:active{transform:scale(0.99)}
.lhdr{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.avatar{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:17px;font-weight:800;flex-shrink:0}
.linfo{flex:1}
.lname{font-weight:600;font-size:14px;margin-bottom:2px}
.lzone{font-size:12px;color:var(--muted)}
.spill{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:4px 10px;border-radius:20px}
.pa{background:rgba(16,185,129,0.15);color:var(--accent3)}
.pp{background:rgba(245,158,11,0.15);color:var(--yellow)}
.pd{background:rgba(100,116,139,0.15);color:var(--muted)}
.lstats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.mstat{background:rgba(255,255,255,0.03);border-radius:10px;padding:8px;text-align:center}
.msv{font-family:'Syne',sans-serif;font-size:14px;font-weight:700}
.msl{font-size:10px;color:var(--muted);margin-top:2px}

/* BOTTOM NAV */
.bnav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);display:flex;padding:8px 0 18px;z-index:200}
.nitem{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 4px;cursor:pointer;transition:color 0.2s;color:var(--muted);font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:0.5px}
.nitem.active{color:var(--accent)}
.nico{font-size:20px}

/* LIVREUR TOPBAR */
.ltopbar{background:linear-gradient(135deg,#1A2236,#111827);padding:18px 18px 22px;border-bottom:1px solid var(--border)}
.greeting{font-size:13px;color:var(--muted);margin-bottom:4px}
.lbigname{font-family:'Syne',sans-serif;font-size:22px;font-weight:800}
.gps-st{display:flex;align-items:center;gap:8px;margin-top:10px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.2);border-radius:10px;padding:8px 12px;font-size:12px;color:var(--accent3);font-weight:500}

/* PRODUCT ITEM */
.pitem{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px 14px;margin-bottom:10px;display:flex;align-items:center;gap:12px}
.picon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.pname{font-weight:500;font-size:14px;margin-bottom:2px}
.punit{font-size:12px;color:var(--muted)}
.qbadge{margin-left:auto;background:rgba(249,115,22,0.15);color:var(--accent);font-family:'Syne',sans-serif;font-size:17px;font-weight:800;padding:5px 13px;border-radius:10px;flex-shrink:0}

/* FORM SECTION */
.fsec{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:14px}
.fstitle{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--accent);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.di{width:100%;padding:12px 14px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color 0.2s;margin-bottom:10px}
.di:focus{border-color:var(--accent2)}
.di:last-child{margin-bottom:0}
.di::placeholder{color:var(--muted)}
.psel{background:var(--surface);border:1.5px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:10px}
.pcitem{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s}
.pcitem:last-child{border-bottom:none}
.cbox{width:20px;height:20px;border-radius:6px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;font-size:11px}
.cbox.ck{background:var(--accent);border-color:var(--accent)}
.cname{flex:1;font-size:14px}
.cqin{width:70px;padding:6px 10px;background:var(--card);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;text-align:center;outline:none}
.gps-btn{width:100%;padding:12px;background:rgba(59,130,246,0.1);border:1.5px solid rgba(59,130,246,0.3);border-radius:10px;color:var(--accent2);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:10px;transition:background 0.2s}
.gps-coords{font-size:11px;color:var(--accent3);text-align:center;margin-bottom:10px;font-weight:500}
.sbtn{width:100%;padding:15px;background:linear-gradient(135deg,var(--accent3),#059669);border:none;border-radius:14px;color:white;font-family:'Syne',sans-serif;font-size:16px;font-weight:700;cursor:pointer;transition:opacity 0.2s,transform 0.1s;letter-spacing:0.5px}
.sbtn:active{transform:scale(0.98)}
.sbtn:disabled{opacity:0.5;cursor:not-allowed}

/* TABS */
.tabs{display:flex;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:57px;z-index:90;overflow-x:auto}
.tab{flex-shrink:0;padding:13px 14px;text-align:center;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tc{display:none}
.tc.active{display:block}

/* HIST CARD */
.hcard{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px;position:relative}
.hcli{font-weight:600;font-size:14px;margin-bottom:3px}
.htim{font-size:11px;color:var(--muted);margin-bottom:6px}
.hdet{font-size:12px;color:var(--muted);margin-bottom:2px}

/* MODAL */
.mover{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:500;align-items:flex-end}
.mover.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:24px 24px 0 0;padding:22px 18px 36px;width:100%;max-height:92vh;overflow-y:auto;animation:slideUp 0.3s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mhandle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 18px}
.mtitle{font-family:'Syne',sans-serif;font-size:19px;font-weight:700;margin-bottom:4px}
.msub{font-size:13px;color:var(--muted);margin-bottom:18px}
.msg{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px}
.mst{background:var(--card);border-radius:12px;padding:13px}
.msv{font-family:'Syne',sans-serif;font-size:19px;font-weight:800;margin-bottom:3px}
.msl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
.cbtn{width:100%;padding:13px;background:var(--card);border:1.5px solid var(--border);border-radius:12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;cursor:pointer;margin-top:10px}

/* ADD BTN */
.add-btn{background:rgba(249,115,22,0.15);border:1.5px solid rgba(249,115,22,0.3);color:var(--accent);padding:6px 14px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:background 0.2s}
.add-btn:active{background:rgba(249,115,22,0.25)}

/* CLIENT CARD */
.client-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px;cursor:pointer;transition:border-color 0.2s}
.client-card:active{border-color:var(--accent)}
.client-name{font-weight:600;font-size:15px;margin-bottom:3px}
.client-info{font-size:12px;color:var(--muted);margin-bottom:2px}
.client-hist{font-size:12px;color:var(--accent3);font-weight:500;margin-top:6px}

/* EXPORT SECTION */
.exp-btn{width:100%;padding:13px;border:none;border-radius:12px;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:8px;transition:opacity 0.2s}
.exp-btn:active{opacity:0.8}

/* STOCK INLINE */
.stock-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)}
.stock-row:last-child{border-bottom:none}
.stock-bar{flex:1;height:6px;background:var(--border);border-radius:3px;margin:0 12px;overflow:hidden}
.stock-fill{height:100%;border-radius:3px;transition:width 0.4s}

/* LOADING */
.lscreen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity 0.4s}
.lscreen.hide{opacity:0;pointer-events:none}
.spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:14px}
@keyframes spin{to{transform:rotate(360deg)}}

/* TOAST */
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-80px);background:var(--accent3);color:white;padding:12px 22px;border-radius:30px;font-weight:600;font-size:14px;z-index:9999;transition:transform 0.35s cubic-bezier(0.34,1.56,0.64,1);white-space:nowrap;max-width:90vw;text-align:center}
.toast.show{transform:translateX(-50%) translateY(0)}

/* EMPTY */
.empty{text-align:center;padding:36px 20px;color:var(--muted);font-size:14px}
.eico{font-size:38px;margin-bottom:10px}

@keyframes fadeInUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.ai{animation:fadeInUp 0.35s ease forwards}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
</style>
</head>
<body>

<!-- LOADING -->
<div class="lscreen" id="loadingScreen">
  <div style="font-family:'Syne',sans-serif;font-size:28px;font-weight:800;background:linear-gradient(135deg,#F97316,#3B82F6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:22px">DeliTrack</div>
  <div class="spinner"></div>
  <div style="font-family:'Syne',sans-serif;font-size:13px;color:var(--muted)" id="loadTxt">Initialisation...</div>
</div>

<!-- CONFIG BANNER -->
<div id="configBanner" class="show" onclick="showCfg()">‚öôÔ∏è Configurer Supabase pour activer la synchronisation en temps r√©el ‚Üí</div>

<!-- ======== LOGIN ======== -->
<div id="login" class="screen active">
  <div class="orb orb1"></div><div class="orb orb2"></div>
  <div class="login-logo">DeliTrack</div>
  <div class="login-sub">Gestion livraison en temps r√©el</div>
  <div class="role-selector">
    <div class="role-btn selected" id="roleF" onclick="selRole('fournisseur',this)">
      <span class="role-icon">üè≠</span>Fournisseur
    </div>
    <div class="role-btn" id="roleL" onclick="selRole('livreur',this)">
      <span class="role-icon">üöö</span>Livreur
    </div>
  </div>
  <div class="fg"><label class="fl">Identifiant</label><input class="fi" id="loginUser" placeholder="Votre identifiant" autocomplete="username"></div>
  <div class="fg"><label class="fl">Mot de passe</label><input class="fi" type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
  <button class="btn-p" onclick="doLogin()">Connexion ‚Üí</button>
  <div class="login-err" id="loginErr"></div>
</div>

<!-- ======== FOURNISSEUR ======== -->
<div id="fApp" class="screen">
  <div class="topbar">
    <div>
      <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px">Tableau de bord</div>
      <div class="topbar-title">DeliTrack</div>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <span class="tbadge"><span class="live-dot"></span>LIVE</span>
      <span style="cursor:pointer;font-size:18px" onclick="logout()">‚¨ÖÔ∏è</span>
    </div>
  </div>

  <div class="map-box">
    <div id="realMap" style="width:100%;height:100%"></div>
    <div class="map-badge"><span class="live-dot"></span><span id="activeCount">0</span> livreurs actifs</div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="fTab('livreurs',this)">Livreurs</div>
    <div class="tab" onclick="fTab('livraisons',this)">Livraisons</div>
    <div class="tab" onclick="fTab('stock',this)">üì¶ Stock</div>
    <div class="tab" onclick="fTab('clients',this)">Clients</div>
    <div class="tab" onclick="fTab('equipe',this)">üë• √âquipe</div>
    <div class="tab" onclick="fTab('export',this)">üì• Export</div>
  </div>

  <div class="content">
    <!-- LIVREURS -->
    <div id="tf-livreurs" class="tc active">
      <div class="stats-row">
        <div class="scard"><div class="sval" style="color:var(--accent3)" id="stA">0</div><div class="slbl">Actifs</div></div>
        <div class="scard"><div class="sval" style="color:var(--accent)" id="stL">0</div><div class="slbl">Livraisons</div></div>
        <div class="scard"><div class="sval" style="color:var(--accent2)" id="stM">0</div><div class="slbl">DA encaiss√©</div></div>
      </div>
      <div class="sec-title">Livreurs <span class="bcnt" id="totalLiv">0</span></div>
      <div id="livreursList"></div>
    </div>

    <!-- LIVRAISONS -->
    <div id="tf-livraisons" class="tc">
      <div class="sec-title">Livraisons du jour</div>
      <div id="allDeliveries"></div>
    </div>

    <!-- STOCK -->
    <div id="tf-stock" class="tc">
      <div class="sec-title">Gestion du stock
        <button class="add-btn" onclick="openAddProduct()">+ Produit</button>
      </div>
      <div id="stockList"></div>

      <!-- APPROVISIONNEMENT -->
      <div style="margin-top:20px">
        <div class="sec-title">Approvisionnement</div>
        <div class="fsec">
          <div class="fstitle">üì¶ Ajouter un stock</div>
          <select class="di" id="approvProduit">
            <option value="">S√©lectionner un produit</option>
          </select>
          <input class="di" type="number" id="approvQty" placeholder="Quantit√© re√ßue">
          <input class="di" type="text" id="approvNote" placeholder="Note (fournisseur, lot, etc.)">
          <button class="sbtn" onclick="doApprov()" style="background:linear-gradient(135deg,#3B82F6,#1D4ED8)">+ Ajouter au stock</button>
        </div>
      </div>

      <!-- CHARGEMENT LIVREUR -->
      <div style="margin-top:20px">
        <div class="sec-title">Charger un livreur</div>
        <div class="fsec">
          <div class="fstitle">üöö Chargement du jour</div>
          <select class="di" id="chargLivreur">
            <option value="">S√©lectionner un livreur</option>
          </select>
          <div id="chargProduits" style="margin-bottom:10px"></div>
          <button class="sbtn" onclick="doChargement()">‚úÖ Valider le chargement</button>
        </div>
      </div>
    </div>

    <!-- CLIENTS -->
    <div id="tf-clients" class="tc">
      <div class="sec-title">Clients <span class="bcnt" id="totalClients">0</span></div>
      <div id="clientsList"></div>
    </div>

    <!-- EQUIPE -->
    <div id="tf-equipe" class="tc">
      <div class="sec-title">√âquipe
        <button class="add-btn" onclick="openAddLivreur()">+ Livreur</button>
      </div>
      <div id="equipeList"></div>
    </div>

    <!-- EXPORT -->
    <div id="tf-export" class="tc">
      <div class="fsec">
        <div class="fstitle">üì• Exporter les donn√©es</div>
        <p style="font-size:13px;color:var(--muted);margin-bottom:18px">T√©l√©chargez vos donn√©es au format Excel (.xlsx) pour les utiliser dans Excel, Google Sheets ou toute application offline.</p>

        <div style="margin-bottom:14px">
          <label class="fl">P√©riode</label>
          <select class="di" id="exportPeriod" style="margin-top:8px">
            <option value="month">Ce mois</option>
            <option value="quarter">Ce trimestre</option>
            <option value="semester">Ce semestre</option>
            <option value="year">Cette ann√©e</option>
            <option value="custom">Dates personnalis√©es</option>
          </select>
        </div>

        <div id="customDates" style="display:none">
          <input class="di" type="date" id="exportFrom" placeholder="Date d√©but">
          <input class="di" type="date" id="exportTo" placeholder="Date fin">
        </div>

        <div style="margin-bottom:14px">
          <label class="fl">Donn√©es √† exporter</label>
          <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:14px">
              <input type="checkbox" id="expLivraisons" checked style="width:16px;height:16px;accent-color:var(--accent)"> Livraisons
            </label>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:14px">
              <input type="checkbox" id="expClients" checked style="width:16px;height:16px;accent-color:var(--accent)"> Clients
            </label>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:14px">
              <input type="checkbox" id="expStock" checked style="width:16px;height:16px;accent-color:var(--accent)"> Mouvements de stock
            </label>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:14px">
              <input type="checkbox" id="expResume" checked style="width:16px;height:16px;accent-color:var(--accent)"> R√©sum√© par livreur
            </label>
          </div>
        </div>

        <button class="exp-btn" style="background:linear-gradient(135deg,#10B981,#059669);color:white" onclick="exportExcel()">
          üìä T√©l√©charger Excel (.xlsx)
        </button>
        <button class="exp-btn" style="background:linear-gradient(135deg,#3B82F6,#1D4ED8);color:white" onclick="exportCSV()">
          üìÑ T√©l√©charger CSV
        </button>
      </div>

      <div class="fsec">
        <div class="fstitle">üìä R√©sum√© p√©riode</div>
        <div class="stats-row">
          <div class="scard"><div class="sval" style="color:var(--accent3)" id="rL">0</div><div class="slbl">Livraisons</div></div>
          <div class="scard"><div class="sval" style="color:var(--accent)" id="rLiv">0</div><div class="slbl">Livreurs</div></div>
          <div class="scard"><div class="sval" style="color:var(--accent2)" id="rM">0</div><div class="slbl">DA total</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL LIVREUR DETAIL -->
  <div class="mover" id="livModal" onclick="closeMod('livModal')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="mhandle"></div>
      <div class="mtitle" id="modName"></div>
      <div class="msub" id="modSub"></div>
      <div class="msg" id="modStats"></div>
      <div id="modDelivs"></div>
      <button class="cbtn" onclick="closeMod('livModal')">Fermer</button>
    </div>
  </div>

  <!-- MODAL AJOUTER PRODUIT -->
  <div class="mover" id="addProdModal" onclick="closeMod('addProdModal')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="mhandle"></div>
      <div class="mtitle">‚ûï Nouveau produit</div>
      <div class="msub">Ajouter un produit au catalogue</div>
      <input class="fi" id="newProdNom" placeholder="Nom du produit" style="margin-bottom:12px">
      <input class="fi" id="newProdIcone" placeholder="Ic√¥ne (emoji ex: ü´ô)" style="margin-bottom:12px">
      <input class="fi" id="newProdUnite" placeholder="Unit√© (bouteilles, sacs, etc.)" style="margin-bottom:12px">
      <input class="fi" type="number" id="newProdStock" placeholder="Stock initial" style="margin-bottom:16px">
      <button class="btn-p" style="max-width:100%;margin-bottom:10px" onclick="saveNewProduct()">Enregistrer le produit</button>
      <button class="cbtn" onclick="closeMod('addProdModal')">Annuler</button>
    </div>
  </div>

  <!-- MODAL CLIENT DETAIL -->
  <div class="mover" id="clientModal" onclick="closeMod('clientModal')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="mhandle"></div>
      <div class="mtitle" id="cModName"></div>
      <div class="msub" id="cModSub"></div>
      <div class="msg" id="cModStats"></div>
      <div id="cModHistory"></div>
      <button class="cbtn" onclick="closeMod('clientModal')">Fermer</button>
    </div>
  </div>
</div>

<!-- ======== LIVREUR ======== -->
<div id="lApp" class="screen">
  <div class="ltopbar">
    <div class="greeting">Bonjour üëã</div>
    <div class="lbigname" id="lWelcome">Livreur</div>
    <div class="gps-st">
      <span class="live-dot"></span>
      <span id="gpsStTxt">GPS en attente...</span>
    </div>
  </div>

  <div class="tabs" style="top:132px">
    <div class="tab active" onclick="lTab('camion',this)">üöö Camion</div>
    <div class="tab" onclick="lTab('livrer',this)">‚ûï Livrer</div>
    <div class="tab" onclick="lTab('clients',this)">üë• Clients</div>
    <div class="tab" onclick="lTab('historique',this)">üìã Historique</div>
  </div>

  <div class="content" style="padding-top:14px">

    <!-- CAMION -->
    <div id="lt-camion" class="tc active">
      <div class="sec-title">Produits dans votre camion <span class="bcnt" id="camionCount">0</span></div>
      <div id="camionList"></div>
    </div>

    <!-- LIVRER -->
    <div id="lt-livrer" class="tc">
      <div class="fsec">
        <div class="fstitle">üë§ Informations Client</div>
        <!-- Recherche client existant -->
        <div style="position:relative;margin-bottom:10px">
          <input class="di" type="text" id="clientSearch" placeholder="üîç Rechercher un client existant..." oninput="searchClients(this.value)" style="margin-bottom:0">
          <div id="clientSuggestions" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--card);border:1.5px solid var(--border);border-radius:0 0 10px 10px;z-index:50;max-height:180px;overflow-y:auto"></div>
        </div>
        <input class="di" type="text" id="clientName" placeholder="Nom du client / √âpicerie">
        <input class="di" type="tel" id="clientPhone" placeholder="T√©l√©phone">
        <input class="di" type="text" id="clientAddr" placeholder="Adresse compl√®te">
      </div>

      <div class="fsec">
        <div class="fstitle">üìç Position GPS</div>
        <button class="gps-btn" onclick="capGPS()">üì° Capturer ma position GPS</button>
        <div class="gps-coords" id="gpsDsp">Position non captur√©e</div>
      </div>

      <div class="fsec">
        <div class="fstitle">üì¶ Produits Livr√©s</div>
        <div class="psel" id="prodCheck"></div>
      </div>

      <div class="fsec">
        <div class="fstitle">üíµ Encaissement</div>
        <input class="di" type="number" id="montant" placeholder="Montant encaiss√© (DA)" style="font-size:18px;font-weight:600">
        <select class="di" id="modePay">
          <option value="">Mode de paiement</option>
          <option value="Esp√®ces">Esp√®ces</option>
          <option value="Ch√®que">Ch√®que</option>
          <option value="Virement">Virement</option>
          <option value="Cr√©dit">Cr√©dit</option>
        </select>
        <textarea class="di" id="notesLiv" placeholder="Notes (optionnel)" rows="2" style="resize:none"></textarea>
      </div>

      <button class="sbtn" id="submitBtn" onclick="submitLivraison()">‚úÖ Valider la livraison</button>
    </div>

    <!-- CLIENTS LIVREUR -->
    <div id="lt-clients" class="tc">
      <div class="sec-title">Mes clients <span class="bcnt" id="lClientCount">0</span></div>
      <div id="lClientsList"></div>
    </div>

    <!-- HISTORIQUE -->
    <div id="lt-historique" class="tc">
      <div class="sec-title">Mes livraisons <span class="bcnt" id="myCount">0</span></div>
      <div id="myDelivs"></div>
    </div>

  </div>

  <div class="bnav">
    <div class="nitem active" onclick="lTab('camion',this);navAct(this)"><span class="nico">üöö</span>Camion</div>
    <div class="nitem" onclick="lTab('livrer',this);navAct(this)"><span class="nico">‚ûï</span>Livrer</div>
    <div class="nitem" onclick="lTab('clients',this);navAct(this)"><span class="nico">üë•</span>Clients</div>
    <div class="nitem" onclick="lTab('historique',this);navAct(this)"><span class="nico">üìã</span>Historique</div>
    <div class="nitem" onclick="logout()"><span class="nico">üîì</span>Quitter</div>
  </div>
</div>

<!-- MODAL AJOUTER/MODIFIER LIVREUR -->
<div class="mover" id="addLivModal" onclick="closeMod('addLivModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhandle"></div>
    <div class="mtitle" id="addLivTitle">‚ûï Nouveau livreur</div>
    <div class="msub">Remplissez les informations du livreur</div>
    <input type="hidden" id="editLivId">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div><label class="fl">Nom complet</label><input class="fi" id="livNom" placeholder="Ahmed Kader" style="margin-top:6px"></div>
      <div><label class="fl">Initiales</label><input class="fi" id="livInitiales" placeholder="AK" maxlength="2" style="margin-top:6px"></div>
    </div>
    <div style="margin-bottom:10px">
      <label class="fl">Zone / Secteur</label>
      <input class="fi" id="livZone" placeholder="El Harrach / Baraki" style="margin-top:6px">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div><label class="fl">Identifiant</label><input class="fi" id="livIdentifiant" placeholder="ahmed" style="margin-top:6px"></div>
      <div><label class="fl">Mot de passe</label><input class="fi" id="livPassword" placeholder="1234" style="margin-top:6px"></div>
    </div>
    <div style="margin-bottom:16px">
      <label class="fl">Couleur</label>
      <div style="display:flex;gap:10px;margin-top:8px;flex-wrap:wrap">
        <div class="color-opt" data-color="#F97316" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#F97316;cursor:pointer;border:3px solid white;box-sizing:border-box"></div>
        <div class="color-opt" data-color="#3B82F6" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#3B82F6;cursor:pointer;border:3px solid transparent;box-sizing:border-box"></div>
        <div class="color-opt" data-color="#10B981" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#10B981;cursor:pointer;border:3px solid transparent;box-sizing:border-box"></div>
        <div class="color-opt" data-color="#8B5CF6" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#8B5CF6;cursor:pointer;border:3px solid transparent;box-sizing:border-box"></div>
        <div class="color-opt" data-color="#EC4899" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#EC4899;cursor:pointer;border:3px solid transparent;box-sizing:border-box"></div>
        <div class="color-opt" data-color="#F59E0B" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#F59E0B;cursor:pointer;border:3px solid transparent;box-sizing:border-box"></div>
        <div class="color-opt" data-color="#EF4444" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#EF4444;cursor:pointer;border:3px solid transparent;box-sizing:border-box"></div>
        <div class="color-opt" data-color="#06B6D4" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#06B6D4;cursor:pointer;border:3px solid transparent;box-sizing:border-box"></div>
      </div>
      <input type="hidden" id="livCouleur" value="#F97316">
    </div>
    <button class="btn-p" style="max-width:100%;margin-bottom:10px" onclick="saveLivreur()">‚úÖ Enregistrer</button>
    <button class="cbtn" onclick="closeMod('addLivModal')">Annuler</button>
  </div>
</div>

<!-- MODAL CONFIRMER SUPPRESSION -->
<div class="mover" id="delLivModal" onclick="closeMod('delLivModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhandle"></div>
    <div class="mtitle" style="color:var(--danger)">üóëÔ∏è Supprimer le livreur</div>
    <div class="msub" id="delLivNom"></div>
    <p style="font-size:14px;color:var(--muted);margin-bottom:20px">Cette action est irr√©versible. Les livraisons seront conserv√©es mais il ne pourra plus se connecter.</p>
    <button class="btn-p" style="max-width:100%;background:linear-gradient(135deg,#EF4444,#DC2626);margin-bottom:10px" onclick="confirmDeleteLivreur()">Supprimer d√©finitivement</button>
    <button class="cbtn" onclick="closeMod('delLivModal')">Annuler</button>
  </div>
</div>

<!-- CONFIG MODAL -->
<div class="mover" id="cfgModal" onclick="closeMod('cfgModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhandle"></div>
    <div class="mtitle">‚öôÔ∏è Configuration Supabase</div>
    <div class="msub">Entrez vos cl√©s pour activer le temps r√©el</div>
    <div style="margin-bottom:14px">
      <label class="fl">Supabase URL</label>
      <input class="fi" id="sbUrl" placeholder="https://xxxxx.supabase.co" style="margin-top:8px">
    </div>
    <div style="margin-bottom:18px">
      <label class="fl">Supabase Anon Key</label>
      <input class="fi" id="sbKey" placeholder="eyJhbGciOiJIUzI1NiIs..." style="margin-top:8px">
    </div>
    <button class="btn-p" style="max-width:100%;margin-bottom:10px" onclick="saveCfg()">Sauvegarder et connecter</button>
    <button class="cbtn" onclick="closeMod('cfgModal')">Continuer sans Supabase (mode d√©mo)</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ========================================================
     JAVASCRIPT
     ======================================================== -->
<script>
// ============================================================
// SUPABASE CONFIG
// ============================================================
let SB_URL = localStorage.getItem('sb_url') || '';
let SB_KEY = localStorage.getItem('sb_key') || '';
let sb = null;
let useSb = false;

// ============================================================
// DONN√âES LOCALES (d√©mo)
// ============================================================
let lLivreurs = [
  {id:'l1',nom:'Ahmed Kader',zone:'El Harrach',initiales:'AK',couleur:'#F97316',statut:'actif',livraisons:0,montant:0,lat:36.71,lng:3.13,identifiant:'ahmed',mot_de_passe:'1234'},
  {id:'l2',nom:'Mohamed Amine',zone:'Bab Ezzouar',initiales:'MA',couleur:'#3B82F6',statut:'actif',livraisons:0,montant:0,lat:36.73,lng:3.19,identifiant:'mohamed',mot_de_passe:'1234'},
  {id:'l3',nom:'Youcef Benali',zone:'Kouba',initiales:'YB',couleur:'#10B981',statut:'pause',livraisons:0,montant:0,lat:36.74,lng:3.07,identifiant:'youcef',mot_de_passe:'1234'},
];
let lFournisseurs = [{id:'f1',nom:'Mon Entreprise',identifiant:'admin',mot_de_passe:'1234'}];
let lProduits = [
  {id:'p1',nom:'Huile v√©g√©tale 5L',icone:'ü´ô',quantite:120,unite:'bouteilles',couleur:'#F97316'},
  {id:'p2',nom:'Semoule fine 5kg',icone:'üåæ',quantite:80,unite:'sacs',couleur:'#F59E0B'},
  {id:'p3',nom:'Sucre 2kg',icone:'üç¨',quantite:200,unite:'paquets',couleur:'#EC4899'},
  {id:'p4',nom:'Farine T55 25kg',icone:'üåø',quantite:45,unite:'sacs',couleur:'#10B981'},
];
let lLivraisons = [];
let lClients = [];
let lStock = []; // mouvements de stock

// ============================================================
// STATE
// ============================================================
let curUser = null;
let curLivreur = null;
let selectedRole = 'fournisseur';
let chkProds = {};
let gpsCoords = null;
let gpsWatchId = null;
let camionProduits = []; // produits charg√©s sur ce livreur aujourd'hui

// ============================================================
// INIT
// ============================================================
window.addEventListener('load', () => {
  // Timeout de s√©curit√© : max 4 secondes puis on d√©marre quoi qu'il arrive
  const safeStart = setTimeout(() => {
    hideLoad();
    initApp();
  }, 4000);

  // V√©rifier si les scripts sont charg√©s
  function checkReady() {
    const sbOk = typeof window.supabase !== 'undefined';
    const xlsxOk = typeof XLSX !== 'undefined';
    if (sbOk && xlsxOk) {
      clearTimeout(safeStart);
      hideLoad();
      initApp();
    } else {
      setTimeout(checkReady, 200);
    }
  }
  checkReady();
});

async function initApp() {
  setTxt('D√©marrage...');
  if (SB_URL && SB_KEY) await initSb();
  if (useSb) document.getElementById('configBanner').classList.remove('show');
  const ep = document.getElementById('exportPeriod');
  if (ep) ep.addEventListener('change', e => {
    document.getElementById('customDates').style.display = e.target.value === 'custom' ? 'block' : 'none';
  });
}

async function initSb() {
  try {
    setTxt('Connexion Supabase...');
    if (!window.supabase) throw new Error('SDK Supabase non charg√©');
    sb = window.supabase.createClient(SB_URL, SB_KEY);
    const {data, error} = await sb.from('livreurs').select('id').limit(1);
    if (error) throw error;
    useSb = true;
    const banner = document.getElementById('configBanner');
    if (banner) banner.classList.remove('show');
    showToast('Supabase connect√© ‚úì');
    console.log('‚úÖ Supabase connect√© avec succ√®s');
  } catch(e) {
    useSb = false;
    console.error('‚ùå Erreur Supabase:', e.message || e);
    console.log('URL utilis√©e:', SB_URL);
    console.log('Cl√© (d√©but):', SB_KEY?.substring(0,20)+'...');
  }
}

function setTxt(t){const e=document.getElementById('loadTxt');if(e)e.textContent=t}
function hideLoad(){const e=document.getElementById('loadingScreen');e.classList.add('hide');setTimeout(()=>e.remove(),500)}

// ============================================================
// CONFIG
// ============================================================
function showCfg(){document.getElementById('cfgModal').classList.add('open')}
async function saveCfg(){
  const u=document.getElementById('sbUrl').value.trim();
  const k=document.getElementById('sbKey').value.trim();
  if(!u||!k){showToast('‚ö†Ô∏è Remplissez les deux champs',true);return}
  SB_URL=u;SB_KEY=k;
  localStorage.setItem('sb_url',u);localStorage.setItem('sb_key',k);
  closeMod('cfgModal');
  await initSb();
  if(!useSb) showToast('‚ùå Cl√©s incorrectes',true);
}

// ============================================================
// LOGIN
// ============================================================
function selRole(r,el){
  selectedRole=r;
  document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
}

async function doLogin(){
  const u=document.getElementById('loginUser').value.trim();
  const p=document.getElementById('loginPass').value.trim();
  const role = document.querySelector('.role-btn.selected')?.id === 'roleL' ? 'livreur' : 'fournisseur';
  if(!u||!p){showErr('Remplissez tous les champs');return}

  if(useSb){
    if(role==='fournisseur'){
      const {data,error}=await sb.from('fournisseurs').select('*').eq('identifiant',u).eq('mot_de_passe',p).single();
      if(error||!data){showErr('Identifiant ou mot de passe incorrect');return}
      curUser=data; enterF();
    } else {
      const {data,error}=await sb.from('livreurs').select('*').eq('identifiant',u).eq('mot_de_passe',p).single();
      if(error||!data){showErr('Identifiant ou mot de passe incorrect');return}
      curUser=data; curLivreur=data; enterL();
    }
  } else {
    if(role==='fournisseur'){
      const f=lFournisseurs.find(x=>x.identifiant===u&&x.mot_de_passe===p);
      if(!f){showErr('D√©mo: admin / 1234');return}
      curUser=f; enterF();
    } else {
      const l=lLivreurs.find(x=>x.identifiant===u&&x.mot_de_passe===p);
      if(!l){showErr('D√©mo livreurs: ahmed/1234 ¬∑ mohamed/1234 ¬∑ youcef/1234');return}
      curUser=l; curLivreur=l; enterL();
    }
  }
}

function showErr(m){const e=document.getElementById('loginErr');e.textContent=m;e.style.display='block'}
function enterF(){document.getElementById('login').classList.remove('active');document.getElementById('fApp').classList.add('active');initF()}
function enterL(){document.getElementById('login').classList.remove('active');document.getElementById('lApp').classList.add('active');document.getElementById('lWelcome').textContent=curLivreur?.nom||'Livreur';initL()}

function logout(){
  stopGPS();
  curUser=curLivreur=null;
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('login').classList.add('active');
  document.getElementById('loginErr').style.display='none';
}

// ============================================================
// FOURNISSEUR INIT
// ============================================================
async function initF(){
  await loadLivreurs();
  await loadAllDeliveries();
  await loadStock();
  await loadAllClients();
  initMap();
  updateResumeStats();
  if(useSb) subRealtime();
}

// ============================================================
// LIVREURS
// ============================================================
async function loadLivreurs(){
  let livs = lLivreurs;
  if(useSb){
    const {data}=await sb.from('livreurs').select('*');
    if(data) livs=data;
    const today=new Date().toISOString().split('T')[0];
    for(const l of livs){
      const {data:d}=await sb.from('livraisons').select('montant').eq('livreur_id',l.id).gte('created_at',today);
      if(d){l.livraisons=d.length;l.montant=d.reduce((s,x)=>s+(x.montant||0),0)}
    }
  }
  renderLivreurs(livs);
  updateStats(livs);
}

function renderLivreurs(livs){
  document.getElementById('totalLiv').textContent=livs.length;
  const sm={actif:'sa',pause:'sp',termine:'sd',active:'sa',done:'sd'};
  const pm={actif:'pa',pause:'pp',termine:'pd',active:'pa',done:'pd'};
  const lm={actif:'En route',pause:'En pause',termine:'Termin√©',active:'En route',done:'Termin√©'};
  document.getElementById('livreursList').innerHTML=livs.map(l=>{
    const st=l.statut||l.status||'actif';
    const ini=l.initiales||l.nom?.substring(0,2).toUpperCase()||'??';
    const col=l.couleur||'#F97316';
    return `<div class="lcard ${sm[st]||'sa'} ai" onclick="showLivModal('${l.id}')">
      <div class="lhdr">
        <div class="avatar" style="background:${col}22;color:${col}">${ini}</div>
        <div class="linfo"><div class="lname">${l.nom}</div><div class="lzone">üìç ${l.zone||''}</div></div>
        <span class="spill ${pm[st]||'pa'}">${lm[st]||'En route'}</span>
      </div>
      <div class="lstats">
        <div class="mstat"><div class="msv" style="color:var(--accent)">${l.livraisons||0}</div><div class="msl">Livraisons</div></div>
        <div class="mstat"><div class="msv" style="color:var(--accent3)">${((l.montant||0)/1000).toFixed(1)}k</div><div class="msl">DA</div></div>
        <div class="mstat"><div class="msv">${st==='actif'||st==='active'?'üü¢':st==='pause'?'üü°':'‚ö™'}</div><div class="msl">Statut</div></div>
      </div>
    </div>`;
  }).join('');

  // Remplir select chargement
  const sel=document.getElementById('chargLivreur');
  sel.innerHTML='<option value="">S√©lectionner un livreur</option>'+livs.map(l=>`<option value="${l.id}">${l.nom}</option>`).join('');
}

function updateStats(livs){
  const a=livs.filter(l=>(l.statut||l.status)==='actif'||(l.statut||l.status)==='active').length;
  const tl=livs.reduce((s,l)=>s+(l.livraisons||0),0);
  const tm=livs.reduce((s,l)=>s+(l.montant||0),0);
  document.getElementById('stA').textContent=a;
  document.getElementById('stL').textContent=tl;
  document.getElementById('stM').textContent=tm>=1000?(tm/1000).toFixed(0)+'k':tm;
  document.getElementById('activeCount').textContent=a;
}

// ============================================================
// LIVRAISONS
// ============================================================
async function loadAllDeliveries(){
  let livs=lLivraisons;
  if(useSb){
    const today=new Date().toISOString().split('T')[0];
    const {data}=await sb.from('livraisons').select('*,livreurs(nom)').gte('created_at',today).order('created_at',{ascending:false});
    if(data) livs=data;
  }
  const c=document.getElementById('allDeliveries');
  if(!livs.length){c.innerHTML='<div class="empty"><div class="eico">üì¶</div>Aucune livraison aujourd\'hui</div>';return}
  c.innerHTML=livs.map(d=>`
    <div class="hcard ai">
      <div class="hcli">${d.client_nom||d.client||''}</div>
      <div class="htim">üöö ${d.livreurs?.nom||d.livreur||''} ¬∑ ${fmtTime(d.created_at||d.heure)}</div>
      <div class="hdet">üì¶ ${d.produits||''}</div>
      <div class="hdet">üìç ${d.lat?Number(d.lat).toFixed(5):''}, ${d.lng?Number(d.lng).toFixed(5):''}</div>
      <div style="font-size:13px;font-weight:700;color:var(--accent3);margin-top:8px">${(d.montant||0).toLocaleString()} DA ¬∑ ${d.mode_paiement||''}</div>
    </div>`).join('');
}

// ============================================================
// STOCK
// ============================================================
async function loadStock(){
  let prods=lProduits;
  if(useSb){
    const {data}=await sb.from('produits').select('*');
    if(data) prods=data;
  }
  renderStock(prods);
  // Remplir selects
  const s=document.getElementById('approvProduit');
  s.innerHTML='<option value="">S√©lectionner un produit</option>'+prods.map(p=>`<option value="${p.id}">${p.icone||'üì¶'} ${p.nom}</option>`).join('');
  renderChargProduits(prods);
}

function renderStock(prods){
  if(!prods.length){document.getElementById('stockList').innerHTML='<div class="empty"><div class="eico">üì¶</div>Aucun produit</div>';return}
  const maxQ=Math.max(...prods.map(p=>p.quantite||0),1);
  document.getElementById('stockList').innerHTML=`
    <div class="fsec">
      ${prods.map(p=>{
        const pct=Math.min(100,Math.round(((p.quantite||0)/maxQ)*100));
        const col=pct>50?'var(--accent3)':pct>20?'var(--yellow)':'var(--danger)';
        return `<div class="stock-row">
          <div style="display:flex;align-items:center;gap:8px;flex:1">
            <span style="font-size:20px">${p.icone||'üì¶'}</span>
            <div><div style="font-size:13px;font-weight:500">${p.nom}</div><div style="font-size:11px;color:var(--muted)">${p.unite||''}</div></div>
          </div>
          <div class="stock-bar"><div class="stock-fill" style="width:${pct}%;background:${col}"></div></div>
          <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:${col};min-width:50px;text-align:right">${p.quantite||0}</div>
        </div>`;
      }).join('')}
    </div>`;
}

function renderChargProduits(prods){
  document.getElementById('chargProduits').innerHTML=prods.map(p=>`
    <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:18px">${p.icone||'üì¶'}</span>
      <span style="flex:1;font-size:13px">${p.nom}</span>
      <input class="cqin" type="number" id="charg-${p.id}" placeholder="0" min="0" max="${p.quantite||0}" style="width:80px">
    </div>`).join('');
}

function openAddProduct(){document.getElementById('addProdModal').classList.add('open')}

async function saveNewProduct(){
  const nom=document.getElementById('newProdNom').value.trim();
  const icone=document.getElementById('newProdIcone').value.trim()||'üì¶';
  const unite=document.getElementById('newProdUnite').value.trim()||'unit√©s';
  const stock=parseInt(document.getElementById('newProdStock').value)||0;
  if(!nom){showToast('‚ö†Ô∏è Entrez le nom du produit',true);return}

  const prod={nom,icone,unite,quantite:stock,couleur:'#F97316'};
  if(useSb){
    const {data,error}=await sb.from('produits').insert(prod).select().single();
    if(error){showToast('‚ùå Erreur: '+error.message,true);return}
    if(stock>0) await sb.from('mouvements_stock').insert({produit_id:data.id,type:'entree',quantite:stock,note:'Stock initial'});
  } else {
    prod.id='p'+Date.now();
    lProduits.push(prod);
  }
  ['newProdNom','newProdIcone','newProdUnite','newProdStock'].forEach(id=>document.getElementById(id).value='');
  closeMod('addProdModal');
  await loadStock();
  showToast('Produit ajout√© ‚úì');
}

async function doApprov(){
  const pid=document.getElementById('approvProduit').value;
  const qty=parseInt(document.getElementById('approvQty').value);
  const note=document.getElementById('approvNote').value.trim();
  if(!pid||!qty||qty<=0){showToast('‚ö†Ô∏è S√©lectionnez un produit et une quantit√©',true);return}

  if(useSb){
    // Ajouter mouvement
    await sb.from('mouvements_stock').insert({produit_id:pid,type:'entree',quantite:qty,note});
    // Mettre √† jour stock
    const {data:prod}=await sb.from('produits').select('quantite').eq('id',pid).single();
    await sb.from('produits').update({quantite:(prod?.quantite||0)+qty}).eq('id',pid);
  } else {
    const p=lProduits.find(x=>x.id===pid);
    if(p){p.quantite+=qty;lStock.push({produit_id:pid,type:'entree',quantite:qty,note,date:new Date().toISOString()})}
  }
  document.getElementById('approvQty').value='';
  document.getElementById('approvNote').value='';
  await loadStock();
  showToast(`+${qty} unit√©s ajout√©es au stock ‚úì`);
}

async function doChargement(){
  const lid=document.getElementById('chargLivreur').value;
  if(!lid){showToast('‚ö†Ô∏è S√©lectionnez un livreur',true);return}

  const prods=useSb?(await sb.from('produits').select('*').then(r=>r.data||[])):lProduits;
  const today=new Date().toISOString().split('T')[0];
  let hasAny=false;

  for(const p of prods){
    const q=parseInt(document.getElementById('charg-'+p.id)?.value)||0;
    if(q<=0) continue;
    hasAny=true;
    if(useSb){
      await sb.from('chargements').insert({livreur_id:lid,produit_id:p.id,quantite_initiale:q,quantite_livree:0,date:today});
      await sb.from('produits').update({quantite:Math.max(0,(p.quantite||0)-q)}).eq('id',p.id);
    } else {
      const prod=lProduits.find(x=>x.id===p.id);
      if(prod) prod.quantite=Math.max(0,prod.quantite-q);
    }
  }
  if(!hasAny){showToast('‚ö†Ô∏è Entrez au moins une quantit√©',true);return}
  document.querySelectorAll('[id^="charg-"]').forEach(i=>i.value='');
  await loadStock();
  showToast('Chargement valid√© ‚úì');
}

// ============================================================
// CLIENTS
// ============================================================
async function loadAllClients(){
  let clients=lClients;
  if(useSb){
    const {data}=await sb.from('clients').select('*').order('nom');
    if(data) clients=data;
  } else {
    // Construire liste clients depuis livraisons
    const seen={};
    lLivraisons.forEach(l=>{
      if(l.client_nom&&!seen[l.client_phone||l.client_nom]){
        seen[l.client_phone||l.client_nom]=true;
        clients.push({id:l.client_phone||l.client_nom,nom:l.client_nom,telephone:l.client_phone,adresse:l.client_adresse});
      }
    });
  }
  document.getElementById('totalClients').textContent=clients.length;
  const c=document.getElementById('clientsList');
  if(!clients.length){c.innerHTML='<div class="empty"><div class="eico">üë•</div>Aucun client enregistr√©</div>';return}
  c.innerHTML=clients.map(cl=>`
    <div class="client-card ai" onclick="showClientModal('${cl.id}')">
      <div class="client-name">${cl.nom}</div>
      <div class="client-info">üìû ${cl.telephone||'‚Äî'}</div>
      <div class="client-info">üìç ${cl.adresse||'‚Äî'}</div>
      <div class="client-hist">Voir historique ‚Üí</div>
    </div>`).join('');
}

async function showClientModal(id){
  let cl, delivs=[];
  if(useSb){
    const {data}=await sb.from('clients').select('*').eq('id',id).single();
    cl=data;
    const {data:d}=await sb.from('livraisons').select('*').eq('client_id',id).order('created_at',{ascending:false}).limit(10);
    if(d) delivs=d;
  } else {
    cl=lClients.find(x=>x.id===id)||{nom:id,telephone:'',adresse:''};
    delivs=lLivraisons.filter(l=>l.client_phone===id||l.client_nom===id);
  }
  if(!cl) return;
  document.getElementById('cModName').textContent=cl.nom;
  document.getElementById('cModSub').textContent=`üìû ${cl.telephone||'‚Äî'} ¬∑ üìç ${cl.adresse||'‚Äî'}`;
  const totalMnt=delivs.reduce((s,d)=>s+(d.montant||0),0);
  document.getElementById('cModStats').innerHTML=`
    <div class="mst"><div class="msv" style="color:var(--accent)">${delivs.length}</div><div class="msl">Livraisons</div></div>
    <div class="mst"><div class="msv" style="color:var(--accent3)">${totalMnt.toLocaleString()}</div><div class="msl">DA total</div></div>`;
  document.getElementById('cModHistory').innerHTML=delivs.length?`
    <div style="font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">Historique</div>
    ${delivs.map(d=>`
      <div class="hcard" style="margin-bottom:8px">
        <div class="htim">${fmtTime(d.created_at||d.heure)} ¬∑ ${d.livreur||''}</div>
        <div class="hdet">üì¶ ${d.produits||''}</div>
        <div style="color:var(--accent3);font-weight:700;margin-top:6px">${(d.montant||0).toLocaleString()} DA</div>
      </div>`).join('')}`:'<div style="color:var(--muted);font-size:13px">Aucune livraison</div>';
  document.getElementById('clientModal').classList.add('open');
}

// ============================================================
// EXPORT
// ============================================================
function getPeriodDates(){
  const p=document.getElementById('exportPeriod').value;
  const now=new Date();
  let from,to=new Date();
  if(p==='month'){from=new Date(now.getFullYear(),now.getMonth(),1)}
  else if(p==='quarter'){const q=Math.floor(now.getMonth()/3);from=new Date(now.getFullYear(),q*3,1)}
  else if(p==='semester'){from=new Date(now.getFullYear(),now.getMonth()<6?0:6,1)}
  else if(p==='year'){from=new Date(now.getFullYear(),0,1)}
  else{from=new Date(document.getElementById('exportFrom').value);to=new Date(document.getElementById('exportTo').value)}
  return{from:from.toISOString(),to:to.toISOString()}
}

async function getExportData(){
  const{from,to}=getPeriodDates();
  let livraisons=[],clients=[],stock=[];

  if(useSb){
    const{data:l}=await sb.from('livraisons').select('*,livreurs(nom)').gte('created_at',from).lte('created_at',to).order('created_at',{ascending:false});
    livraisons=l||[];
    const{data:c}=await sb.from('clients').select('*');
    clients=c||[];
    const{data:s}=await sb.from('mouvements_stock').select('*,produits(nom)').gte('created_at',from).lte('created_at',to);
    stock=s||[];
  } else {
    livraisons=lLivraisons.filter(l=>new Date(l.created_at||'')>=new Date(from)&&new Date(l.created_at||'')<=new Date(to));
    clients=lClients;
    stock=lStock.filter(s=>new Date(s.date||'')>=new Date(from)&&new Date(s.date||'')<=new Date(to));
  }
  return{livraisons,clients,stock}
}

async function exportExcel(){
  showToast('Pr√©paration du fichier...');
  const{livraisons,clients,stock}=await getExportData();
  const wb=XLSX.utils.book_new();

  if(document.getElementById('expLivraisons').checked&&livraisons.length){
    const rows=livraisons.map(l=>({
      'Date':fmtTime(l.created_at||l.heure),
      'Livreur':l.livreurs?.nom||l.livreur||'',
      'Client':l.client_nom||l.client||'',
      'T√©l√©phone':l.client_phone||'',
      'Adresse':l.client_adresse||'',
      'Produits':l.produits||'',
      'Montant (DA)':l.montant||0,
      'Mode paiement':l.mode_paiement||'',
      'Latitude':l.lat||'',
      'Longitude':l.lng||'',
      'Notes':l.notes||'',
    }));
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(rows),'Livraisons');
  }

  if(document.getElementById('expClients').checked&&clients.length){
    const rows=clients.map(c=>({
      'Nom':c.nom||'',
      'T√©l√©phone':c.telephone||'',
      'Adresse':c.adresse||'',
    }));
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(rows),'Clients');
  }

  if(document.getElementById('expStock').checked&&stock.length){
    const rows=stock.map(s=>({
      'Date':fmtTime(s.created_at||s.date),
      'Produit':s.produits?.nom||s.produit||'',
      'Type':s.type||'',
      'Quantit√©':s.quantite||0,
      'Note':s.note||'',
    }));
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(rows),'Stock');
  }

  if(document.getElementById('expResume').checked&&livraisons.length){
    const resume={};
    livraisons.forEach(l=>{
      const n=l.livreurs?.nom||l.livreur||'Inconnu';
      if(!resume[n]) resume[n]={livreur:n,livraisons:0,montant:0};
      resume[n].livraisons++;
      resume[n].montant+=(l.montant||0);
    });
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(Object.values(resume)),'R√©sum√© livreurs');
  }

  if(!wb.SheetNames.length){showToast('‚ö†Ô∏è Aucune donn√©e √† exporter',true);return}

  const period=document.getElementById('exportPeriod').value;
  const labels={month:'mois',quarter:'trimestre',semester:'semestre',year:'annee',custom:'custom'};
  const filename=`DeliTrack_${labels[period]}_${new Date().toISOString().split('T')[0]}.xlsx`;
  XLSX.writeFile(wb,filename);
  showToast('Fichier Excel t√©l√©charg√© ‚úì');
}

async function exportCSV(){
  showToast('Pr√©paration CSV...');
  const{livraisons}=await getExportData();
  if(!livraisons.length){showToast('‚ö†Ô∏è Aucune donn√©e',true);return}
  const headers=['Date','Livreur','Client','T√©l√©phone','Montant DA','Mode paiement','Produits','Latitude','Longitude'];
  const rows=livraisons.map(l=>[
    fmtTime(l.created_at||l.heure),
    l.livreurs?.nom||l.livreur||'',
    l.client_nom||'',
    l.client_phone||'',
    l.montant||0,
    l.mode_paiement||'',
    l.produits||'',
    l.lat||'',
    l.lng||''
  ].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','));
  const csv=[headers.join(','),...rows].join('\n');
  const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`DeliTrack_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  showToast('CSV t√©l√©charg√© ‚úì');
}

function updateResumeStats(){
  const tl=lLivraisons.length;
  const tm=lLivraisons.reduce((s,l)=>s+(l.montant||0),0);
  document.getElementById('rL').textContent=tl;
  document.getElementById('rLiv').textContent=lLivreurs.length;
  document.getElementById('rM').textContent=tm>=1000?(tm/1000).toFixed(0)+'k':tm;
}

// ============================================================
// MODAL LIVREUR DETAIL
// ============================================================
async function showLivModal(id){
  let l=lLivreurs.find(x=>x.id===id);
  if(useSb){const{data}=await sb.from('livreurs').select('*').eq('id',id).single();if(data)l=data}
  if(!l) return;
  document.getElementById('modName').textContent=l.nom;
  document.getElementById('modSub').textContent=`üìç ${l.zone||''}`;
  document.getElementById('modStats').innerHTML=`
    <div class="mst"><div class="msv" style="color:var(--accent)">${l.livraisons||0}</div><div class="msl">Livraisons</div></div>
    <div class="mst"><div class="msv" style="color:var(--accent3)">${(l.montant||0).toLocaleString()}</div><div class="msl">DA</div></div>
    <div class="mst"><div class="msv" style="color:var(--accent2);font-size:13px">${Number(l.lat||0).toFixed(4)}</div><div class="msl">Latitude</div></div>
    <div class="mst"><div class="msv" style="color:var(--accent2);font-size:13px">${Number(l.lng||0).toFixed(4)}</div><div class="msl">Longitude</div></div>`;
  let d=lLivraisons.filter(x=>x.livreur_id===id||x.livreur===l.nom);
  if(useSb){const{data}=await sb.from('livraisons').select('*').eq('livreur_id',id).order('created_at',{ascending:false}).limit(5);if(data)d=data}
  document.getElementById('modDelivs').innerHTML=d.length?`
    <div style="font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">Derni√®res livraisons</div>
    ${d.map(x=>`<div class="hcard" style="margin-bottom:8px"><div class="hcli">${x.client_nom||x.client||''}</div><div class="htim">${fmtTime(x.created_at||x.heure)}</div><div style="color:var(--accent3);font-weight:700;margin-top:4px">${(x.montant||0).toLocaleString()} DA</div></div>`).join('')}`
    :'<div style="color:var(--muted);font-size:13px">Aucune livraison</div>';
  document.getElementById('livModal').classList.add('open');
}

// ============================================================
// REALTIME
// ============================================================
function subRealtime(){
  sb.channel('rt').on('postgres_changes',{event:'INSERT',schema:'public',table:'livraisons'},()=>{
    loadAllDeliveries();loadLivreurs();showToast('Nouvelle livraison üì¶');
  }).on('postgres_changes',{event:'UPDATE',schema:'public',table:'livreurs'},()=>{
    loadLivreurs();
  }).subscribe();
}

// ============================================================
// MAP LEAFLET
// ============================================================
let leafletMap = null;
let livMarkers = {};
let delivMarkers = [];

function initMap() {
  if (leafletMap) return;

  leafletMap = L.map('realMap', {
    center: [36.7538, 3.0588], // Alger
    zoom: 11,
    zoomControl: true,
    attributionControl: false,
  });

  // Tuiles OpenStreetMap dark style
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
  }).addTo(leafletMap);

  updateMapMarkers();

  // Mise √† jour toutes les 15 secondes si Supabase connect√©
  setInterval(async () => {
    if (useSb) {
      const {data} = await sb.from('livreurs').select('id,nom,initiales,couleur,statut,lat,lng,livraisons,montant,zone');
      if (data) { lLivreurs = data; updateMapMarkers(); }
    }
  }, 15000);
}

function updateMapMarkers() {
  if (!leafletMap) return;

  lLivreurs.forEach(l => {
    const lat = l.lat || 36.7538;
    const lng = l.lng || 3.0588;
    const col = l.couleur || '#F97316';
    const ini = l.initiales || l.nom?.substring(0,2).toUpperCase() || '?';
    const st = l.statut || 'actif';
    const isActive = st === 'actif' || st === 'active';

    const icon = L.divIcon({
      className: '',
      html: `<div class="livreur-marker ${isActive ? 'pulse' : ''}" style="background:${col};position:relative">${ini}</div>`,
      iconSize: [36, 36],
      iconAnchor: [18, 18],
      popupAnchor: [0, -22],
    });

    const popup = `
      <div class="popup-name" style="color:${col}">${l.nom}</div>
      <div class="popup-info">üìç ${l.zone || '‚Äî'}</div>
      <div class="popup-info">üì¶ ${l.livraisons || 0} livraisons ¬∑ ${(l.montant||0).toLocaleString()} DA</div>
      <div class="popup-info" style="margin-top:6px">
        <span style="background:${isActive?'rgba(16,185,129,0.15)':'rgba(100,116,139,0.15)'};color:${isActive?'#10B981':'#64748B'};padding:2px 8px;border-radius:20px;font-size:11px;font-weight:600">
          ${isActive ? 'üü¢ En route' : st === 'pause' ? 'üü° En pause' : '‚ö™ Termin√©'}
        </span>
      </div>`;

    if (livMarkers[l.id]) {
      livMarkers[l.id].setLatLng([lat, lng]).setIcon(icon).setPopupContent(popup);
    } else {
      livMarkers[l.id] = L.marker([lat, lng], {icon})
        .bindPopup(popup, {className: 'dark-popup', maxWidth: 220})
        .addTo(leafletMap);
    }
  });
}

function addDeliveryMarker(lat, lng, clientNom, montant) {
  if (!leafletMap) return;
  const icon = L.divIcon({
    className: '',
    html: `<div class="delivery-marker">‚úì</div>`,
    iconSize: [24, 24],
    iconAnchor: [12, 12],
  });
  const marker = L.marker([lat, lng], {icon})
    .bindPopup(`<div class="popup-name">${clientNom}</div><div class="popup-info" style="color:var(--accent3)">${montant.toLocaleString()} DA</div>`)
    .addTo(leafletMap);
  delivMarkers.push(marker);
}

// ============================================================
// LIVREUR INIT
// ============================================================
async function initL(){
  await loadCamion();
  renderProdCheck();
  await loadMyDeliveries();
  await loadMyClients();
  startGPS();
}

async function loadCamion(){
  camionProduits=[];
  if(useSb&&curLivreur?.id){
    const today=new Date().toISOString().split('T')[0];
    const{data}=await sb.from('chargements').select('*,produits(*)').eq('livreur_id',curLivreur.id).eq('date',today);
    if(data&&data.length){
      camionProduits=data.map(c=>({
        id:c.produit_id,nom:c.produits?.nom||'',icone:c.produits?.icone||'üì¶',
        quantite:c.quantite_initiale-(c.quantite_livree||0),unite:c.produits?.unite||'',couleur:c.produits?.couleur||'#F97316'
      }));
    }
  }
  if(!camionProduits.length) camionProduits=[...lProduits];
  document.getElementById('camionCount').textContent=camionProduits.length;
  const c=document.getElementById('camionList');
  if(!camionProduits.length){c.innerHTML='<div class="empty"><div class="eico">üöö</div>Aucun produit charg√© aujourd\'hui</div>';return}
  c.innerHTML=camionProduits.map(p=>`
    <div class="pitem ai">
      <div class="picon" style="background:${p.couleur||'#F97316'}22">${p.icone}</div>
      <div style="flex:1"><div class="pname">${p.nom}</div><div class="punit">${p.unite}</div></div>
      <div class="qbadge">${p.quantite}</div>
    </div>`).join('');
}

function renderProdCheck(){
  document.getElementById('prodCheck').innerHTML=camionProduits.map(p=>`
    <div class="pcitem" onclick="togProd('${p.id}',this)">
      <div class="cbox" id="cb-${p.id}"></div>
      <span class="cname">${p.icone} ${p.nom}</span>
      <input class="cqin" type="number" id="qi-${p.id}" placeholder="0" min="0" max="${p.quantite}" onclick="event.stopPropagation()" oninput="updQty('${p.id}',this.value)">
    </div>`).join('');
}

function togProd(id,el){
  const b=document.getElementById('cb-'+id);
  if(!b.classList.contains('ck')){b.classList.add('ck');b.innerHTML='‚úì';chkProds[id]=parseInt(document.getElementById('qi-'+id).value)||1;document.getElementById('qi-'+id).value=chkProds[id]}
  else{b.classList.remove('ck');b.innerHTML='';delete chkProds[id]}
}
function updQty(id,v){if(chkProds[id]!==undefined)chkProds[id]=parseInt(v)||0}

// ============================================================
// CLIENTS LIVREUR
// ============================================================
async function loadMyClients(){
  let clients=[];
  if(useSb&&curLivreur?.id){
    const{data}=await sb.from('clients').select('*').eq('livreur_id',curLivreur.id).order('nom');
    if(data) clients=data;
  } else {
    const seen={};
    lLivraisons.filter(l=>l.livreur_id===curLivreur?.id||l.livreur===curLivreur?.nom).forEach(l=>{
      if(l.client_nom&&!seen[l.client_nom]){seen[l.client_nom]=true;clients.push({id:l.client_phone||l.client_nom,nom:l.client_nom,telephone:l.client_phone||'',adresse:l.client_adresse||''})}
    });
  }
  document.getElementById('lClientCount').textContent=clients.length;
  const c=document.getElementById('lClientsList');
  if(!clients.length){c.innerHTML='<div class="empty"><div class="eico">üë•</div>Aucun client pour le moment</div>';return}
  c.innerHTML=clients.map(cl=>`
    <div class="client-card ai" onclick="fillClient('${cl.nom}','${cl.telephone}','${cl.adresse}')">
      <div class="client-name">${cl.nom}</div>
      <div class="client-info">üìû ${cl.telephone||'‚Äî'}</div>
      <div class="client-info">üìç ${cl.adresse||'‚Äî'}</div>
      <div class="client-hist">üì¶ Cr√©er livraison ‚Üí</div>
    </div>`).join('');
}

function fillClient(nom,tel,addr){
  document.getElementById('clientName').value=nom;
  document.getElementById('clientPhone').value=tel;
  document.getElementById('clientAddr').value=addr;
  lTab('livrer',null);
  document.querySelectorAll('#lApp .nitem').forEach((n,i)=>n.classList.toggle('active',i===1));
  showToast('Client s√©lectionn√© ‚úì');
}

// Recherche client dans le formulaire
async function searchClients(q){
  const sug=document.getElementById('clientSuggestions');
  if(!q||q.length<2){sug.style.display='none';return}
  let clients=[];
  if(useSb){
    const{data}=await sb.from('clients').select('*').ilike('nom','%'+q+'%').limit(5);
    if(data) clients=data;
  } else {
    clients=[...new Map(lLivraisons.filter(l=>l.client_nom?.toLowerCase().includes(q.toLowerCase())).map(l=>[l.client_nom,{nom:l.client_nom,telephone:l.client_phone||'',adresse:l.client_adresse||''}])).values()];
  }
  if(!clients.length){sug.style.display='none';return}
  sug.style.display='block';
  sug.innerHTML=clients.map(c=>`
    <div onclick="fillClient('${c.nom}','${c.telephone||''}','${c.adresse||''}')" style="padding:12px 14px;border-bottom:1px solid var(--border);cursor:pointer;font-size:13px">
      <strong>${c.nom}</strong><br><span style="color:var(--muted)">${c.telephone||''}</span>
    </div>`).join('');
}

// ============================================================
// GPS
// ============================================================
function startGPS(){
  if(!navigator.geolocation){document.getElementById('gpsStTxt').textContent='GPS non disponible';return}
  navigator.geolocation.getCurrentPosition(p=>updGPS(p.coords.latitude,p.coords.longitude));
  gpsWatchId=navigator.geolocation.watchPosition(p=>updGPS(p.coords.latitude,p.coords.longitude),null,{enableHighAccuracy:true,maximumAge:10000,timeout:30000});
}
function stopGPS(){if(gpsWatchId)navigator.geolocation.clearWatch(gpsWatchId)}
async function updGPS(lat,lng){
  gpsCoords={lat,lng};
  document.getElementById('gpsStTxt').textContent=`GPS actif ‚Äî ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
  if(useSb&&curLivreur?.id) await sb.from('livreurs').update({lat,lng,derniere_position:new Date().toISOString()}).eq('id',curLivreur.id);
}
function capGPS(){
  if(gpsCoords){document.getElementById('gpsDsp').textContent=`‚úÖ ${gpsCoords.lat.toFixed(6)}, ${gpsCoords.lng.toFixed(6)}`;showToast('Position captur√©e ‚úì')}
  else navigator.geolocation.getCurrentPosition(p=>{gpsCoords={lat:p.coords.latitude,lng:p.coords.longitude};document.getElementById('gpsDsp').textContent=`‚úÖ ${gpsCoords.lat.toFixed(6)}, ${gpsCoords.lng.toFixed(6)}`;showToast('Position captur√©e ‚úì')},()=>showToast('‚ö†Ô∏è Activez le GPS',true));
}

// ============================================================
// SOUMETTRE LIVRAISON
// ============================================================
async function submitLivraison(){
  const nom=document.getElementById('clientName').value.trim();
  const tel=document.getElementById('clientPhone').value.trim();
  const addr=document.getElementById('clientAddr').value.trim();
  const mnt=document.getElementById('montant').value;
  const mode=document.getElementById('modePay').value;
  const notes=document.getElementById('notesLiv').value.trim();

  if(!nom||!tel||!mnt){showToast('‚ö†Ô∏è Nom, t√©l√©phone et montant requis',true);return}
  if(!gpsCoords){showToast('‚ö†Ô∏è Capturez votre position GPS',true);return}
  if(!Object.keys(chkProds).length){showToast('‚ö†Ô∏è S√©lectionnez au moins un produit',true);return}
  if(!mode){showToast('‚ö†Ô∏è Choisissez le mode de paiement',true);return}

  const btn=document.getElementById('submitBtn');
  btn.disabled=true;btn.textContent='‚è≥ Envoi...';

  const detail=Object.keys(chkProds).map(id=>{const p=camionProduits.find(x=>x.id===id);return{id,nom:p?.nom||id,quantite:chkProds[id]}});
  const prodsTxt=detail.map(p=>`${p.nom} x${p.quantite}`).join(', ');

  const liv={
    livreur_id:curLivreur?.id||'demo',livreur:curLivreur?.nom||'',
    client_nom:nom,client_phone:tel,client_adresse:addr,
    montant:parseInt(mnt),mode_paiement:mode,
    produits:prodsTxt,produits_detail:JSON.stringify(detail),
    lat:gpsCoords.lat,lng:gpsCoords.lng,notes,
    heure:new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}),
    created_at:new Date().toISOString(),
  };

  if(useSb){
    // Enregistrer ou mettre √† jour le client
    await sb.from('clients').upsert({nom,telephone:tel,adresse:addr,livreur_id:curLivreur?.id},{onConflict:'telephone',ignoreDuplicates:false});
    const{error}=await sb.from('livraisons').insert(liv);
    if(error){showToast('‚ùå '+error.message,true);btn.disabled=false;btn.textContent='‚úÖ Valider la livraison';return}
  } else {
    lLivraisons.unshift(liv);
    // Ajouter client si nouveau
    if(!lClients.find(c=>c.telephone===tel)) lClients.push({id:tel,nom,telephone:tel,adresse:addr});
  }

  // D√©duire stock local
  Object.keys(chkProds).forEach(id=>{const p=camionProduits.find(x=>x.id===id);if(p)p.quantite=Math.max(0,p.quantite-(chkProds[id]||0))});

  // Reset
  ['clientName','clientPhone','clientAddr','montant','notesLiv','clientSearch'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('modePay').value='';
  document.getElementById('gpsDsp').textContent='Position non captur√©e';
  document.getElementById('clientSuggestions').style.display='none';
  gpsCoords=null;chkProds={};
  renderProdCheck();
  await loadCamion();
  await loadMyDeliveries();
  await loadMyClients();
  btn.disabled=false;btn.textContent='‚úÖ Valider la livraison';
  showToast('Livraison enregistr√©e ‚úì');
  // Ajouter marqueur sur la carte fournisseur
  addDeliveryMarker(liv.lat, liv.lng, nom, parseInt(mnt));
  lTab('historique',null);
  document.querySelectorAll('#lApp .nitem').forEach((n,i)=>n.classList.toggle('active',i===3));
}

async function loadMyDeliveries(){
  let d=lLivraisons.filter(x=>x.livreur_id===curLivreur?.id||x.livreur===curLivreur?.nom);
  if(useSb&&curLivreur?.id){
    const today=new Date().toISOString().split('T')[0];
    const{data}=await sb.from('livraisons').select('*').eq('livreur_id',curLivreur.id).gte('created_at',today).order('created_at',{ascending:false});
    if(data) d=data;
  }
  document.getElementById('myCount').textContent=d.length;
  const c=document.getElementById('myDelivs');
  if(!d.length){c.innerHTML='<div class="empty"><div class="eico">üìã</div>Aucune livraison pour le moment</div>';return}
  c.innerHTML=d.map(x=>`
    <div class="hcard ai">
      <div style="position:absolute;right:14px;top:50%;transform:translateY(-50%);width:26px;height:26px;background:rgba(16,185,129,0.15);color:var(--accent3);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700">‚úì</div>
      <div class="hcli">${x.client_nom||x.client||''}</div>
      <div class="htim">üìû ${x.client_phone||''} ¬∑ ${fmtTime(x.created_at||x.heure)}</div>
      <div class="hdet">üì¶ ${x.produits||''}</div>
      <div class="hdet">üìç ${Number(x.lat||0).toFixed(5)}, ${Number(x.lng||0).toFixed(5)}</div>
      <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:12px;color:var(--muted)">${x.mode_paiement||x.mode||''}</span>
        <span style="color:var(--accent3);font-weight:700;font-size:15px">${(x.montant||0).toLocaleString()} DA</span>
      </div>
    </div>`).join('');
}

// ============================================================
// TABS & UTILS
// ============================================================
// ============================================================
// GESTION √âQUIPE (LIVREURS)
// ============================================================
let deleteLivreurId = null;

async function loadEquipe() {
  let livs = lLivreurs;
  if (useSb) {
    const {data} = await sb.from('livreurs').select('*').order('nom');
    if (data) livs = data;
  }
  const c = document.getElementById('equipeList');
  if (!livs.length) {
    c.innerHTML = '<div class="empty"><div class="eico">üë•</div>Aucun livreur</div>';
    return;
  }
  c.innerHTML = livs.map(l => {
    const col = l.couleur || '#F97316';
    const ini = l.initiales || l.nom?.substring(0,2).toUpperCase() || '??';
    const st = l.statut || 'actif';
    return `
    <div class="lcard ai" style="cursor:default">
      <div class="lhdr">
        <div class="avatar" style="background:${col}22;color:${col}">${ini}</div>
        <div class="linfo">
          <div class="lname">${l.nom}</div>
          <div class="lzone">üìç ${l.zone||'‚Äî'} ¬∑ üîë ${l.identifiant||'‚Äî'}</div>
        </div>
        <span class="spill ${st==='actif'?'pa':st==='pause'?'pp':'pd'}">${st==='actif'?'Actif':st==='pause'?'Pause':'Inactif'}</span>
      </div>
      <div style="display:flex;gap:8px;margin-top:4px">
        <button onclick="openEditLivreur('${l.id}')" style="flex:1;padding:10px;background:rgba(59,130,246,0.1);border:1.5px solid rgba(59,130,246,0.3);border-radius:10px;color:var(--accent2);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer">‚úèÔ∏è Modifier</button>
        <button onclick="openDeleteLivreur('${l.id}','${l.nom}')" style="flex:1;padding:10px;background:rgba(239,68,68,0.1);border:1.5px solid rgba(239,68,68,0.3);border-radius:10px;color:var(--danger);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer">üóëÔ∏è Supprimer</button>
        <select onchange="changeStatut('${l.id}',this.value)" style="flex:1;padding:10px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:12px;outline:none">
          <option value="actif" ${st==='actif'?'selected':''}>üü¢ Actif</option>
          <option value="pause" ${st==='pause'?'selected':''}>üü° Pause</option>
          <option value="termine" ${st==='termine'?'selected':''}>‚ö™ Inactif</option>
        </select>
      </div>
    </div>`;
  }).join('');
}

function openAddLivreur() {
  document.getElementById('addLivTitle').textContent = '‚ûï Nouveau livreur';
  document.getElementById('editLivId').value = '';
  document.getElementById('livNom').value = '';
  document.getElementById('livInitiales').value = '';
  document.getElementById('livZone').value = '';
  document.getElementById('livIdentifiant').value = '';
  document.getElementById('livPassword').value = '';
  document.getElementById('livCouleur').value = '#F97316';
  document.querySelectorAll('.color-opt').forEach(o => o.style.border = o.dataset.color === '#F97316' ? '3px solid white' : '3px solid transparent');
  document.getElementById('addLivModal').classList.add('open');
}

async function openEditLivreur(id) {
  let l = lLivreurs.find(x => x.id === id);
  if (useSb) {
    const {data} = await sb.from('livreurs').select('*').eq('id', id).single();
    if (data) l = data;
  }
  if (!l) return;
  document.getElementById('addLivTitle').textContent = '‚úèÔ∏è Modifier le livreur';
  document.getElementById('editLivId').value = l.id;
  document.getElementById('livNom').value = l.nom || '';
  document.getElementById('livInitiales').value = l.initiales || '';
  document.getElementById('livZone').value = l.zone || '';
  document.getElementById('livIdentifiant').value = l.identifiant || '';
  document.getElementById('livPassword').value = l.mot_de_passe || '';
  document.getElementById('livCouleur').value = l.couleur || '#F97316';
  document.querySelectorAll('.color-opt').forEach(o => o.style.border = o.dataset.color === (l.couleur||'#F97316') ? '3px solid white' : '3px solid transparent');
  document.getElementById('addLivModal').classList.add('open');
}

function selColor(el) {
  document.querySelectorAll('.color-opt').forEach(o => o.style.border = '3px solid transparent');
  el.style.border = '3px solid white';
  document.getElementById('livCouleur').value = el.dataset.color;
}

async function saveLivreur() {
  const nom = document.getElementById('livNom').value.trim();
  const initiales = document.getElementById('livInitiales').value.trim().toUpperCase();
  const zone = document.getElementById('livZone').value.trim();
  const identifiant = document.getElementById('livIdentifiant').value.trim();
  const password = document.getElementById('livPassword').value.trim();
  const couleur = document.getElementById('livCouleur').value;
  const editId = document.getElementById('editLivId').value;

  if (!nom || !identifiant || !password) {
    showToast('‚ö†Ô∏è Nom, identifiant et mot de passe requis', true);
    return;
  }

  const data = {nom, initiales: initiales || nom.substring(0,2).toUpperCase(), zone, identifiant, mot_de_passe: password, couleur, statut: 'actif'};

  if (useSb) {
    if (editId) {
      const {error} = await sb.from('livreurs').update(data).eq('id', editId);
      if (error) { showToast('‚ùå ' + error.message, true); return; }
    } else {
      const {error} = await sb.from('livreurs').insert(data);
      if (error) { showToast('‚ùå ' + (error.message.includes('unique') ? 'Identifiant d√©j√† utilis√©' : error.message), true); return; }
    }
  } else {
    if (editId) {
      const l = lLivreurs.find(x => x.id === editId);
      if (l) Object.assign(l, data);
    } else {
      lLivreurs.push({id: 'l' + Date.now(), ...data, livraisons: 0, montant: 0, lat: 36.7538, lng: 3.0588});
    }
  }

  closeMod('addLivModal');
  await loadLivreurs();
  await loadEquipe();
  showToast(editId ? 'Livreur modifi√© ‚úì' : 'Livreur ajout√© ‚úì');
}

function openDeleteLivreur(id, nom) {
  deleteLivreurId = id;
  document.getElementById('delLivNom').textContent = `Vous allez supprimer : ${nom}`;
  document.getElementById('delLivModal').classList.add('open');
}

async function confirmDeleteLivreur() {
  if (!deleteLivreurId) return;
  if (useSb) {
    const {error} = await sb.from('livreurs').delete().eq('id', deleteLivreurId);
    if (error) { showToast('‚ùå ' + error.message, true); return; }
  } else {
    lLivreurs = lLivreurs.filter(l => l.id !== deleteLivreurId);
  }
  closeMod('delLivModal');
  deleteLivreurId = null;
  await loadLivreurs();
  await loadEquipe();
  showToast('Livreur supprim√© ‚úì');
}

async function changeStatut(id, statut) {
  if (useSb) {
    await sb.from('livreurs').update({statut}).eq('id', id);
  } else {
    const l = lLivreurs.find(x => x.id === id);
    if (l) l.statut = statut;
  }
  await loadLivreurs();
  showToast('Statut mis √† jour ‚úì');
}

function fTab(n,el){
  document.querySelectorAll('#fApp .tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#fApp .tc').forEach(t=>t.classList.remove('active'));
  if(el)el.classList.add('active');
  document.getElementById('tf-'+n).classList.add('active');
  if(n==='equipe') loadEquipe();
}
function lTab(n,el){
  document.querySelectorAll('#lApp .tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#lApp .tc').forEach(t=>t.classList.remove('active'));
  if(el)el.classList.add('active');
  document.getElementById('lt-'+n).classList.add('active');
}
function navAct(el){document.querySelectorAll('#lApp .nitem').forEach(n=>n.classList.remove('active'));el.classList.add('active')}
function closeMod(id){document.getElementById(id).classList.remove('open')}
function fmtTime(v){if(!v)return '';if(String(v).includes('T'))return new Date(v).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});return v}
function showToast(msg,err=false){const t=document.getElementById('toast');t.textContent=msg;t.style.background=err?'var(--danger)':'var(--accent3)';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
</script>
</body>
</html>
