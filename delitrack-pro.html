<!DOCTYPE html>
<html lang="fr" data-theme="dark" id="htmlRoot">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0A0E1A" id="metaThemeColor">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>DeliTrack ‚Äî Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.js"></script>
<!-- SheetJS pour export Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
/* ‚îÄ‚îÄ TH√àME SOMBRE (d√©faut) ‚îÄ‚îÄ */
:root, [data-theme="dark"] {
  --bg:#0A0E1A; --surface:#111827; --card:#1A2236; --border:#1E2D45;
  --accent:#F97316; --accent2:#3B82F6; --accent3:#10B981;
  --text:#F1F5F9; --muted:#64748B; --danger:#EF4444; --yellow:#F59E0B;
  --shadow:rgba(0,0,0,0.4);
  --map-bg:#0D1520;
  --ltopbar-from:#1A2236; --ltopbar-to:#111827;
  --input-bg:var(--card);
}

/* ‚îÄ‚îÄ TH√àME CLAIR ‚îÄ‚îÄ */
[data-theme="light"] {
  --bg:#F1F5F9; --surface:#FFFFFF; --card:#FFFFFF; --border:#E2E8F0;
  --accent:#F97316; --accent2:#2563EB; --accent3:#059669;
  --text:#0F172A; --muted:#64748B; --danger:#DC2626; --yellow:#D97706;
  --shadow:rgba(0,0,0,0.1);
  --map-bg:#E8EFF5;
  --ltopbar-from:#1E3A5F; --ltopbar-to:#1E3A5F;
  --input-bg:#F8FAFC;
}

/* Transitions douces au changement de th√®me */
*, *::before, *::after {
  transition: background-color 0.25s ease, border-color 0.25s ease, color 0.15s ease;
}
/* Exclure les transitions sur les animations/transforms */
.livreur-marker, .live-dot, .btn-p, .sbtn, .tab, .lcard { transition: none; }
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
.screen{display:none;min-height:100vh;flex-direction:column}
.screen.active{display:flex}

/* CONFIG BANNER */
#configBanner{background:linear-gradient(135deg,#F97316,#EA580C);color:white;padding:14px 20px;font-size:13px;font-weight:600;text-align:center;cursor:pointer;display:none}
#configBanner.show{display:block}

/* LOGIN */
#login{background:var(--bg);align-items:center;justify-content:center;padding:32px 24px;position:relative;overflow:hidden}
.orb{position:absolute;border-radius:50%;filter:blur(80px);pointer-events:none}
.orb1{width:300px;height:300px;background:rgba(249,115,22,0.15);top:-100px;right:-80px}
.orb2{width:250px;height:250px;background:rgba(59,130,246,0.12);bottom:50px;left:-80px}
.login-logo{font-family:'Syne',sans-serif;font-size:36px;font-weight:800;letter-spacing:-1px;margin-bottom:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-sub{color:var(--muted);font-size:14px;margin-bottom:40px;letter-spacing:1px;text-transform:uppercase}
.role-selector{display:flex;gap:12px;margin-bottom:28px;width:100%;max-width:360px}
.role-btn{flex:1;padding:16px 8px;border-radius:16px;border:2px solid var(--border);background:var(--card);color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s;text-align:center}
.role-btn.selected{border-color:var(--accent);background:rgba(249,115,22,0.1);color:var(--accent)}
.role-icon{font-size:24px;display:block;margin-bottom:6px}
.fg{width:100%;max-width:360px;margin-bottom:14px}
.fl{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px;display:block}
.fi{width:100%;padding:14px 16px;background:var(--input-bg);border:1.5px solid var(--border);border-radius:12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;outline:none;transition:border-color 0.2s}
.fi:focus{border-color:var(--accent)}
.btn-p{width:100%;max-width:360px;padding:16px;background:linear-gradient(135deg,var(--accent),#EA580C);border:none;border-radius:14px;color:white;font-family:'Syne',sans-serif;font-size:16px;font-weight:700;cursor:pointer;letter-spacing:0.5px;transition:opacity 0.2s,transform 0.1s;margin-top:8px}
.btn-p:active{transform:scale(0.98);opacity:0.9}
.login-err{color:var(--danger);font-size:13px;text-align:center;margin-top:10px;max-width:360px;display:none}

/* TOPBAR */
.topbar{background:var(--surface);padding:14px 18px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.topbar-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:700}
.tbadge{background:var(--accent);color:white;font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px;text-transform:uppercase}
.live-dot{display:inline-block;width:8px;height:8px;background:var(--accent3);border-radius:50%;margin-right:5px;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(0.85)}}

/* MAP */
.map-box{background:var(--map-bg);position:relative;height:300px;flex-shrink:0;overflow:hidden}
#realMap{position:absolute;top:0;left:0;width:100%;height:100%}
.leaflet-container{background:var(--map-bg)!important;width:100%!important;height:100%!important}
.leaflet-tile{filter:brightness(0.85) saturate(0.9)!important}
[data-theme="light"] .leaflet-tile{filter:none!important}
[data-theme="light"] .leaflet-container{background:#e8f0f5!important}
[data-theme="light"] .hcard{box-shadow:0 1px 4px rgba(0,0,0,0.08)}
[data-theme="light"] .lcard{box-shadow:0 1px 4px rgba(0,0,0,0.06)}
[data-theme="light"] .fsec{box-shadow:0 1px 4px rgba(0,0,0,0.06)}
[data-theme="light"] .modal{box-shadow:0 -4px 24px rgba(0,0,0,0.12)}
[data-theme="light"] .leaflet-popup-content-wrapper{box-shadow:0 4px 16px rgba(0,0,0,0.15)!important}
.leaflet-control-zoom a{background:var(--card)!important;color:var(--text)!important;border-color:var(--border)!important}
.livreur-marker{
  width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-family:'Syne',sans-serif;font-weight:800;font-size:13px;color:white;
  border:3px solid white;box-shadow:0 2px 12px rgba(0,0,0,0.4);cursor:pointer;
  transition:transform 0.2s;
}
.livreur-marker:hover{transform:scale(1.15)}
.livreur-marker.pulse::after{
  content:'';position:absolute;width:48px;height:48px;border-radius:50%;
  border:2px solid currentColor;animation:ripple 1.5s infinite;top:-9px;left:-9px;
}
@keyframes ripple{0%{opacity:0.8;transform:scale(0.8)}100%{opacity:0;transform:scale(1.6)}}
.delivery-marker{
  width:24px;height:24px;border-radius:50%;background:var(--accent3);
  border:2px solid white;box-shadow:0 1px 6px rgba(0,0,0,0.3);
  display:flex;align-items:center;justify-content:center;font-size:11px;
}
.leaflet-popup-content-wrapper{background:var(--card)!important;border:1px solid var(--border)!important;border-radius:14px!important;color:var(--text)!important;box-shadow:0 8px 24px rgba(0,0,0,0.4)!important}
.leaflet-popup-tip{background:var(--card)!important}
.popup-name{font-family:'Syne',sans-serif;font-weight:700;font-size:14px;margin-bottom:4px}
.popup-info{font-size:12px;color:var(--muted);margin-bottom:2px}
.map-badge{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:10px;padding:7px 12px;font-size:12px}

/* CONTENT */
.content{flex:1;overflow-y:auto;padding:18px;padding-bottom:90px}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}
.scard{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 10px;text-align:center}
.sval{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;line-height:1;margin-bottom:4px}
.slbl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}

/* SECTION TITLE */
.sec-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
.bcnt{background:var(--border);color:var(--text);font-size:11px;padding:2px 8px;border-radius:20px}

/* LIVREUR CARD */
.lcard{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:10px;cursor:pointer;transition:border-color 0.2s,transform 0.1s;position:relative;overflow:hidden}
.lcard::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:3px 0 0 3px}
.lcard.sa::before{background:var(--accent3)}
.lcard.sp::before{background:var(--yellow)}
.lcard.sd::before{background:var(--muted)}
.lcard:active{transform:scale(0.99)}
.lhdr{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.avatar{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:17px;font-weight:800;flex-shrink:0}
.linfo{flex:1}
.lname{font-weight:600;font-size:14px;margin-bottom:2px}
.lzone{font-size:12px;color:var(--muted)}
.spill{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:4px 10px;border-radius:20px}
.pa{background:rgba(16,185,129,0.15);color:var(--accent3)}
.pp{background:rgba(245,158,11,0.15);color:var(--yellow)}
.pd{background:rgba(100,116,139,0.15);color:var(--muted)}
.lstats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.mstat{background:rgba(255,255,255,0.03);border-radius:10px;padding:8px;text-align:center}
.msv{font-family:'Syne',sans-serif;font-size:14px;font-weight:700}
.msl{font-size:10px;color:var(--muted);margin-top:2px}

/* BOTTOM NAV */
.bnav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);display:flex;padding:8px 0 18px;z-index:200}
.nitem{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 4px;cursor:pointer;transition:color 0.2s;color:var(--muted);font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:0.5px}
.nitem.active{color:var(--accent)}
.nico{font-size:20px}

/* LIVREUR TOPBAR */
.ltopbar{background:linear-gradient(135deg,var(--ltopbar-from),var(--ltopbar-to));padding:18px 18px 22px;border-bottom:1px solid var(--border)}
.greeting{font-size:13px;color:var(--muted);margin-bottom:4px}
.lbigname{font-family:'Syne',sans-serif;font-size:22px;font-weight:800}
.gps-st{display:flex;align-items:center;gap:8px;margin-top:10px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.2);border-radius:10px;padding:8px 12px;font-size:12px;color:var(--accent3);font-weight:500}

/* PRODUCT ITEM */
.pitem{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px 14px;margin-bottom:10px;display:flex;align-items:center;gap:12px}
.picon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.pname{font-weight:500;font-size:14px;margin-bottom:2px}
.punit{font-size:12px;color:var(--muted)}
.qbadge{margin-left:auto;background:rgba(249,115,22,0.15);color:var(--accent);font-family:'Syne',sans-serif;font-size:17px;font-weight:800;padding:5px 13px;border-radius:10px;flex-shrink:0}

/* FORM SECTION */
.fsec{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:14px}
.fstitle{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--accent);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.di{width:100%;padding:12px 14px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color 0.2s;margin-bottom:10px}
.di:focus{border-color:var(--accent2)}
.di:last-child{margin-bottom:0}
.di::placeholder{color:var(--muted)}
.psel{background:var(--surface);border:1.5px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:10px}
.pcitem{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s}
.pcitem:last-child{border-bottom:none}
.cbox{width:20px;height:20px;border-radius:6px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;font-size:11px}
.cbox.ck{background:var(--accent);border-color:var(--accent)}
.cname{flex:1;font-size:14px}
.cqin{width:70px;padding:6px 10px;background:var(--card);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;text-align:center;outline:none}
.gps-btn{width:100%;padding:12px;background:rgba(59,130,246,0.1);border:1.5px solid rgba(59,130,246,0.3);border-radius:10px;color:var(--accent2);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:10px;transition:background 0.2s}
.gps-coords{font-size:11px;color:var(--accent3);text-align:center;margin-bottom:10px;font-weight:500}
.sbtn{width:100%;padding:15px;background:linear-gradient(135deg,var(--accent3),#059669);border:none;border-radius:14px;color:white;font-family:'Syne',sans-serif;font-size:16px;font-weight:700;cursor:pointer;transition:opacity 0.2s,transform 0.1s;letter-spacing:0.5px}
.sbtn:active{transform:scale(0.98)}
.sbtn:disabled{opacity:0.5;cursor:not-allowed}

/* TABS */
.tabs{display:flex;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:57px;z-index:90;overflow-x:auto}
.tab{flex-shrink:0;padding:13px 14px;text-align:center;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tc{display:none}
.tc.active{display:block}

/* HIST CARD */
.hcard{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px;position:relative}
.hcli{font-weight:600;font-size:14px;margin-bottom:3px}
.htim{font-size:11px;color:var(--muted);margin-bottom:6px}
.hdet{font-size:12px;color:var(--muted);margin-bottom:2px}

/* MODAL */
.mover{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:500;align-items:flex-end}
.mover.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:24px 24px 0 0;padding:22px 18px 36px;width:100%;max-height:92vh;overflow-y:auto;animation:slideUp 0.3s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mhandle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 18px}
.mtitle{font-family:'Syne',sans-serif;font-size:19px;font-weight:700;margin-bottom:4px}
.msub{font-size:13px;color:var(--muted);margin-bottom:18px}
.msg{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px}
.mst{background:var(--card);border-radius:12px;padding:13px}
.msv{font-family:'Syne',sans-serif;font-size:19px;font-weight:800;margin-bottom:3px}
.msl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
.cbtn{width:100%;padding:13px;background:var(--card);border:1.5px solid var(--border);border-radius:12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;cursor:pointer;margin-top:10px}

/* ADD BTN */
.add-btn{background:rgba(249,115,22,0.15);border:1.5px solid rgba(249,115,22,0.3);color:var(--accent);padding:6px 14px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:background 0.2s}
.add-btn:active{background:rgba(249,115,22,0.25)}

/* CLIENT CARD */
.client-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px;cursor:pointer;transition:border-color 0.2s}
.client-card:active{border-color:var(--accent)}
.client-name{font-weight:600;font-size:15px;margin-bottom:3px}
.client-info{font-size:12px;color:var(--muted);margin-bottom:2px}
.client-hist{font-size:12px;color:var(--accent3);font-weight:500;margin-top:6px}

/* EXPORT SECTION */
.exp-btn{width:100%;padding:13px;border:none;border-radius:12px;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:8px;transition:opacity 0.2s}
.exp-btn:active{opacity:0.8}

/* STOCK INLINE */
.stock-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)}
.stock-row:last-child{border-bottom:none}
.stock-bar{flex:1;height:6px;background:var(--border);border-radius:3px;margin:0 12px;overflow:hidden}
.stock-fill{height:100%;border-radius:3px;transition:width 0.4s}

/* TRAJET MAP */
#trajetMap{width:100%;height:320px;border-radius:12px;margin-bottom:14px;display:block;flex-shrink:0}
.trajet-legend{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px;font-size:12px}
.tleg-item{display:flex;align-items:center;gap:6px;font-weight:500}
.tleg-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.trajet-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px}
.trajet-date-sel{display:flex;gap:8px;align-items:center;margin-bottom:14px;flex-wrap:wrap}

/* LOADING OVERLAY */
.lscreen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity 0.4s}
.lscreen.hide{opacity:0;pointer-events:none}
.spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:14px}
@keyframes spin{to{transform:rotate(360deg)}}

/* TOAST */
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-80px);background:var(--accent3);color:white;padding:12px 22px;border-radius:30px;font-weight:600;font-size:14px;z-index:9999;transition:transform 0.35s cubic-bezier(0.34,1.56,0.64,1);white-space:nowrap;max-width:90vw;text-align:center}
.toast.show{transform:translateX(-50%) translateY(0)}

/* EMPTY */
.empty{text-align:center;padding:36px 20px;color:var(--muted);font-size:14px}
.eico{font-size:38px;margin-bottom:10px}

@keyframes fadeInUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.ai{animation:fadeInUp 0.35s ease forwards}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

/* ‚îÄ‚îÄ BILINGUE FR / AR ‚îÄ‚îÄ */
[lang="ar"] { direction: rtl; }
.lang-ar { display: none; }
.lang-fr { display: inline; }
html[lang="ar"] .lang-ar { display: inline; }
html[lang="ar"] .lang-fr { display: none; }
html[lang="ar"] .lang-ar-block { display: block; }
html[lang="ar"] .lang-fr-block { display: none; }
.lang-ar-block { display: none; }
.lang-fr-block { display: block; }

/* Switch bouton */
.lang-switch {
  display: flex;
  align-items: center;
  gap: 4px;
  background: var(--card);
  border: 1.5px solid var(--border);
  border-radius: 20px;
  padding: 3px 6px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 700;
  user-select: none;
}
.lang-switch .ls-opt {
  padding: 3px 8px;
  border-radius: 14px;
  transition: background 0.2s, color 0.2s;
  color: var(--muted);
}
.lang-switch .ls-opt.active {
  background: var(--accent);
  color: white;
}
html[lang="ar"] {
  font-family: 'Cairo', 'DM Sans', sans-serif;
}
html[lang="ar"] .tabs,
html[lang="ar"] .lnav,
html[lang="ar"] .topbar {
  direction: rtl;
}
html[lang="ar"] .tab,
html[lang="ar"] .nitem {
  letter-spacing: 0;
}


/* ‚îÄ‚îÄ IMAGE PRODUIT ‚îÄ‚îÄ */
.prod-img-upload {
  width: 100%;
  aspect-ratio: 4/3;
  border: 2px dashed var(--border);
  border-radius: 14px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  overflow: hidden;
  margin-bottom: 12px;
  position: relative;
  background: var(--surface);
}
.prod-img-upload:hover { border-color: var(--accent); background: rgba(249,115,22,0.04); }
.prod-img-upload img  { width:100%; height:100%; object-fit:cover; border-radius:12px; }
.prod-img-placeholder { display:flex;flex-direction:column;align-items:center;gap:8px;color:var(--muted);font-size:13px }
.prod-img-placeholder span { font-size:36px; }
.prod-img-badge {
  position:absolute;bottom:8px;right:8px;
  background:var(--accent);color:white;
  border-radius:20px;padding:4px 10px;
  font-size:11px;font-weight:700;
}

/* Catalogue commer√ßant avec image */
.c-prod-img {
  width: 72px;
  height: 72px;
  border-radius: 12px;
  object-fit: cover;
  flex-shrink: 0;
  background: rgba(249,115,22,0.08);
}
.c-prod-icon {
  width: 72px;
  height: 72px;
  background: rgba(249,115,22,0.08);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 30px;
  flex-shrink: 0;
}
.cond-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 10px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 20px;
  background: rgba(59,130,246,0.1);
  color: var(--accent2);
  border: 1px solid rgba(59,130,246,0.2);
  margin-top: 3px;
}

/* Stock list avec image */
.prod-thumb {
  width: 44px;
  height: 44px;
  border-radius: 10px;
  object-fit: cover;
  flex-shrink: 0;
}
.prod-thumb-icon {
  width: 44px;
  height: 44px;
  border-radius: 10px;
  background: rgba(249,115,22,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  flex-shrink: 0;
}

</style>
<script>
  (function() {
    // On lit la langue sauvegard√©e AVANT de dessiner la page
    var savedLang = localStorage.getItem('deliLang') || 'fr';
    document.documentElement.lang = savedLang;
    document.documentElement.dir = savedLang === 'ar' ? 'rtl' : 'ltr';
  })();
</script>
</head>
<body>

<!-- LOADING -->
<div class="lscreen" id="loadingScreen">
  <div style="font-family:'Syne',sans-serif;font-size:28px;font-weight:800;background:linear-gradient(135deg,#F97316,#3B82F6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:22px">DeliTrack</div>
  <div class="spinner"></div>
  <div style="font-family:'Syne',sans-serif;font-size:13px;color:var(--muted)" id="loadTxt">Initialisation...</div>
</div>

<!-- CONFIG BANNER -->
<div id="configBanner" class="show" onclick="showCfg()">‚öôÔ∏è Configurer Supabase pour activer la synchronisation en temps r√©el ‚Üí</div>

<!-- ======== LOGIN ======== -->
<div id="login" class="screen active">
  <div class="orb orb1"></div><div class="orb orb2"></div>
  <!-- Bouton th√®me sur login -->
    <div style="position:absolute;top:16px;right:16px;display:flex;gap:8px;align-items:center;z-index:10">
    <button onclick="toggleLang()" id="langBtn" style="background:var(--card);border:1.5px solid var(--border);border-radius:10px;padding:7px 14px;font-size:14px;font-weight:800;cursor:pointer;color:var(--text);transition:all 0.2s;display:flex;align-items:center;gap:6px" title="ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÑÿ∫ÿ© / Changer la langue"><span id="langBtnFlag">üá©üáø</span><span id="langBtnTxt">ÿπÿ±</span></button>
    <button class="theme-toggle-btn" onclick="toggleTheme()" style="background:var(--card);border:1.5px solid var(--border);border-radius:10px;padding:7px 12px;font-size:16px;cursor:pointer" title="Changer le th√®me">‚òÄÔ∏è</button>
  </div>
  <button class="theme-toggle-btn" onclick="toggleTheme()" style="position:absolute;top:16px;right:16px;display:none;background:var(--card);border:1.5px solid var(--border);border-radius:10px;padding:8px 12px;font-size:16px;cursor:pointer;z-index:10" title="Changer le th√®me">‚òÄÔ∏è</button>
  <div class="login-logo" id="loginLogo" onclick="adminTap()">DeliTrack</div>
  <div class="login-sub">Gestion livraison en temps r√©el</div>
  <div class="role-selector" style="flex-wrap:wrap;gap:10px">
    <div class="role-btn selected" id="roleF" onclick="selRole('fournisseur',this)">
      <span class="role-icon">üè≠</span>Fournisseur
    </div>
    <div class="role-btn" id="roleL" onclick="selRole('livreur',this)">
      <span class="role-icon">üöö</span>Livreur
    </div>
    <div class="role-btn" id="roleC" onclick="selRole('client',this)">
      <span class="role-icon">üõí</span>Commer√ßant
    </div>
  </div>
  <!-- Bouton admin cach√© ‚Äî activ√© par triple-tap sur le logo -->
  <div id="roleA" style="display:none">
    <div class="role-btn" onclick="selRole('admin',this)" style="width:100%;max-width:360px;border-color:rgba(139,92,246,0.4);color:#8B5CF6;margin-top:6px">
      <span class="role-icon">‚öôÔ∏è</span>Administration
    </div>
  </div>
  <div class="fg"><label class="fl">Identifiant</label><input class="fi" id="loginUser" placeholder="Votre identifiant" autocomplete="username"></div>
  <div class="fg"><label class="fl">Mot de passe</label><input class="fi" type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
  <button class="btn-p" onclick="doLogin()">Connexion ‚Üí</button>
  <div class="login-err" id="loginErr"></div>
  <div id="demoHint" style="margin-top:14px;padding:12px 16px;background:rgba(249,115,22,0.08);border:1px solid rgba(249,115,22,0.25);border-radius:12px;font-size:12px;color:var(--muted);line-height:1.7;text-align:center">
    <div style="font-weight:700;color:var(--accent);margin-bottom:4px">üéØ Mode d√©monstration</div>
    <div>Fournisseur : <b>admin</b> / <b>1234</b></div>
    <div>Livreur 1 : <b>ahmed</b> / <b>1234</b></div>
    <div>Livreur 2 : <b>mohamed</b> / <b>1234</b></div>
    <div style="margin-top:8px;padding-top:8px;border-top:1px dashed rgba(139,92,246,0.4)">
      <span style="color:#8B5CF6;font-weight:700">‚öôÔ∏è Super Admin :</span>
      <b style="color:#8B5CF6"> delitrack</b> <span style="color:var(--muted)">/</span> <b style="color:#8B5CF6">admin2025!</b>
      <div style="font-size:10px;color:rgba(139,92,246,0.6);margin-top:2px">Triple-tap sur le logo DeliTrack</div>
    </div>
    <div style="margin-top:6px;font-size:11px;opacity:0.7">Configurez Supabase ‚öôÔ∏è pour utiliser vos vraies donn√©es</div>
  </div>
</div>

<!-- ======== FOURNISSEUR ======== -->
<div id="fApp" class="screen">
  <div class="topbar">
    <div>
      <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px">Tableau de bord</div>
      <div class="topbar-title">DeliTrack</div>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <span class="tbadge"><span class="live-dot"></span>LIVE</span>
      <span id="planBadge" style="font-size:11px;font-weight:700;padding:4px 10px;border-radius:8px;letter-spacing:0.5px">Plan</span>
      <button onclick="toggleLang()" id="langBtnF" style="background:var(--card);border:1.5px solid var(--border);border-radius:10px;padding:5px 12px;font-size:13px;font-weight:800;cursor:pointer;color:var(--text);display:flex;align-items:center;gap:5px"><span id="langBtnFFlag">üá©üáø</span><span id="langBtnFTxt">ÿπÿ±</span></button>
      <button onclick="showCfg()" style="background:none;border:none;font-size:18px;cursor:pointer;padding:4px;line-height:1" title="Configuration carte & Supabase">‚öôÔ∏è</button>
      <button class="theme-toggle-btn" onclick="toggleTheme()" style="background:none;border:none;font-size:18px;cursor:pointer;padding:4px;line-height:1" title="Changer le th√®me">‚òÄÔ∏è</button>
      <span onclick="openChangeMdp()" style="cursor:pointer;font-size:18px;padding:4px" title="Changer le mot de passe">üîë</span>
      <span style="cursor:pointer;font-size:18px" onclick="logout()">‚¨ÖÔ∏è</span>
    </div>
  </div>

  <div class="map-box">
    <div id="realMap" style="width:100%;height:100%"></div>
    <div class="map-badge"><span class="live-dot"></span><span id="activeCount">0</span> livreurs actifs</div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="fTab('livreurs',this)">Livreurs</div>
    <div class="tab" onclick="fTab('livraisons',this)">Livraisons</div>
    <div class="tab" onclick="fTab('stock',this)">üì¶ Stock</div>
    <div class="tab" onclick="fTab('commer√ßants',this)">Commer√ßants</div>
    <div class="tab" onclick="fTab('equipe',this)">üë• √âquipe</div>
    <div class="tab" onclick="fTab('commandes',this);loadCommandesFournisseur()">üì¨ Commandes</div>
    <div class="tab" onclick="fTab('annonces',this);loadAnnonces()">üì¢ Annonces</div>
    <div class="tab" onclick="fTab('parametres',this);loadParametres()">‚öôÔ∏è Param√®tres</div>
    <div class="tab" onclick="fTab('export',this)">üì• Export</div>
  </div>

  <div class="content">
    <!-- LIVREURS -->
    <div id="tf-livreurs" class="tc active">
      <div class="stats-row">
        <div class="scard"><div class="sval" style="color:var(--accent3)" id="stA">0</div><div class="slbl">Actifs</div></div>
        <div class="scard"><div class="sval" style="color:var(--accent)" id="stL">0</div><div class="slbl">Livraisons</div></div>
        <div class="scard"><div class="sval" style="color:var(--accent2)" id="stM">0</div><div class="slbl">DA encaiss√©</div></div>
      </div>
      <div class="sec-title">Livreurs <span class="bcnt" id="totalLiv">0</span></div>
      <div id="livreursList"></div>
    </div>

    <!-- LIVRAISONS -->
    <div id="tf-livraisons" class="tc">
      <div class="sec-title">Livraisons du jour</div>
      <div id="allDeliveries"></div>
    </div>

    <!-- STOCK -->
    <div id="tf-stock" class="tc">
      <div class="sec-title">Gestion du stock
        <button class="add-btn" onclick="openAddProduct()">+ Produit</button>
      </div>
      <div id="stockList"></div>

      <!-- APPROVISIONNEMENT -->
      <div style="margin-top:20px">
        <div class="sec-title">Approvisionnement</div>
        <div class="fsec">
          <div class="fstitle">üì¶ Ajouter un stock</div>
          <select class="di" id="approvProduit">
            <option value="">S√©lectionner un produit</option>
          </select>
          <input class="di" type="number" id="approvQty" placeholder="Quantit√© re√ßue">
          <input class="di" type="text" id="approvNote" placeholder="Note (fournisseur, lot, etc.)">
          <button class="sbtn" onclick="doApprov()" style="background:linear-gradient(135deg,#3B82F6,#1D4ED8)">+ Ajouter au stock</button>
        </div>
      </div>

      <!-- CHARGEMENT LIVREUR -->
      <div style="margin-top:20px">
        <div class="sec-title">Charger un livreur</div>
        <div class="fsec">
          <div class="fstitle">üöö Chargement du jour</div>
          <select class="di" id="chargLivreur">
            <option value="">S√©lectionner un livreur</option>
          </select>
          <div id="chargProduits" style="margin-bottom:10px"></div>
          <button class="sbtn" onclick="doChargement()">‚úÖ Valider le chargement</button>
        </div>
      </div>
    </div>

    <!-- CLIENTS -->
    <div id="tf-clients" class="tc">
      <div class="sec-title">Clients <span class="bcnt" id="totalClients">0</span></div>
      <div id="clientsList"></div>
    </div>

    <!-- EQUIPE -->
    <div id="tf-equipe" class="tc">
      <div class="sec-title">√âquipe
        <button class="add-btn" onclick="openAddLivreur()">+ Livreur</button>
      </div>
      <div id="equipeList"></div>
    </div>

    <!-- COMMANDES CLIENTS -->
    <div id="tf-commandes" class="tc">
      <div class="sec-title">Commandes clients
        <span class="bcnt" id="cmdBadge">0</span>
      </div>
      <div class="filter-row" style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
        <select class="di" id="filtreStatutCmd" onchange="loadCommandesFournisseur()" style="margin-bottom:0;flex:1">
          <option value="">Tous les statuts</option>
          <option value="en_attente">‚è≥ En attente</option>
          <option value="confirmee">‚úÖ Confirm√©e</option>
          <option value="en_preparation">‚öôÔ∏è En pr√©paration</option>
          <option value="en_livraison">üöö En livraison</option>
          <option value="livree">üì¶ Livr√©e</option>
          <option value="annulee">‚ùå Annul√©e</option>
        </select>
      </div>
      <div id="commandesFournisseurList"></div>
    </div>

    <!-- EXPORT -->
    <div id="tf-export" class="tc">
      <div class="fsec">
        <div class="fstitle">üì• Exporter les donn√©es</div>
        <p style="font-size:13px;color:var(--muted);margin-bottom:18px">T√©l√©chargez vos donn√©es au format Excel (.xlsx) pour les utiliser dans Excel, Google Sheets ou toute application offline.</p>

        <div style="margin-bottom:14px">
          <label class="fl">P√©riode</label>
          <select class="di" id="exportPeriod" style="margin-top:8px">
            <option value="month">Ce mois</option>
            <option value="quarter">Ce trimestre</option>
            <option value="semester">Ce semestre</option>
            <option value="year">Cette ann√©e</option>
            <option value="custom">Dates personnalis√©es</option>
          </select>
        </div>

        <div id="customDates" style="display:none">
          <input class="di" type="date" id="exportFrom" placeholder="Date d√©but">
          <input class="di" type="date" id="exportTo" placeholder="Date fin">
        </div>

        <div style="margin-bottom:14px">
          <label class="fl">Donn√©es √† exporter</label>
          <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:14px">
              <input type="checkbox" id="expLivraisons" checked style="width:16px;height:16px;accent-color:var(--accent)"> Livraisons
            </label>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:14px">
              <input type="checkbox" id="expClients" checked style="width:16px;height:16px;accent-color:var(--accent)"> Clients
            </label>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:14px">
              <input type="checkbox" id="expStock" checked style="width:16px;height:16px;accent-color:var(--accent)"> Mouvements de stock
            </label>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:14px">
              <input type="checkbox" id="expResume" checked style="width:16px;height:16px;accent-color:var(--accent)"> R√©sum√© par livreur
            </label>
          </div>
        </div>

        <button class="exp-btn" style="background:linear-gradient(135deg,#10B981,#059669);color:white" onclick="exportExcel()">
          üìä T√©l√©charger Excel (.xlsx)
        </button>
        <button class="exp-btn" style="background:linear-gradient(135deg,#3B82F6,#1D4ED8);color:white" onclick="exportCSV()">
          üìÑ T√©l√©charger CSV
        </button>
      </div>

      <div class="fsec">
        <div class="fstitle">üìä R√©sum√© p√©riode</div>
        <div class="stats-row">
          <div class="scard"><div class="sval" style="color:var(--accent3)" id="rL">0</div><div class="slbl">Livraisons</div></div>
          <div class="scard"><div class="sval" style="color:var(--accent)" id="rLiv">0</div><div class="slbl">Livreurs</div></div>
          <div class="scard"><div class="sval" style="color:var(--accent2)" id="rM">0</div><div class="slbl">DA total</div></div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ ANNONCES ‚îÄ‚îÄ -->
    <div id="tf-annonces" class="tc">
      <div class="fsec">
        <div class="fstitle">üì¢ Nouvelle annonce</div>
        <p style="font-size:13px;color:var(--muted);margin-bottom:16px">Envoyez une notification √† tous vos commer√ßants : promo, nouveau produit, info‚Ä¶</p>

        <!-- Type d'annonce -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px">
          <button class="annonce-type-btn active" data-type="info"     onclick="selAnnonceType('info',this)"           style="padding:10px 6px;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;border:1.5px solid var(--accent2);background:rgba(59,130,246,0.12);color:var(--accent2)">‚ÑπÔ∏è Information</button>
          <button class="annonce-type-btn"         data-type="promo"   onclick="selAnnonceType('promo',this)"          style="padding:10px 6px;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:var(--card);color:var(--muted)">üè∑Ô∏è Promotion</button>
          <button class="annonce-type-btn"         data-type="nouveau_produit" onclick="selAnnonceType('nouveau_produit',this)" style="padding:10px 6px;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:var(--card);color:var(--muted)">üÜï Nouveau produit</button>
          <button class="annonce-type-btn"         data-type="alerte"  onclick="selAnnonceType('alerte',this)"         style="padding:10px 6px;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:var(--card);color:var(--muted)">‚ö†Ô∏è Alerte</button>
        </div>
        <input type="hidden" id="annonceType" value="info">

        <input class="di" id="annonceTitre"  placeholder="Titre de l'annonce  (ex: Promo huile -20%)">
        <textarea class="di" id="annonceContenu" rows="3" placeholder="Message pour vos commer√ßants‚Ä¶" style="resize:none"></textarea>

        <!-- Date d'expiration optionnelle -->
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <label style="font-size:13px;color:var(--muted);white-space:nowrap">Expire le (optionnel) :</label>
          <input class="di" type="date" id="annonceExpire" style="margin:0;flex:1">
        </div>

        <button class="sbtn" onclick="publierAnnonce()">üì§ Publier l'annonce</button>
      </div>

      <div class="fsec">
        <div class="fstitle" style="justify-content:space-between">
          Annonces publi√©es
          <span id="annoncesBadge" style="font-family:'DM Sans';font-size:12px;font-weight:400;color:var(--muted)"></span>
        </div>
        <div id="annoncesList"><div class="empty"><div class="eico">üì¢</div>Aucune annonce publi√©e</div></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PARAM√àTRES ‚îÄ‚îÄ -->
    <div id="tf-parametres" class="tc">
      <div class="fsec">
        <div class="fstitle">üõí Commandes en ligne</div>
        <p style="font-size:13px;color:var(--muted);margin-bottom:18px">Activez ou d√©sactivez la possibilit√© pour vos commer√ßants de passer des commandes via l'application.</p>

        <!-- Toggle principal -->
        <div style="display:flex;align-items:center;justify-content:space-between;background:var(--card);border:1.5px solid var(--border);border-radius:14px;padding:16px;margin-bottom:14px">
          <div>
            <div style="font-weight:700;font-size:15px" id="cmdToggleLabel">Commandes activ√©es</div>
            <div style="font-size:12px;color:var(--muted);margin-top:2px" id="cmdToggleSub">Vos commer√ßants peuvent commander en ligne</div>
          </div>
          <div id="cmdToggle" onclick="toggleCommandes()" style="width:52px;height:28px;border-radius:14px;background:var(--accent3);cursor:pointer;position:relative;transition:background 0.25s;flex-shrink:0">
            <div id="cmdToggleKnob" style="position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:white;transition:left 0.25s;box-shadow:0 1px 4px rgba(0,0,0,0.2)"></div>
          </div>
        </div>

        <!-- Message personnalis√© affich√© aux commer√ßants quand d√©sactiv√© -->
        <div id="cmdMessageBox">
          <label class="fl">Message affich√© aux commer√ßants (quand d√©sactiv√©)</label>
          <textarea class="di" id="cmdMessage" rows="3" placeholder="Ex : Commandes suspendues temporairement. Contactez-nous au 0550 XX XX XX." style="resize:none;margin-top:6px"></textarea>
          <button class="sbtn" onclick="sauvegarderParametres()" style="margin-top:4px">üíæ Enregistrer</button>
        </div>
      </div>

      <div class="fsec">
        <div class="fstitle">‚ÑπÔ∏è Informations du compte</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:12px">Ces informations sont visibles par vos commer√ßants.</div>
        <input class="di" id="paramNom"      placeholder="Nom de l'entreprise">
        <input class="di" id="paramAdresse"  placeholder="Adresse / Zone de livraison">
        <input class="di" id="paramTel"      placeholder="T√©l√©phone de contact" type="tel">
        <button class="sbtn" onclick="sauvegarderParametres()">üíæ Enregistrer les informations</button>
      </div>
    </div>

  </div>

  <!-- MODAL LIVREUR DETAIL -->
  <div class="mover" id="livModal" onclick="closeMod('livModal')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="mhandle"></div>
      <div class="mtitle" id="modName"></div>
      <div class="msub" id="modSub"></div>
      <div class="msg" id="modStats"></div>
      <div id="modDelivs"></div>
      <button class="cbtn" style="background:rgba(59,130,246,0.1);border-color:rgba(59,130,246,0.3);color:var(--accent2);margin-bottom:10px" id="modTrajetBtn" onclick="openTrajet()">üó∫Ô∏è Voir le trajet du jour</button>
      <button class="cbtn" onclick="closeMod('livModal')">Fermer</button>
    </div>
  </div>

  <!-- MODAL TRAJET GPS -->
  <div class="mover" id="trajetModal" onclick="closeMod('trajetModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-height:95vh">
      <div class="mhandle"></div>
      <div class="mtitle" id="trajetTitle">üó∫Ô∏è Trajet du jour</div>
      <div class="msub" id="trajetSub"></div>

      <!-- S√©lecteur de date -->
      <div class="trajet-date-sel">
        <label style="font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px">Date :</label>
        <input type="date" id="trajetDate" class="di" style="margin-bottom:0;width:auto;padding:8px 12px"
          onchange="loadTrajet()">
        <button onclick="loadTrajet()" style="padding:8px 16px;background:var(--accent2);border:none;border-radius:8px;color:white;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer">üîÑ Charger</button>
      </div>

      <!-- Stats trajet -->
      <div class="trajet-stats" id="trajetStats"></div>

      <!-- L√©gende -->
      <div class="trajet-legend">
        <div class="tleg-item"><div class="tleg-dot" style="background:#3B82F6"></div>Trajet GPS</div>
        <div class="tleg-item"><div class="tleg-dot" style="background:#10B981"></div>D√©part</div>
        <div class="tleg-item"><div class="tleg-dot" style="background:#F97316"></div>Livraisons</div>
        <div class="tleg-item"><div class="tleg-dot" style="background:#EF4444"></div>Position actuelle</div>
      </div>

      <!-- Carte trajet -->
      <div id="trajetMap"></div>

      <!-- Timeline livraisons -->
      <div style="font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;font-weight:700">Livraisons du jour</div>
      <div id="trajetLivraisons"></div>

      <button class="cbtn" onclick="closeMod('trajetModal')" style="margin-top:14px">Fermer</button>
    </div>
  </div>

  <!-- MODAL AJOUTER PRODUIT -->
  <div class="mover" id="addProdModal" onclick="closeMod('addProdModal')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="mhandle"></div>
      <div class="mtitle">‚ûï Nouveau produit</div>
      <div class="msub">Ajouter un produit au catalogue</div>
      <input class="fi" id="newProdNom" placeholder="Nom du produit" style="margin-bottom:12px">

      <!-- Image produit -->
      <label class="fl" style="margin-bottom:8px;display:block">Photo du produit</label>
      <div class="prod-img-upload" onclick="document.getElementById('newProdImgInput').click()" id="newProdImgPreview">
        <div class="prod-img-placeholder"><span>üì∑</span>Appuyer pour ajouter une photo</div>
        <div class="prod-img-badge" style="display:none" id="newProdImgBadge">‚úì Photo ajout√©e</div>
      </div>
      <input type="file" id="newProdImgInput" accept="image/*" style="display:none" onchange="previewProdImg(this,'newProdImgPreview','newProdImgBadge','newProdImgData')">
      <input type="hidden" id="newProdImgData">

      <input class="fi" id="newProdUnite" placeholder="Unit√© (bouteilles, sacs, paquets‚Ä¶)" style="margin-bottom:12px">

      <!-- Conditionnement -->
      <label class="fl" style="margin-bottom:8px;display:block">üì¶ Conditionnement</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
        <select class="fi" id="newProdCondType" style="margin-bottom:0">
          <option value="">Type (optionnel)</option>
          <option value="carton">üì¶ Carton</option>
          <option value="fardeau">üéÅ Fardeau</option>
          <option value="palette">ü™µ Palette</option>
          <option value="caisse">üóÉÔ∏è Caisse</option>
          <option value="sac">üõçÔ∏è Sac</option>
        </select>
        <input class="fi" type="number" id="newProdCondQty" placeholder="Qt√© / conditionnement" style="margin-bottom:0" min="1">
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">
        <input class="fi" type="number" id="newProdStock" placeholder="Stock initial" style="margin-bottom:0">
        <input class="fi" type="number" id="newProdPrix" placeholder="Prix unitaire (DA)" style="margin-bottom:0">
      </div>
      <button class="btn-p" style="max-width:100%;margin-bottom:10px" onclick="saveNewProduct()">Enregistrer le produit</button>
      <button class="cbtn" onclick="closeMod('addProdModal')">Annuler</button>
    </div>
  </div>



  <!-- MODAL CLIENT DETAIL -->
  <div class="mover" id="clientModal" onclick="closeMod('clientModal')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="mhandle"></div>
      <div class="mtitle" id="cModName"></div>
      <div class="msub" id="cModSub"></div>
      <div class="msg" id="cModStats"></div>
      <div id="cModHistory"></div>
      <button class="cbtn" onclick="closeMod('clientModal')">Fermer</button>
    </div>
  </div>
</div>

<!-- ======== MODAL CHANGEMENT MOT DE PASSE (global) ======== -->
<div class="mover" id="changeMdpModal" onclick="closeMod('changeMdpModal')">
  <div class="modal" onclick="event.stopPropagation()" style="max-width:420px">
    <div class="mhandle"></div>
    <div class="mtitle">üîë Changer le mot de passe</div>
    <div class="msub" id="changeMdpSub">Modifiez votre mot de passe de connexion</div>

    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:20px">
      <div>
        <label class="fl">Ancien mot de passe</label>
        <div style="position:relative;margin-top:6px">
          <input class="fi" type="password" id="mdpAncien" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="padding-right:44px">
          <button onclick="toggleMdpVis('mdpAncien',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:var(--muted)">üëÅ</button>
        </div>
      </div>
      <div>
        <label class="fl">Nouveau mot de passe</label>
        <div style="position:relative;margin-top:6px">
          <input class="fi" type="password" id="mdpNouveau" placeholder="Minimum 6 caract√®res" style="padding-right:44px" oninput="checkMdpStrength(this.value)">
          <button onclick="toggleMdpVis('mdpNouveau',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:var(--muted)">üëÅ</button>
        </div>
        <!-- Barre de force -->
        <div style="height:4px;border-radius:2px;margin-top:6px;background:var(--border);overflow:hidden">
          <div id="mdpStrengthBar" style="height:100%;width:0%;border-radius:2px;transition:width 0.3s,background 0.3s"></div>
        </div>
        <div id="mdpStrengthLabel" style="font-size:11px;color:var(--muted);margin-top:4px"></div>
      </div>
      <div>
        <label class="fl">Confirmer le nouveau mot de passe</label>
        <div style="position:relative;margin-top:6px">
          <input class="fi" type="password" id="mdpConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="padding-right:44px">
          <button onclick="toggleMdpVis('mdpConfirm',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:var(--muted)">üëÅ</button>
        </div>
      </div>
    </div>

    <div id="changeMdpErr" style="display:none;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:10px;padding:10px 14px;font-size:13px;color:var(--danger);margin-bottom:14px"></div>

    <button class="btn-p" id="changeMdpBtn" style="max-width:100%;margin-bottom:10px" onclick="doChangerMdp()">üîë Modifier le mot de passe</button>
    <button class="cbtn" onclick="closeMod('changeMdpModal')">Annuler</button>
  </div>
</div>

<!-- ======== MODAL √âDITION PRODUIT (global ‚Äî hors screens) ======== -->
<div class="mover" id="editProdModal" onclick="closeMod('editProdModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhandle"></div>
    <div class="mtitle">‚úèÔ∏è Modifier le produit</div>
    <input type="hidden" id="editProdId">
    <div style="margin-bottom:10px">
      <label class="fl">Nom *</label>
      <input class="fi" id="editProdNom" placeholder="Nom du produit" style="margin-top:6px;margin-bottom:12px">

      <!-- Image -->
      <label class="fl" style="margin-bottom:6px;display:block">Photo du produit</label>
      <div class="prod-img-upload" onclick="document.getElementById('editProdImgInput').click()" id="editProdImgPreview" style="aspect-ratio:3/1;max-height:100px">
        <div class="prod-img-placeholder" style="flex-direction:row;gap:8px"><span style="font-size:22px">üì∑</span><span>Changer la photo</span></div>
        <div class="prod-img-badge" style="display:none" id="editProdImgBadge">‚úì Modifi√©e</div>
      </div>
      <input type="file" id="editProdImgInput" accept="image/*" style="display:none" onchange="previewProdImg(this,'editProdImgPreview','editProdImgBadge','editProdImgData')">
      <input type="hidden" id="editProdImgData">

      <label class="fl">Unit√©</label>
      <input class="fi" id="editProdUnite" placeholder="bouteilles, sacs..." style="margin-top:6px;margin-bottom:10px">

      <!-- Conditionnement -->
      <label class="fl" style="margin-bottom:6px;display:block">üì¶ Conditionnement</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <select class="fi" id="editProdCondType" style="margin-bottom:0">
          <option value="">Type (optionnel)</option>
          <option value="carton">üì¶ Carton</option>
          <option value="fardeau">üéÅ Fardeau</option>
          <option value="palette">ü™µ Palette</option>
          <option value="caisse">üóÉÔ∏è Caisse</option>
          <option value="sac">üõçÔ∏è Sac</option>
        </select>
        <input class="fi" type="number" id="editProdCondQty" placeholder="Qt√© / conditionnement" style="margin-bottom:0" min="1">
      </div>
    </div>
    <div style="background:rgba(249,115,22,0.06);border:1px solid rgba(249,115,22,0.2);border-radius:12px;padding:14px;margin-bottom:12px">
      <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted);margin-bottom:10px">üí∞ Prix de vente</div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <span style="font-size:12px;color:var(--muted)">Prix actuel :</span>
        <span id="editProdPrixActuel" style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--accent)">‚Äî DA</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label class="fl">Nouveau prix (DA)</label>
          <input class="fi" type="number" id="editProdNouveauPrix" placeholder="0" style="margin-top:6px">
        </div>
        <div>
          <label class="fl">Motif du changement</label>
          <input class="fi" id="editProdNote" placeholder="Hausse mati√®res, etc." style="margin-top:6px">
        </div>
      </div>
    </div>
    <div style="margin-bottom:16px">
      <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted);margin-bottom:8px">üìä Historique des prix</div>
      <div id="historiquePrixList" style="max-height:200px;overflow-y:auto"></div>
    </div>
    <button class="btn-p" style="max-width:100%;margin-bottom:10px" id="editProdBtn" onclick="saveProduit()">üíæ Enregistrer</button>
    <button class="cbtn" onclick="closeMod('editProdModal')">Annuler</button>
  </div>
</div>

<!-- ======== LIVREUR ======== -->
<div id="lApp" class="screen">
  <!-- BARRE STATUT R√âSEAU ‚Äî appara√Æt seulement hors ligne / reconnexion -->
  <div id="offlineBar" style="display:none;position:fixed;top:0;left:0;right:0;z-index:999;padding:10px 16px;font-size:13px;font-weight:600;color:white;text-align:center;backdrop-filter:blur(6px)"></div>

  <div class="ltopbar">
    <div style="display:flex;align-items:flex-start;justify-content:space-between">
      <div>
        <div class="greeting">Bonjour üëã</div>
        <div class="lbigname" id="lWelcome">Livreur</div>
        <!-- Badge livraisons hors ligne en attente -->
        <div id="offlineBadge" style="display:none;margin-top:4px;font-size:11px;font-weight:700;background:rgba(239,68,68,0.2);color:#FCA5A5;border:1px solid rgba(239,68,68,0.3);border-radius:20px;padding:3px 10px;width:fit-content;align-items:center;gap:5px">
          ‚è≥ <span></span>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:4px">
        <button onclick="toggleLang()" id="langBtnL" style="background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);border-radius:10px;padding:7px 12px;font-size:13px;font-weight:800;cursor:pointer;color:white;display:flex;align-items:center;gap:5px"><span id="langBtnLFlag">üá©üáø</span><span id="langBtnLTxt">ÿπÿ±</span></button>
        <button class="theme-toggle-btn" onclick="toggleTheme()" style="padding:7px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;color:white;font-size:15px;cursor:pointer" title="Changer le th√®me">‚òÄÔ∏è</button>
        <button onclick="openChangeMdp()" style="padding:7px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;color:white;font-size:15px;cursor:pointer" title="Changer le mot de passe">üîë</button>
        <button onclick="logout()" style="padding:7px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;color:white;font-size:15px;cursor:pointer">‚¨ÖÔ∏è</button>
      </div>
    </div>
    <div class="gps-st">
      <span class="live-dot"></span>
      <span id="gpsStTxt">GPS en attente...</span>
    </div>
  </div>

  <div class="content" style="padding-top:10px">

    <!-- ACCUEIL LIVREUR : grille de navigation visuelle -->
    <div id="lt-camion" class="tc active">
      <!-- Grille d'acc√®s rapide -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
        <button onclick="lNavTo('livrer')" style="background:linear-gradient(135deg,#F97316,#EA580C);border:none;border-radius:18px;padding:22px 16px;cursor:pointer;text-align:left;color:white;position:relative;overflow:hidden">
          <div style="font-size:32px;margin-bottom:8px">‚ûï</div>
          <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800">Nouvelle<br>livraison</div>
          <div style="position:absolute;right:-10px;bottom:-10px;font-size:60px;opacity:0.15">üöö</div>
        </button>
        <button onclick="lNavTo('clients')" style="background:linear-gradient(135deg,#3B82F6,#1D4ED8);border:none;border-radius:18px;padding:22px 16px;cursor:pointer;text-align:left;color:white;position:relative;overflow:hidden">
          <div style="font-size:32px;margin-bottom:8px">üë•</div>
          <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800">Mes<br>commer√ßants</div>
          <div style="position:absolute;right:-10px;bottom:-10px;font-size:60px;opacity:0.15">üè™</div>
        </button>
        <button onclick="lNavTo('historique')" style="background:linear-gradient(135deg,#8B5CF6,#6D28D9);border:none;border-radius:18px;padding:22px 16px;cursor:pointer;text-align:left;color:white;position:relative;overflow:hidden">
          <div style="font-size:32px;margin-bottom:8px">üìã</div>
          <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800">Mes<br>livraisons</div>
          <div style="position:absolute;right:-10px;bottom:-10px;font-size:60px;opacity:0.15">üì¶</div>
        </button>
        <button onclick="lNavTo('credits');loadCredits()" style="background:linear-gradient(135deg,#EF4444,#DC2626);border:none;border-radius:18px;padding:22px 16px;cursor:pointer;text-align:left;color:white;position:relative;overflow:hidden">
          <div style="font-size:32px;margin-bottom:8px">üí∞</div>
          <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800">Cr√©dits<br><span id="creditBtnBadge" style="font-size:12px;opacity:0.85">en attente</span></div>
          <div style="position:absolute;right:-10px;bottom:-10px;font-size:60px;opacity:0.15">üí≥</div>
        </button>
      </div>
      <!-- Camion chargement -->
      <div style="background:var(--card);border:1.5px solid var(--border);border-radius:18px;padding:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700">üöö Mon camion <span class="bcnt" id="camionCount" style="font-size:12px">0</span></div>
          <button onclick="openHistFactures()" style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:6px 12px;font-size:11px;font-weight:700;cursor:pointer;color:var(--muted)">üßæ Factures</button>
        </div>
        <div id="camionList"></div>
      </div>
    </div>

    <!-- LIVRER -->
    <div id="lt-livrer" class="tc">
      <div class="fsec">
        <div class="fstitle">üë§ Informations Commer√ßant</div>
        <!-- Recherche commer√ßant existant -->
        <div style="position:relative;margin-bottom:10px">
          <input class="di" type="text" id="clientSearch" placeholder="üîç Rechercher un commer√ßant existant..." oninput="searchClients(this.value)" style="margin-bottom:0">
          <div id="clientSuggestions" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--card);border:1.5px solid var(--border);border-radius:0 0 10px 10px;z-index:50;max-height:180px;overflow-y:auto"></div>
        </div>
        <input class="di" type="text" id="clientName" placeholder="Nom du commer√ßant / √âpicerie">
        <input class="di" type="tel" id="clientPhone" placeholder="T√©l√©phone">
        <input class="di" type="text" id="clientAddr" placeholder="Adresse compl√®te">
      </div>

      <div class="fsec">
        <div class="fstitle">üìç Position GPS</div>
        <button class="gps-btn" onclick="capGPS()">üì° Capturer ma position GPS</button>
        <div class="gps-coords" id="gpsDsp">Position non captur√©e</div>
      </div>

      <div class="fsec">
        <div class="fstitle">üì¶ Produits Livr√©s</div>
        <div class="psel" id="prodCheck"></div>
      </div>

      <div class="fsec">
        <div class="fstitle">üíµ Encaissement</div>

        <!-- Total calcul√© automatiquement -->
        <div id="totalCalcule" style="display:none;background:rgba(16,185,129,0.08);border:1.5px solid rgba(16,185,129,0.3);border-radius:12px;padding:14px;margin-bottom:12px">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px">Total de la commande</div>
          <div style="font-family:'Syne',sans-serif;font-size:26px;font-weight:800;color:var(--accent3)" id="totalCalcVal">0 DA</div>
          <div style="font-size:11px;color:var(--muted);margin-top:3px" id="totalCalcDetail"></div>
        </div>

        <!-- Montant vers√© -->
        <div style="margin-bottom:10px">
          <label class="fl">Montant vers√© maintenant (DA)</label>
          <input class="di" type="number" id="montant" placeholder="0" style="font-size:20px;font-weight:700;text-align:center;margin-top:4px" oninput="onMontantChange()">
        </div>

        <!-- Indicateur reste d√ª ‚Äî appara√Æt quand montant < total -->
        <div id="resteIndicateur" style="display:none;border-radius:12px;padding:12px 14px;margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <span style="font-size:13px;font-weight:600" id="resteLabel">Reste √† r√©gler</span>
            <span style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800" id="resteVal">0 DA</span>
          </div>
          <div style="font-size:11px" id="resteInfo"></div>
        </div>

        <!-- Mode paiement -->
        <select class="di" id="modePay">
          <option value="">Mode de paiement</option>
          <option value="Esp√®ces">üíµ Esp√®ces</option>
          <option value="Ch√®que">üìÑ Ch√®que</option>
          <option value="Virement">üè¶ Virement</option>
          <option value="Total en cr√©dit">üìã Total en cr√©dit (rien vers√©)</option>
        </select>

        <textarea class="di" id="notesLiv" placeholder="Notes (optionnel)" rows="2" style="resize:none"></textarea>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
        <button class="sbtn" id="submitBtn" onclick="submitLivraison()" style="margin-bottom:0">‚úÖ Valider</button>
        <button class="sbtn" onclick="previewFacture()" style="background:linear-gradient(135deg,#3B82F6,#1D4ED8);margin-bottom:0">üßæ Voir facture</button>
      </div>
    </div>

    <!-- CLIENTS LIVREUR -->
    <div id="lt-clients" class="tc">
      <div class="sec-title">Mes commer√ßants <span class="bcnt" id="lClientCount">0</span></div>
      <div id="lClientsList"></div>
    </div>

    <!-- HISTORIQUE -->
    <div id="lt-historique" class="tc">
      <div class="sec-title">Mes livraisons <span class="bcnt" id="myCount">0</span></div>
      <div id="myDelivs"></div>
    </div>

    <!-- CR√âDITS -->
    <div id="lt-credits" class="tc">
      <div class="sec-title">Cr√©dits en attente <span class="bcnt" id="creditCount" style="background:rgba(239,68,68,0.2);color:var(--danger)">0</span></div>
      <!-- R√©sum√© total -->
      <div id="creditResume" style="display:none;background:rgba(239,68,68,0.08);border:1.5px solid rgba(239,68,68,0.25);border-radius:14px;padding:14px 16px;margin-bottom:14px">
        <div style="font-size:12px;color:var(--muted)">Total √† encaisser</div>
        <div style="font-family:'Syne',sans-serif;font-size:26px;font-weight:800;color:var(--danger)" id="creditTotal">0 DA</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px" id="creditNbClients"></div>
      </div>
      <div id="creditsList"></div>
    </div>

  </div>

  <div class="bnav">
    <div class="nitem active" id="lnav-accueil" onclick="lNavTo('camion')"><span class="nico">üè†</span><span class="lnav-lbl">Accueil</span></div>
    <div class="nitem" id="lnav-livrer" onclick="lNavTo('livrer')"><span class="nico">‚ûï</span><span class="lnav-lbl">Livrer</span></div>
    <div class="nitem" id="lnav-clients" onclick="lNavTo('clients')"><span class="nico">üë•</span><span class="lnav-lbl">Commer√ßants</span></div>
    <div class="nitem" id="lnav-historique" onclick="lNavTo('historique')"><span class="nico">üìã</span><span class="lnav-lbl">Historique</span></div>
    <div class="nitem" id="lnav-credits" onclick="lNavTo('credits');loadCredits()" style="position:relative">
      <span class="nico">üí∞</span><span class="lnav-lbl">Cr√©dits</span>
      <span id="creditNavBadge" style="display:none;position:absolute;top:2px;right:8px;background:var(--danger);color:white;font-size:9px;font-weight:800;min-width:16px;height:16px;border-radius:8px;padding:0 3px;align-items:center;justify-content:center">0</span>
    </div>
    <div class="nitem" onclick="logout()"><span class="nico">üîì</span><span class="lnav-lbl">Quitter</span></div>
  </div>
</div>

<!-- MODAL ENCAISSEMENT CR√âDIT -->
<div class="mover" id="encaisserModal" onclick="closeMod('encaisserModal')">
  <div class="modal" onclick="event.stopPropagation()" style="max-width:440px">
    <div class="mhandle"></div>
    <div class="mtitle">üí∞ Encaissement cr√©dit</div>
    <div class="msub" id="encaisserSub">Commer√ßant</div>

    <!-- D√©tail de la dette -->
    <div id="encaisserDette" style="background:rgba(239,68,68,0.08);border:1.5px solid rgba(239,68,68,0.2);border-radius:12px;padding:14px;margin-bottom:16px">
      <div style="font-size:12px;color:var(--muted);margin-bottom:4px">Montant d√ª</div>
      <div style="font-family:'Syne',sans-serif;font-size:28px;font-weight:800;color:var(--danger)" id="encaisserMontantDu">0 DA</div>
      <div style="font-size:11px;color:var(--muted);margin-top:4px" id="encaisserDateDette"></div>
    </div>

    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:16px">
      <div>
        <label class="fl">Montant encaiss√© (DA)</label>
        <input class="fi" type="number" id="encaisserMontant" placeholder="Montant re√ßu" style="margin-top:6px;font-size:20px;font-weight:700;text-align:center" oninput="updateEncaisserReste()">
      </div>
      <div id="encaisserResteBox" style="display:none;border-radius:10px;padding:10px 14px;text-align:center">
        <div style="font-size:12px;color:var(--muted)">Reste</div>
        <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800" id="encaisserReste">0 DA</div>
      </div>
      <div>
        <label class="fl">Mode de paiement</label>
        <select class="fi" id="encaisserMode" style="margin-top:6px">
          <option value="Esp√®ces">Esp√®ces</option>
          <option value="Ch√®que">Ch√®que</option>
          <option value="Virement">Virement</option>
        </select>
      </div>
      <div>
        <label class="fl">Notes (optionnel)</label>
        <input class="fi" id="encaisserNotes" placeholder="Ex: re√ßu ch√®que N¬∞..." style="margin-top:6px">
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <button class="btn-p" style="margin:0;background:linear-gradient(135deg,#10B981,#059669)" id="btnEncaisserConfirm" onclick="confirmerEncaissement()">‚úÖ Encaisser</button>
      <button style="padding:14px;background:rgba(59,130,246,0.1);border:1.5px solid rgba(59,130,246,0.3);border-radius:12px;color:var(--accent2);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer" onclick="confirmerEncaisserImprimer()">üñ®Ô∏è Encaisser + Re√ßu</button>
    </div>
    <button class="cbtn" onclick="closeMod('encaisserModal')">Annuler</button>
  </div>
</div>

<!-- MODAL AJOUTER/MODIFIER LIVREUR -->
<div class="mover" id="addLivModal" onclick="closeMod('addLivModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhandle"></div>
    <div class="mtitle" id="addLivTitle">‚ûï Nouveau livreur</div>
    <div class="msub">Remplissez les informations du livreur</div>
    <input type="hidden" id="editLivId">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div><label class="fl">Nom complet</label><input class="fi" id="livNom" placeholder="Ahmed Kader" style="margin-top:6px"></div>
      <div><label class="fl">Initiales</label><input class="fi" id="livInitiales" placeholder="AK" maxlength="2" style="margin-top:6px"></div>
    </div>
    <div style="margin-bottom:10px">
      <label class="fl">Zone / Secteur</label>
      <input class="fi" id="livZone" placeholder="El Harrach / Baraki" style="margin-top:6px">
    </div>
    <div style="margin-bottom:10px">
      <label class="fl">Ville (pour la carte)</label>
      <select class="fi" id="livVille" onchange="onVilleChange(this)" style="margin-top:6px">
        <option value="">-- S√©lectionner la ville --</option>
        <option value="36.7538,3.0588">Alger</option>
        <option value="35.5553,6.1742">Batna</option>
        <option value="36.3650,6.6147">Constantine</option>
        <option value="35.6969,0.6331">Oran</option>
        <option value="36.4700,2.8277">Blida</option>
        <option value="35.3312,1.3214">Sidi Bel Abb√®s</option>
        <option value="36.1898,5.4108">S√©tif</option>
        <option value="36.4633,2.9551">M√©d√©a</option>
        <option value="35.9256,5.7243">Jijel</option>
        <option value="36.7525,4.0420">Tizi Ouzou</option>
        <option value="36.7372,3.3157">Boumerd√®s</option>
        <option value="35.3328,1.3203">Tlemcen</option>
        <option value="34.8524,5.7277">Biskra</option>
        <option value="33.5000,3.0833">Gharda√Øa</option>
        <option value="36.9000,6.9000">Annaba</option>
        <option value="36.4658,6.2642">Mila</option>
        <option value="35.9306,8.1264">Souk Ahras</option>
        <option value="custom">Autre ville (coordonn√©es manuelles)</option>
      </select>
      <input type="hidden" id="livLat" value="36.7538">
      <input type="hidden" id="livLng" value="3.0588">
    </div>
    <div id="customCoordsDiv" style="display:none;margin-bottom:10px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label class="fl">Latitude</label><input class="fi" id="livLatManual" placeholder="ex: 35.5553" style="margin-top:6px" oninput="document.getElementById('livLat').value=this.value"></div>
        <div><label class="fl">Longitude</label><input class="fi" id="livLngManual" placeholder="ex: 6.1742" style="margin-top:6px" oninput="document.getElementById('livLng').value=this.value"></div>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:6px">üí° Cherchez votre ville sur <a href="https://www.latlong.net" target="_blank" style="color:var(--accent2)">latlong.net</a> pour obtenir les coordonn√©es</div>
    </div><!-- fin customCoordsDiv -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div><label class="fl">Identifiant</label><input class="fi" id="livIdentifiant" placeholder="ahmed" style="margin-top:6px"></div>
      <div><label class="fl">Mot de passe</label><input class="fi" id="livPassword" placeholder="1234" style="margin-top:6px"></div>
    </div>
    <div style="margin-bottom:16px">
      <label class="fl">Couleur</label>
      <div style="display:flex;gap:10px;margin-top:8px;flex-wrap:wrap">
        <div class="color-opt" data-color="#F97316" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#F97316;cursor:pointer;border:3px solid white;box-sizing:border-box"></div>
        <div class="color-opt" data-color="#3B82F6" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#3B82F6;cursor:pointer;border:3px solid transparent;box-sizing:border-box"></div>
        <div class="color-opt" data-color="#10B981" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#10B981;cursor:pointer;border:3px solid transparent;box-sizing:border-box"></div>
        <div class="color-opt" data-color="#8B5CF6" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#8B5CF6;cursor:pointer;border:3px solid transparent;box-sizing:border-box"></div>
        <div class="color-opt" data-color="#EC4899" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#EC4899;cursor:pointer;border:3px solid transparent;box-sizing:border-box"></div>
        <div class="color-opt" data-color="#F59E0B" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#F59E0B;cursor:pointer;border:3px solid transparent;box-sizing:border-box"></div>
        <div class="color-opt" data-color="#EF4444" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#EF4444;cursor:pointer;border:3px solid transparent;box-sizing:border-box"></div>
        <div class="color-opt" data-color="#06B6D4" onclick="selColor(this)" style="width:32px;height:32px;border-radius:8px;background:#06B6D4;cursor:pointer;border:3px solid transparent;box-sizing:border-box"></div>
      </div>
      <input type="hidden" id="livCouleur" value="#F97316">
    </div>
    <button class="btn-p" style="max-width:100%;margin-bottom:10px" onclick="saveLivreur()">‚úÖ Enregistrer le livreur</button>
    <button class="cbtn" onclick="closeMod('addLivModal')">Annuler</button>
  </div>
</div>

<!-- MODAL CONFIRMER SUPPRESSION -->
<div class="mover" id="delLivModal" onclick="closeMod('delLivModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhandle"></div>
    <div class="mtitle" style="color:var(--danger)">üóëÔ∏è Supprimer le livreur</div>
    <div class="msub" id="delLivNom"></div>
    <p style="font-size:14px;color:var(--muted);margin-bottom:20px">Cette action est irr√©versible. Les livraisons seront conserv√©es mais il ne pourra plus se connecter.</p>
    <button class="btn-p" style="max-width:100%;background:linear-gradient(135deg,#EF4444,#DC2626);margin-bottom:10px" onclick="confirmDeleteLivreur()">Supprimer d√©finitivement</button>
    <button class="cbtn" onclick="closeMod('delLivModal')">Annuler</button>
  </div>
</div>

<!-- MODAL FACTURE -->
<div class="mover" id="factureModal" onclick="closeMod('factureModal')">
  <div class="modal" onclick="event.stopPropagation()" style="max-height:95vh;padding:0">
    <div style="padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
      <div>
        <div class="mhandle" style="margin:0 0 8px"></div>
        <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700">üßæ Aper√ßu Facture</div>
      </div>
      <div style="display:flex;gap:8px">
        <button onclick="printFacture()" style="padding:9px 16px;background:var(--accent2);border:none;border-radius:10px;color:white;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer">üñ®Ô∏è Imprimer</button>
        <button onclick="closeMod('factureModal')" style="padding:9px 14px;background:var(--card);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer">‚úï</button>
      </div>
    </div>
    <div style="overflow-y:auto;padding:18px" id="facturePreview"></div>
  </div>
</div>

<!-- MODAL HISTORIQUE FACTURES -->
<div class="mover" id="histFacturesModal" onclick="closeMod('histFacturesModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhandle"></div>
    <div class="mtitle">üßæ Mes factures</div>
    <div class="msub">Appuyez sur une facture pour la r√©imprimer</div>
    <div id="histFacturesList"></div>
    <button class="cbtn" onclick="closeMod('histFacturesModal')" style="margin-top:10px">Fermer</button>
  </div>
</div>

<style>
/* FACTURE PRINT */
.facture-doc{font-family:'DM Sans',sans-serif;color:#1A1A1A;background:white;padding:24px;border-radius:12px;border:1px solid #E8E4DC}
.facture-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;padding-bottom:18px;border-bottom:2px solid #1A1A1A}
.facture-logo{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:#C84B31}
.facture-num{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:#64748B;text-align:right}
.facture-parties{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
.facture-party-title{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#64748B;font-weight:700;margin-bottom:6px}
.facture-party-name{font-family:'Syne',sans-serif;font-size:15px;font-weight:800;margin-bottom:3px}
.facture-party-info{font-size:12px;color:#64748B;margin-bottom:2px}
.facture-table{width:100%;border-collapse:collapse;margin-bottom:18px}
.facture-table th{background:#F8F7F4;padding:10px 12px;text-align:left;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:#64748B;border-bottom:1px solid #E8E4DC}
.facture-table td{padding:11px 12px;font-size:13px;border-bottom:1px solid #F0EDE8;vertical-align:middle}
.facture-table tr:last-child td{border-bottom:none}
.facture-totals{margin-left:auto;width:240px}
.facture-total-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px;border-bottom:1px solid #F0EDE8}
.facture-total-final{display:flex;justify-content:space-between;padding:10px 0;font-family:'Syne',sans-serif;font-size:17px;font-weight:800;border-top:2px solid #1A1A1A;margin-top:4px}
.facture-footer{margin-top:24px;padding-top:16px;border-top:1px solid #E8E4DC;font-size:11px;color:#64748B;text-align:center}
.facture-stamp{display:inline-block;padding:6px 18px;border:2px solid #10B981;color:#10B981;border-radius:6px;font-weight:800;font-size:12px;text-transform:uppercase;letter-spacing:1px;transform:rotate(-3deg)}

@media print {
  body > *:not(#printArea) { display: none !important; }
  #printArea { display: block !important; position: fixed; inset: 0; background: white; z-index: 99999; padding: 20px; }
  .facture-doc { border: none; box-shadow: none; }
}
</style>

<!-- CONFIG MODAL -->
<div class="mover" id="cfgModal" onclick="closeMod('cfgModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhandle"></div>
    <div class="mtitle">‚öôÔ∏è Configuration</div>
    <div class="msub">Supabase + fournisseur de cartes</div>

    <!-- Supabase -->
    <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted);margin-bottom:10px">üóÑÔ∏è Supabase</div>
    <div style="margin-bottom:14px">
      <label class="fl">URL du projet</label>
      <input class="fi" id="sbUrl" placeholder="https://xxxxx.supabase.co" style="margin-top:8px">
    </div>
    <div style="margin-bottom:20px">
      <label class="fl">Cl√© anonyme (anon key)</label>
      <input class="fi" id="sbKey" placeholder="eyJhbGciOiJIUzI1NiIs..." style="margin-top:8px">
    </div>

    <!-- Cartes -->
    <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted);margin-bottom:10px">üó∫Ô∏è Fournisseur de cartes</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px" id="mapProviderBtns">
      <button onclick="selectMapProvider('carto',this)" class="map-prov-btn" style="padding:12px 8px;border-radius:12px;font-size:13px;font-weight:700;cursor:pointer;border:1.5px solid var(--accent);background:rgba(249,115,22,0.1);color:var(--accent)">
        üñ§ CARTO<br><span style="font-size:10px;font-weight:400;color:var(--muted)">Dark &amp; Light ¬∑ Sans cl√©</span>
      </button>
      <button onclick="selectMapProvider('esri',this)" class="map-prov-btn" style="padding:12px 8px;border-radius:12px;font-size:13px;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:var(--card);color:var(--text)">
        üõ∞Ô∏è Esri<br><span style="font-size:10px;font-weight:400;color:var(--muted)">Satellite / Gris ¬∑ Sans cl√©</span>
      </button>
    </div>
    <div style="font-size:11px;color:var(--muted);margin-bottom:16px;padding:10px;background:rgba(16,185,129,0.06);border:1px solid rgba(16,185,129,0.2);border-radius:10px">
      ‚úÖ Ces deux fournisseurs sont <strong>100% gratuits</strong> et ne n√©cessitent <strong>aucune cl√© API</strong>.
    </div>

    <button class="btn-p" style="max-width:100%;margin-bottom:10px" onclick="saveCfg()">üíæ Sauvegarder et connecter</button>
    <button class="cbtn" onclick="closeMod('cfgModal')">Continuer sans Supabase (mode d√©mo)</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ========================================================
     JAVASCRIPT
     ======================================================== -->
<script>
// ============================================================
// SUPABASE CONFIG
// ============================================================
let SB_URL = localStorage.getItem('sb_url') || 'https://axwvlsaytzklefhnplpf.supabase.co';
let SB_KEY = localStorage.getItem('sb_key') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4d3Zsc2F5dHprbGVmaG5wbHBmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMzUyOTUsImV4cCI6MjA4NzcxMTI5NX0.k2YYMx4TAnbcQXWSOdljT3CvI6i0xATV3Ko50pUKB80';
let sb = null;
let useSb = false;

// ============================================================
// PLAN : PRO
// ============================================================
const PLAN = {
  nom: 'Pro',
  badge: 'üîµ Pro',
  couleur: '#3B82F6',
  maxLivreurs: 5,
  maxProduits: 100,
  export: true,
  annonces: true,
  equipe: false,
  commandes_en_ligne: true,
  analytics_avances: false,
  gps_trajet: true,
};

// ‚îÄ‚îÄ V√©rifications de plan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function planCheck(feature, currentCount, max, label) {
  if (max !== Infinity && currentCount >= max) {
    showToast(`üö´ Limite ${label} atteinte (${max} max ‚Äî Plan ${PLAN.nom}). Passez au plan sup√©rieur.`, true);
    return false;
  }
  return true;
}

function planFeatureBlocked(feature) {
  if (!PLAN[feature]) {
    const labels = {
      export: 'Export Excel/CSV',
      annonces: 'Annonces clients',
      equipe: 'Gestion d\'√©quipe',
      commandes_en_ligne: 'Commandes en ligne',
      analytics_avances: 'Analytics avanc√©s',
      gps_trajet: 'Trajet GPS',
    };
    showToast(`üö´ ${labels[feature]||feature} non disponible en plan ${PLAN.nom}. Passez au plan sup√©rieur.`, true);
    return true;
  }
  return false;
}

function applyPlanUI() {
  // Badge plan dans le topbar
  const badge = document.getElementById('planBadge');
  if (badge) {
    badge.textContent = PLAN.badge;
    badge.style.background = PLAN.couleur + '22';
    badge.style.color = PLAN.couleur;
    badge.style.border = '1px solid ' + PLAN.couleur + '44';
  }

  // Cacher les onglets non disponibles
  const tabMap = {
    equipe: !PLAN.equipe,
    annonces: !PLAN.annonces,
    export: !PLAN.export,
    commandes: !PLAN.commandes_en_ligne,
  };
  document.querySelectorAll('#fApp .tab').forEach(tab => {
    const onclick = tab.getAttribute('onclick') || '';
    for (const [key, hidden] of Object.entries(tabMap)) {
      if (onclick.includes("fTab('" + key)) {
        tab.style.display = hidden ? 'none' : '';
      }
    }
  });

  // Limite livreurs : griser le bouton + Livreur si atteinte
  updateAddLivreurBtn();
}

async function updateAddLivreurBtn() {
  const btn = document.querySelector('[onclick="openAddLivreur()"]');
  if (!btn) return;
  if (PLAN.maxLivreurs === Infinity) return;
  let count = 0;
  if (useSb && curUser?.id) {
    const {data} = await sb.from('livreurs').select('id').eq('fournisseur_id', curUser.id);
    count = data?.length || 0;
  } else {
    count = lLivreurs.length;
  }
  if (count >= PLAN.maxLivreurs) {
    btn.disabled = true;
    btn.title = 'Limite atteinte (' + PLAN.maxLivreurs + ' livreurs max ‚Äî Plan ' + PLAN.nom + ')';
    btn.style.opacity = '0.4';
    btn.style.cursor = 'not-allowed';
  } else {
    btn.disabled = false;
    btn.title = '';
    btn.style.opacity = '';
    btn.style.cursor = '';
  }
}


// ============================================================
// CARTE ‚Äî CONFIGURATION TUILES
// ============================================================
// Fournisseur actif : 'esri' | 'carto'
let MAP_PROVIDER  = localStorage.getItem('map_provider') || 'carto';
let tileLayerMain  = null;  // r√©f√©rence couche tuiles carte principale
let tileLayerTrajet = null; // r√©f√©rence couche tuiles carte trajet

// Retourne le L.tileLayer selon le fournisseur ET le th√®me actif
// Fournisseurs : 'esri' | 'carto'  ‚Äî aucune cl√© requise
function getTileLayer() {
  const dark = (document.documentElement.getAttribute('data-theme') || 'dark') === 'dark';

  if (MAP_PROVIDER === 'esri') {
    // Esri World Imagery (satellite) pour dark, Esri Light Gray pour light
    if (dark) {
      return L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        { maxZoom: 19, attribution: '¬© Esri, Maxar, Earthstar Geographics' }
      );
    } else {
      return L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}',
        { maxZoom: 16, attribution: '¬© Esri, HERE, DeLorme, MapmyIndia' }
      );
    }
  }

  // CARTO (d√©faut) ‚Äî gratuit sans cl√©
  const cartoUrl = dark
    ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
    : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
  return L.tileLayer(cartoUrl, {
    maxZoom: 19,
    subdomains: 'abcd',
    attribution: '¬© OpenStreetMap contributors, ¬© CARTO'
  });
}

// ============================================================
// DONN√âES LOCALES (d√©mo)
// ============================================================
let lLivreurs = [
  {id:'l1',nom:'Ahmed Kader',zone:'El Harrach',initiales:'AK',couleur:'#F97316',statut:'actif',livraisons:0,montant:0,lat:36.71,lng:3.13,identifiant:'ahmed',mot_de_passe:'1234'},
  {id:'l2',nom:'Mohamed Amine',zone:'Bab Ezzouar',initiales:'MA',couleur:'#3B82F6',statut:'actif',livraisons:0,montant:0,lat:36.73,lng:3.19,identifiant:'mohamed',mot_de_passe:'1234'},
  {id:'l3',nom:'Youcef Benali',zone:'Kouba',initiales:'YB',couleur:'#10B981',statut:'pause',livraisons:0,montant:0,lat:36.74,lng:3.07,identifiant:'youcef',mot_de_passe:'1234'},
];
let lFournisseurs = [{id:'f1',nom:'Mon Entreprise',identifiant:'admin',mot_de_passe:'1234'}];
let lProduits = [
  {id:'p1',nom:'Huile v√©g√©tale 5L',icone:'ü´ô',quantite:120,unite:'bouteilles',couleur:'#F97316',prix:850},
  {id:'p2',nom:'Semoule fine 5kg',icone:'üåæ',quantite:80,unite:'sacs',couleur:'#F59E0B',prix:420},
  {id:'p3',nom:'Sucre 2kg',icone:'üç¨',quantite:200,unite:'paquets',couleur:'#EC4899',prix:180},
  {id:'p4',nom:'Farine T55 25kg',icone:'üåø',quantite:45,unite:'sacs',couleur:'#10B981',prix:2800},
];
let lLivraisons = [];
let lClients = [];
let lStock = []; // mouvements de stock

// ============================================================
// STATE
// ============================================================
let curUser = null;
let curLivreur = null;
let selectedRole = 'fournisseur';
let chkProds = {};
let gpsCoords = null;
let gpsWatchId = null;
let camionProduits = []; // produits charg√©s sur ce livreur aujourd'hui

// ============================================================
// ============================================================
// MODE HORS LIGNE ‚Äî IndexedDB + sync automatique
// ============================================================
const DB_NAME    = 'delitrack_offline';
const DB_VERSION = 1;
const STORE_LIVRAISONS = 'pending_livraisons';
const STORE_FACTURES   = 'pending_factures';

let offlineDB = null;
let isOnline   = navigator.onLine;

// ‚îÄ‚îÄ Ouvrir la base IndexedDB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openOfflineDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_LIVRAISONS)) {
        db.createObjectStore(STORE_LIVRAISONS, { keyPath: '_offlineId' });
      }
      if (!db.objectStoreNames.contains(STORE_FACTURES)) {
        db.createObjectStore(STORE_FACTURES, { keyPath: '_offlineId' });
      }
    };
    req.onsuccess = e => { offlineDB = e.target.result; resolve(offlineDB); };
    req.onerror   = e => reject(e.target.error);
  });
}

// ‚îÄ‚îÄ Sauvegarder une livraison localement ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveOffline(livraison, facture) {
  return new Promise((resolve, reject) => {
    if (!offlineDB) { reject('DB non ouverte'); return; }
    const tx = offlineDB.transaction([STORE_LIVRAISONS, STORE_FACTURES], 'readwrite');
    tx.objectStore(STORE_LIVRAISONS).put(livraison);
    tx.objectStore(STORE_FACTURES).put(facture);
    tx.oncomplete = () => resolve();
    tx.onerror    = e => reject(e.target.error);
  });
}

// ‚îÄ‚îÄ Lire les livraisons en attente ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getPendingLivraisons() {
  return new Promise((resolve, reject) => {
    if (!offlineDB) { resolve([]); return; }
    const tx  = offlineDB.transaction(STORE_LIVRAISONS, 'readonly');
    const req = tx.objectStore(STORE_LIVRAISONS).getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror   = () => resolve([]);
  });
}
function getPendingFactures() {
  return new Promise((resolve, reject) => {
    if (!offlineDB) { resolve([]); return; }
    const tx  = offlineDB.transaction(STORE_FACTURES, 'readonly');
    const req = tx.objectStore(STORE_FACTURES).getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror   = () => resolve([]);
  });
}

// ‚îÄ‚îÄ Supprimer apr√®s sync r√©ussie ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function deleteOfflineRecord(store, id) {
  return new Promise(resolve => {
    if (!offlineDB) { resolve(); return; }
    const tx = offlineDB.transaction(store, 'readwrite');
    tx.objectStore(store).delete(id);
    tx.oncomplete = () => resolve();
    tx.onerror    = () => resolve();
  });
}

// ‚îÄ‚îÄ Compter les enregistrements en attente ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function countPending() {
  const livs = await getPendingLivraisons();
  return livs.length;
}

// ‚îÄ‚îÄ Mettre √† jour le badge offline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function updateOfflineBadge() {
  const n = await countPending();
  const badge = document.getElementById('offlineBadge');
  if (!badge) return;
  if (n > 0) {
    badge.textContent  = `${n} hors ligne`;
    badge.style.display = 'inline-flex';
  } else {
    badge.style.display = 'none';
  }
}

// ‚îÄ‚îÄ Synchroniser tout ce qui est en attente ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function syncPending() {
  if (!useSb || !isOnline) return;
  const livraisons = await getPendingLivraisons();
  const factures   = await getPendingFactures();
  if (!livraisons.length) return;

  showToast(`üîÑ Synchronisation de ${livraisons.length} livraison(s)‚Ä¶`);

  let synced = 0;
  for (const liv of livraisons) {
    const { _offlineId, ...livData } = liv;
    try {
      // Ins√©rer commer√ßant
      await sb.from('commer√ßants').upsert(
        { nom: livData.client_nom, telephone: livData.client_phone,
          adresse: livData.client_adresse, livreur_id: livData.livreur_id },
        { onConflict: 'telephone', ignoreDuplicates: false }
      );
      // Ins√©rer livraison
      const { data: livResult, error: livErr } = await sb.from('livraisons')
        .insert(livData).select().single();
      if (livErr) continue;

      const livId = livResult?.id;

      // Trouver la facture correspondante
      const fac = factures.find(f => f._offlineId === _offlineId);
      if (fac) {
        const { _offlineId: _fid, ...facData } = fac;
        await sb.from('factures').insert({ ...facData, livraison_id: livId });
        await deleteOfflineRecord(STORE_FACTURES, _offlineId);
      }

      await deleteOfflineRecord(STORE_LIVRAISONS, _offlineId);
      synced++;
    } catch (e) {
      console.warn('Sync √©chou√© pour', _offlineId, e);
    }
  }

  if (synced > 0) {
    showToast(`‚úÖ ${synced} livraison(s) synchronis√©e(s) !`);
    await loadMyDeliveries();
    await loadMyClients();
    await loadCredits();
  }
  await updateOfflineBadge();
}

// ‚îÄ‚îÄ Indicateur visuel de connectivit√© ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setConnectivityUI(online) {
  isOnline = online;
  const bar = document.getElementById('offlineBar');
  if (!bar) return;
  if (!online) {
    bar.style.display    = 'flex';
    bar.style.background = 'rgba(239,68,68,0.9)';
    bar.textContent      = 'üìµ Hors ligne ‚Äî les livraisons seront synchronis√©es √† la reconnexion';
  } else {
    bar.style.display    = 'flex';
    bar.style.background = 'rgba(16,185,129,0.9)';
    bar.textContent      = '‚úÖ Connexion r√©tablie ‚Äî synchronisation en cours‚Ä¶';
    setTimeout(() => { bar.style.display = 'none'; }, 3000);
    syncPending();
  }
}

// ‚îÄ‚îÄ √âcouter les √©v√©nements r√©seau ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('online',  () => setConnectivityUI(true));
window.addEventListener('offline', () => setConnectivityUI(false));

// INIT
// ============================================================
window.addEventListener('load', () => {
  // Timeout de s√©curit√© : max 4 secondes puis on d√©marre quoi qu'il arrive
  const safeStart = setTimeout(() => {
    hideLoad();
    initApp();
  }, 4000);

  // V√©rifier si les scripts sont charg√©s
  function checkReady() {
    const sbOk = typeof window.supabase !== 'undefined';
    const xlsxOk = typeof XLSX !== 'undefined';
    if (sbOk && xlsxOk) {
      clearTimeout(safeStart);
      hideLoad();
      initApp();
    } else {
      setTimeout(checkReady, 200);
    }
  }
  checkReady();
});

async function initApp() {
  setTxt('D√©marrage...');
  // Ouvrir IndexedDB pour le mode offline
  await openOfflineDB().catch(e => console.warn('IndexedDB non disponible:', e));
  if (SB_URL && SB_KEY) await initSb();
  if (useSb) document.getElementById('configBanner').classList.remove('show');
  // V√©rifier l'√©tat r√©seau initial
  if (!navigator.onLine) setConnectivityUI(false);
  const ep = document.getElementById('exportPeriod');
  if (ep) ep.addEventListener('change', e => {
    document.getElementById('customDates').style.display = e.target.value === 'custom' ? 'block' : 'none';
  });
}

async function initSb() {
  try {
    setTxt('Connexion Supabase...');
    if (!window.supabase) throw new Error('SDK Supabase non charg√©');
    sb = window.supabase.createClient(SB_URL, SB_KEY, {
      realtime: {
        params: { eventsPerSecond: 10 }
      },
      global: {
        headers: { 'X-Client-Info': 'delitrack/1.0' }
      }
    });
    const {data, error} = await sb.from('livreurs').select('id').limit(1);
    if (error) throw error;
    useSb = true;
    const banner = document.getElementById('configBanner');
    if (banner) banner.classList.remove('show');
    showToast('Supabase connect√© ‚úì');
    const hint = document.getElementById('demoHint');
    if (hint) hint.style.display = 'none';
    console.log('‚úÖ Supabase connect√© avec succ√®s');
  } catch(e) {
    useSb = false;
    const msg = e.message || String(e);
    console.error('‚ùå Erreur Supabase:', msg);
    console.log('URL utilis√©e:', SB_URL);
    console.log('Cl√© (d√©but):', SB_KEY?.substring(0,20)+'...');
    // Afficher l'erreur dans l'UI
    const banner = document.getElementById('configBanner');
    if (banner) {
      banner.classList.add('show');
      banner.textContent = '‚ö†Ô∏è Erreur connexion Supabase ‚Äî v√©rifiez l\'URL et la cl√© API (' + msg.substring(0,80) + ')';
    }
  }
}

function setTxt(t){const e=document.getElementById('loadTxt');if(e)e.textContent=t}
function hideLoad(){const e=document.getElementById('loadingScreen');e.classList.add('hide');setTimeout(()=>e.remove(),500)}

// ============================================================
// CONFIG
// ============================================================
function showCfg(){
  // Pr√©-remplir les valeurs sauvegard√©es
  document.getElementById('sbUrl').value = SB_URL;
  document.getElementById('sbKey').value = SB_KEY;
  // Surligner le provider actif
  document.querySelectorAll('.map-prov-btn').forEach(b => {
    b.style.borderColor = 'var(--border)';
    b.style.background = 'var(--card)';
    b.style.color = 'var(--text)';
  });
  // Mettre √† jour l'UI avec le provider actif
  updateMapProviderUI(MAP_PROVIDER);
  document.getElementById('cfgModal').classList.add('open');
}

function selectMapProvider(provider, btn){
  MAP_PROVIDER = provider;
  document.querySelectorAll('.map-prov-btn').forEach(b => {
    b.style.borderColor='var(--border)'; b.style.background='var(--card)'; b.style.color='var(--text)';
  });
  if(btn){ btn.style.borderColor='var(--accent)'; btn.style.background='rgba(249,115,22,0.1)'; btn.style.color='var(--accent)'; }
}

function updateMapProviderUI(provider){
  // Plus de champs de cl√© ‚Äî rien √† afficher/cacher
  document.querySelectorAll('.map-prov-btn').forEach(b => {
    b.style.borderColor='var(--border)'; b.style.background='var(--card)'; b.style.color='var(--text)';
  });
  // Activer le bouton du provider actif
  const btns = document.querySelectorAll('.map-prov-btn');
  btns.forEach(b => {
    if((provider==='carto' && b.textContent.includes('CARTO')) ||
       (provider==='esri'  && b.textContent.includes('Esri'))) {
      b.style.borderColor='var(--accent)'; b.style.background='rgba(249,115,22,0.1)'; b.style.color='var(--accent)';
    }
  });
}

async function saveCfg(){
  const u = document.getElementById('sbUrl').value.trim();
  const k = document.getElementById('sbKey').value.trim();
  // Sauvegarder le choix de la carte
  localStorage.setItem('map_provider', MAP_PROVIDER);

  // 2. On met √† jour Leaflet en direct avec le nouveau fond de carte
  if(leafletMap){
    if(tileLayerMain) leafletMap.removeLayer(tileLayerMain);
    tileLayerMain = getTileLayer();
    tileLayerMain.addTo(leafletMap);
  }
  if(trajetMap){
    if(tileLayerTrajet) trajetMap.removeLayer(tileLayerTrajet);
    tileLayerTrajet = getTileLayer();
    tileLayerTrajet.addTo(trajetMap);
  }

  // 3. Si Supabase est vide, on arr√™te ici (la carte est quand m√™me sauv√©e !)
  if(!u || !k){
    closeMod('cfgModal');
    showToast('‚úÖ Carte mise √† jour (Mode sans base de donn√©es)');
    return;
  }

  // 4. Si Supabase est rempli, on sauvegarde la suite
  SB_URL=u; SB_KEY=k;
  localStorage.setItem('sb_url', u);
  localStorage.setItem('sb_key', k);

  closeMod('cfgModal');
  await initSb();
  if(!useSb) showToast('‚ùå Cl√©s Supabase incorrectes', true);
  else showToast('‚úÖ Configuration compl√®te sauvegard√©e');

}

// ============================================================
// LOGIN
// ============================================================
function selRole(r,el){
  selectedRole=r;
  document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
}

async function doLogin(){
  const u=document.getElementById('loginUser').value.trim();
  const p=document.getElementById('loginPass').value.trim();
  const roleId = document.querySelector('.role-btn.selected')?.id;
  const role = roleId==='roleL' ? 'livreur' : roleId==='roleC' ? 'client'
    : selectedRole==='admin' ? 'admin' : 'fournisseur';
  if(!u||!p){showErr('Remplissez tous les champs');return}

  if(useSb){
    if(role==='fournisseur'){
      const {data,error}=await sb.rpc('login_fournisseur',{p_identifiant:u, p_mot_de_passe:p});
      if(error||!data?.length){showErr('Identifiant ou mot de passe incorrect');return}
      const f=data[0];
      // V√©rifier abonnement
      if(f.abonnement_statut==='expire'){showErr('‚ö†Ô∏è Votre abonnement a expir√©. Contactez l\'administrateur.');return}
      if(f.abonnement_statut==='suspendu'){showErr('‚ö†Ô∏è Compte suspendu. Contactez l\'administrateur.');return}
      curUser=f; enterF();
    } else if(role==='livreur'){
      const {data,error}=await sb.rpc('login_livreur',{p_identifiant:u, p_mot_de_passe:p});
      if(error||!data?.length){showErr('Identifiant ou mot de passe incorrect');return}
      curUser=data[0]; curLivreur=data[0]; enterL();
    } else if(role==='client'){ // commer√ßant
      const {data,error}=await sb.rpc('login_client',{p_identifiant:u, p_mot_de_passe:p});
      if(error||!data?.length){showErr('Identifiant ou mot de passe incorrect');return}
      const c=data[0];
      // V√©rifier abonnement commer√ßant
      if(c.abonnement_statut==='inactif'){showErr('‚ö†Ô∏è Votre compte est en attente d\'activation. Contactez votre fournisseur.');return}
      if(c.abonnement_statut==='expire'){showErr('‚ö†Ô∏è Votre abonnement a expir√©. Contactez votre fournisseur.');return}
      curClient=c; enterC();
    } else {
      const {data,error}=await sb.rpc('login_admin',{p_identifiant:u, p_mot_de_passe:p});
      if(error||!data?.length){showErr('Acc√®s administrateur refus√©');return}
      curAdmin=data[0]; enterAdmin();
    }
  } else {
    if(role==='fournisseur'){
      const f=lFournisseurs.find(x=>x.identifiant===u&&x.mot_de_passe===p);
      if(!f){showErr('D√©mo: admin / 1234');return}
      curUser=f; enterF();
    } else if(role==='livreur'){
      const l=lLivreurs.find(x=>x.identifiant===u&&x.mot_de_passe===p);
      if(!l){showErr('Mode d√©mo ‚Äî Livreur 1 : ahmed / 1234   |   Livreur 2 : mohamed / 1234');return}
      curUser=l; curLivreur=l; enterL();
    } else {
      // Admin d√©mo local
      if(u==='delitrack'&&p==='admin2025!'){
        curAdmin={id:'sa1',nom:'Super Admin',identifiant:'delitrack'};
        enterAdmin();
      } else {
        showErr('Admin (Supabase) : delitrack / admin2025!');
      }
    }
  }
}

function showErr(m){const e=document.getElementById('loginErr');e.textContent=m;e.style.display='block'}
function enterF(){document.getElementById('login').classList.remove('active');document.getElementById('fApp').classList.add('active');initF()}
function enterL(){document.getElementById('login').classList.remove('active');document.getElementById('lApp').classList.add('active');document.getElementById('lWelcome').textContent=curLivreur?.nom||'Livreur';initL()}

async function initF(){
  applyPlanUI();
  await loadLivreurs();
  await loadAllDeliveries();
  await loadStock();
  await loadEquipe();
  await loadAllClients();
  //updateStats();
  updateResumeStats();
  // Laisser le navigateur peindre fApp avant d'initialiser Leaflet
  setTimeout(() => initMap(), 0);
  if(useSb) subRealtime();
  // Charger badge commandes en attente
  if(useSb && curUser?.id){
    const{data}=await sb.from('commandes').select('id').eq('fournisseur_id',curUser.id).eq('statut','en_attente');
    const badge=document.getElementById('cmdBadge');
    if(badge&&data){badge.textContent=data.length;badge.style.display=data.length>0?'inline-flex':'none'}
  }
}

// ============================================================
// TH√àME CLAIR / SOMBRE
// ============================================================
function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('theme', theme);
  // Mettre √† jour la meta theme-color du navigateur
  document.getElementById('metaThemeColor').content = theme === 'light' ? '#F1F5F9' : '#0A0E1A';
  // Mettre √† jour les ic√¥nes des boutons toggle
  document.querySelectorAll('.theme-toggle-btn').forEach(btn => {
    btn.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    btn.title = theme === 'light' ? 'Passer en mode sombre' : 'Passer en mode clair';
  });
  // Recharger les tuiles de carte si elles existent
  if (leafletMap && tileLayerMain) {
    leafletMap.removeLayer(tileLayerMain);
    tileLayerMain = getTileLayer();
    tileLayerMain.addTo(leafletMap);
  }
  if (trajetMap && tileLayerTrajet) {
    trajetMap.removeLayer(tileLayerTrajet);
    tileLayerTrajet = getTileLayer();
    tileLayerTrajet.addTo(trajetMap);
  }
  // --- Rafra√Æchissement dynamique de la carte ---
  if (typeof leafletMap !== 'undefined' && leafletMap) {
    if (tileLayerMain) leafletMap.removeLayer(tileLayerMain);
    tileLayerMain = getTileLayer();
    tileLayerMain.addTo(leafletMap);
  }
  
  if (typeof trajetMap !== 'undefined' && trajetMap) {
    if (tileLayerTrajet) trajetMap.removeLayer(tileLayerTrajet);
    tileLayerTrajet = getTileLayer();
    tileLayerTrajet.addTo(trajetMap);
  }
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme') || 'dark';
  applyTheme(current === 'dark' ? 'light' : 'dark');
}

// Appliquer le th√®me sauvegard√© au chargement
(function() {
  const saved = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
  document.getElementById('metaThemeColor').content = saved === 'light' ? '#F1F5F9' : '#0A0E1A';
  // Mettre √† jour les ic√¥nes une fois le DOM charg√©
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.theme-toggle-btn').forEach(btn => {
      btn.textContent = saved === 'light' ? 'üåô' : '‚òÄÔ∏è';
      btn.title = saved === 'light' ? 'Passer en mode sombre' : 'Passer en mode clair';
    });
  });
})();

function logout(){
  stopGPS();
  curUser=curLivreur=curClient=null;
  panier={};
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('login').classList.add('active');
  document.getElementById('loginErr').style.display='none';
}

// ============================================================
// CHANGEMENT MOT DE PASSE
// ============================================================
function openChangeMdp(){
  // D√©tecter l'utilisateur connect√© et son r√¥le
  const who = curUser ? `Fournisseur : ${curUser.nom}`
             : curLivreur ? `Livreur : ${curLivreur.nom}`
             : curClient ? `Client : ${curClient.nom}` : '';
  document.getElementById('changeMdpSub').textContent = who;
  document.getElementById('mdpAncien').value = '';
  document.getElementById('mdpNouveau').value = '';
  document.getElementById('mdpConfirm').value = '';
  document.getElementById('changeMdpErr').style.display = 'none';
  document.getElementById('mdpStrengthBar').style.width = '0%';
  document.getElementById('mdpStrengthLabel').textContent = '';
  document.getElementById('changeMdpBtn').disabled = false;
  document.getElementById('changeMdpBtn').textContent = 'üîë Modifier le mot de passe';
  document.getElementById('changeMdpModal').classList.add('open');
}

function toggleMdpVis(inputId, btn){
  const inp = document.getElementById(inputId);
  if(inp.type === 'password'){ inp.type = 'text'; btn.textContent = 'üôà'; }
  else { inp.type = 'password'; btn.textContent = 'üëÅ'; }
}

function checkMdpStrength(val){
  const bar = document.getElementById('mdpStrengthBar');
  const lbl = document.getElementById('mdpStrengthLabel');
  if(!val){ bar.style.width='0%'; lbl.textContent=''; return; }
  let score = 0;
  if(val.length >= 6) score++;
  if(val.length >= 10) score++;
  if(/[A-Z]/.test(val)) score++;
  if(/[0-9]/.test(val)) score++;
  if(/[^A-Za-z0-9]/.test(val)) score++;
  const levels = [
    {w:'20%', bg:'var(--danger)',   txt:'Tr√®s faible'},
    {w:'40%', bg:'#F97316',         txt:'Faible'},
    {w:'60%', bg:'var(--yellow)',   txt:'Moyen'},
    {w:'80%', bg:'#84CC16',         txt:'Fort'},
    {w:'100%',bg:'var(--accent3)',  txt:'Tr√®s fort'},
  ];
  const l = levels[Math.min(score-1, 4)] || levels[0];
  bar.style.width = l.w; bar.style.background = l.bg;
  lbl.textContent = l.txt; lbl.style.color = l.bg;
}

async function doChangerMdp(){
  const ancien  = document.getElementById('mdpAncien').value;
  const nouveau = document.getElementById('mdpNouveau').value;
  const confirm = document.getElementById('mdpConfirm').value;
  const errEl   = document.getElementById('changeMdpErr');
  const btn     = document.getElementById('changeMdpBtn');

  const showErr = msg => { errEl.textContent = msg; errEl.style.display = 'block'; };
  errEl.style.display = 'none';

  if(!ancien)           { showErr('‚ö†Ô∏è Entrez votre ancien mot de passe'); return; }
  if(nouveau.length < 6){ showErr('‚ö†Ô∏è Le nouveau mot de passe doit faire au moins 6 caract√®res'); return; }
  if(nouveau !== confirm){ showErr('‚ö†Ô∏è Les deux mots de passe ne correspondent pas'); return; }
  if(ancien === nouveau)  { showErr('‚ö†Ô∏è Le nouveau mot de passe doit √™tre diff√©rent de l\'ancien'); return; }

  btn.disabled = true; btn.textContent = '‚è≥ Modification...';

  // D√©terminer table et id
  let table, id;
  if(curUser)    { table = 'fournisseurs'; id = curUser.id; }
  else if(curLivreur) { table = 'livreurs';     id = curLivreur.id; }
  else if(curClient)  { table = 'commer√ßants';       id = curClient.id; }
  else { showErr('‚ùå Session expir√©e, reconnectez-vous'); btn.disabled=false; btn.textContent='üîë Modifier'; return; }

  if(!useSb){
    // Mode d√©mo local
    btn.disabled = false; btn.textContent = 'üîë Modifier le mot de passe';
    closeMod('changeMdpModal');
    showToast('‚úÖ Mot de passe modifi√© (d√©mo)');
    return;
  }

  const { data, error } = await sb.rpc('changer_mdp_utilisateur', {
    p_ancien_mdp:  ancien,
    p_id:          id,
    p_nouveau_mdp: nouveau,
    p_table:       table,
  });

  btn.disabled = false; btn.textContent = 'üîë Modifier le mot de passe';

  if(error){ showErr('‚ùå Erreur : ' + error.message); return; }

  const result = Array.isArray(data) ? data[0] : data;
  if(result === 'OK'){
    closeMod('changeMdpModal');
    showToast('‚úÖ Mot de passe modifi√© avec succ√®s');
  } else if(result === 'ANCIEN_MDP_INCORRECT'){
    showErr('‚ùå L\'ancien mot de passe est incorrect');
  } else if(result === 'MDP_TROP_COURT'){
    showErr('‚ö†Ô∏è Le nouveau mot de passe est trop court (minimum 6 caract√®res)');
  } else if(result === 'UTILISATEUR_INTROUVABLE'){
    showErr('‚ùå Utilisateur introuvable');
  } else {
    showErr('‚ùå Erreur inattendue : ' + result);
  }
}

// ============================================================
// FOURNISSEUR INIT (legacy - merged above)
// ============================================================

// ============================================================
// LIVREURS
// ============================================================
async function loadLivreurs(){
  let livs = lLivreurs;
  if(useSb){
    const {data}=await sb.from('livreurs').select('*');
    if(data) livs=data;
    const today=new Date().toISOString().split('T')[0];
    for(const l of livs){
      const {data:d}=await sb.from('livraisons').select('montant').eq('livreur_id',l.id).gte('created_at',today);
      if(d){l.livraisons=d.length;l.montant=d.reduce((s,x)=>s+(x.montant||0),0)}
    }
  }
  renderLivreurs(livs);
  updateStats(livs);
}

function renderLivreurs(livs){
  document.getElementById('totalLiv').textContent=livs.length;
  const sm={actif:'sa',pause:'sp',termine:'sd',active:'sa',done:'sd'};
  const pm={actif:'pa',pause:'pp',termine:'pd',active:'pa',done:'pd'};
  const lm={actif:'En route',pause:'En pause',termine:'Termin√©',active:'En route',done:'Termin√©'};
  document.getElementById('livreursList').innerHTML=livs.map(l=>{
    const st=l.statut||l.status||'actif';
    const ini=l.initiales||l.nom?.substring(0,2).toUpperCase()||'??';
    const col=l.couleur||'#F97316';
    return `<div class="lcard ${sm[st]||'sa'} ai" onclick="showLivModal('${l.id}')">
      <div class="lhdr">
        <div class="avatar" style="background:${col}22;color:${col}">${ini}</div>
        <div class="linfo"><div class="lname">${l.nom}</div><div class="lzone">üìç ${l.zone||''}</div></div>
        <span class="spill ${pm[st]||'pa'}">${lm[st]||'En route'}</span>
      </div>
      <div class="lstats">
        <div class="mstat"><div class="msv" style="color:var(--accent)">${l.livraisons||0}</div><div class="msl">Livraisons</div></div>
        <div class="mstat"><div class="msv" style="color:var(--accent3)">${((l.montant||0)/1000).toFixed(1)}k</div><div class="msl">DA</div></div>
        <div class="mstat"><div class="msv">${st==='actif'||st==='active'?'üü¢':st==='pause'?'üü°':'‚ö™'}</div><div class="msl">Statut</div></div>
      </div>
    </div>`;
  }).join('');

  // Remplir select chargement
  const sel=document.getElementById('chargLivreur');
  sel.innerHTML='<option value="">S√©lectionner un livreur</option>'+livs.map(l=>`<option value="${l.id}">${l.nom}</option>`).join('');
}

function updateStats(livs){
  const a=livs.filter(l=>(l.statut||l.status)==='actif'||(l.statut||l.status)==='active').length;
  const tl=livs.reduce((s,l)=>s+(l.livraisons||0),0);
  const tm=livs.reduce((s,l)=>s+(l.montant||0),0);
  document.getElementById('stA').textContent=a;
  document.getElementById('stL').textContent=tl;
  document.getElementById('stM').textContent=tm>=1000?(tm/1000).toFixed(0)+'k':tm;
  document.getElementById('activeCount').textContent=a;
}

// ============================================================
// LIVRAISONS
// ============================================================
async function loadAllDeliveries(){
  let livs=lLivraisons;
  if(useSb){
    const today=new Date().toISOString().split('T')[0];
    const {data}=await sb.from('livraisons').select('*,livreurs(nom)').gte('created_at',today).order('created_at',{ascending:false});
    if(data) livs=data;
  }
  const c=document.getElementById('allDeliveries');
  if(!livs.length){c.innerHTML='<div class="empty"><div class="eico">üì¶</div>Aucune livraison aujourd\'hui</div>';return}
  c.innerHTML=livs.map(d=>`
    <div class="hcard ai">
      <div class="hcli">${d.client_nom||d.client||''}</div>
      <div class="htim">üöö ${d.livreurs?.nom||d.livreur||''} ¬∑ ${fmtTime(d.created_at||d.heure)}</div>
      <div class="hdet">üì¶ ${d.produits||''}</div>
      <div class="hdet">üìç ${d.lat?Number(d.lat).toFixed(5):''}, ${d.lng?Number(d.lng).toFixed(5):''}</div>
      <div style="font-size:13px;font-weight:700;color:var(--accent3);margin-top:8px">${(d.montant||0).toLocaleString()} DA ¬∑ ${d.mode_paiement||''}</div>
    </div>`).join('');
}

// ============================================================
// STOCK
// ============================================================
async function loadStock(){
  let prods=lProduits;
  if(useSb){
    const {data}=await sb.from('produits').select('*');
    if(data){ lProduits=data; prods=data; }  // ‚Üê mettre √† jour lProduits aussi
  }
  renderStock(prods);
  // Remplir selects
  const s=document.getElementById('approvProduit');
  s.innerHTML='<option value="">S√©lectionner un produit</option>'+prods.map(p=>`<option value="${p.id}">${p.nom}</option>`).join('');
  renderChargProduits(prods);
}

function renderStock(prods){
  if(!prods.length){document.getElementById('stockList').innerHTML='<div class="empty"><div class="eico">üì¶</div>Aucun produit</div>';return}
  const maxQ=Math.max(...prods.map(p=>p.quantite||0),1);
  document.getElementById('stockList').innerHTML=`
    <div class="fsec">
      ${prods.map(p=>{
        const pct=Math.min(100,Math.round(((p.quantite||0)/maxQ)*100));
        const col=pct>50?'var(--accent3)':pct>20?'var(--yellow)':'var(--danger)';
        return `<div class="stock-row" style="flex-wrap:wrap;gap:6px">
          <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0">
            ${p.image
              ? `<img src="${p.image}" class="prod-thumb" alt="${p.nom}">`
              : `<div class="prod-thumb-icon">${p.icone||'üì¶'}</div>`}
            <div style="min-width:0">
              <div style="font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.nom}</div>
              <div style="font-size:11px;color:var(--muted)">${p.unite||''}</div>
              <div style="font-size:12px;color:var(--accent);font-weight:700">${p.prix?(p.prix).toLocaleString()+' DA/'+p.unite:'‚Äî DA'}</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
            <div class="stock-bar" style="width:80px"><div class="stock-fill" style="width:${pct}%;background:${col}"></div></div>
            <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:800;color:${col};min-width:40px;text-align:right">${p.quantite||0}</div>
            <button onclick="openEditProduit('${p.id}')" style="padding:5px 8px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:8px;color:var(--accent2);font-size:13px;cursor:pointer" title="Modifier">‚úèÔ∏è</button>
            <button onclick="deleteProduit('${p.id}','${p.nom.replace(/'/g,'')}')" style="padding:5px 8px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;color:var(--danger);font-size:13px;cursor:pointer" title="Supprimer">üóëÔ∏è</button>
          </div>
        </div>`;
      }).join('')}
    </div>`;
}

function renderChargProduits(prods){
  const disponibles = prods.filter(p => (p.quantite||0) > 0);
  if(!disponibles.length){
    document.getElementById('chargProduits').innerHTML=
      '<div style="color:var(--muted);font-size:13px;text-align:center;padding:16px 0">Aucun produit en stock disponible</div>';
    return;
  }
  document.getElementById('chargProduits').innerHTML=disponibles.map(p=>`
    <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:18px;flex-shrink:0">${p.icone||'üì¶'}</span>
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:500">${p.nom}</div>
        <div style="font-size:11px;color:var(--muted)">Disponible : <strong style="color:var(--accent3)">${p.quantite}</strong> ${p.unite||''}</div>
      </div>
      <input class="cqin" type="number" id="charg-${p.id}" placeholder="0" min="0" max="${p.quantite||0}" style="width:72px">
    </div>`).join('');
}


// ‚îÄ‚îÄ IMAGE PRODUIT ‚Äî pr√©visualisation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function previewProdImg(input, previewId, badgeId, dataId) {
  const file = input.files[0];
  if (!file) return;
  // Compresser en base64 max ~200KB
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const MAX = 600;
      let w = img.width, h = img.height;
      if (w > MAX) { h = Math.round(h * MAX / w); w = MAX; }
      if (h > MAX) { w = Math.round(w * MAX / h); h = MAX; }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      const data = canvas.toDataURL('image/jpeg', 0.75);
      document.getElementById(dataId).value = data;
      const prev = document.getElementById(previewId);
      prev.innerHTML = `<img src="${data}" alt="produit">`;
      const badge = document.getElementById(badgeId);
      if (badge) { badge.style.display = 'block'; }
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function openAddProduct(){document.getElementById('addProdModal').classList.add('open')}

async function saveNewProduct(){
  // V√©rifier limite produits
  if (PLAN.maxProduits !== Infinity) {
    const currentProds = lProduits.length || document.querySelectorAll('#stockList .hcard').length;
    if (!planCheck('maxProduits', currentProds, PLAN.maxProduits, 'produits')) return;
  }
  const nom       = document.getElementById('newProdNom').value.trim();
  const unite     = document.getElementById('newProdUnite').value.trim()||'unit√©s';
  const stock     = parseInt(document.getElementById('newProdStock').value)||0;
  const prix      = parseInt(document.getElementById('newProdPrix').value)||0;
  const image     = document.getElementById('newProdImgData').value || null;
  const condType  = document.getElementById('newProdCondType').value || null;
  const condQty   = parseInt(document.getElementById('newProdCondQty').value)||null;
  if(!nom){showToast('‚ö†Ô∏è Entrez le nom du produit',true);return}

  const prod = {nom, icone:'üì¶', unite, quantite:stock, couleur:'#F97316', prix, image, cond_type:condType, cond_qty:condQty};
  if(useSb){
    const {data,error}=await sb.from('produits').insert(prod).select().single();
    if(error){showToast('‚ùå Erreur: '+error.message,true);return}
    if(stock>0) await sb.from('mouvements_stock').insert({produit_id:data.id,type:'entree',quantite:stock,note:'Stock initial'});
  } else {
    prod.id='p'+Date.now();
    lProduits.push(prod);
  }
  // Reset formulaire
  ['newProdNom','newProdUnite','newProdStock','newProdPrix','newProdImgData','newProdCondQty'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  const sel=document.getElementById('newProdCondType'); if(sel)sel.value='';
  const prev=document.getElementById('newProdImgPreview');
  if(prev) prev.innerHTML='<div class="prod-img-placeholder"><span>üì∑</span>Appuyer pour ajouter une photo</div><div class="prod-img-badge" style="display:none" id="newProdImgBadge">‚úì Photo ajout√©e</div>';
  closeMod('addProdModal');
  await loadStock();
  showToast('Produit ajout√© ‚úì');
}

// ‚îÄ‚îÄ √âdition produit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openEditProduit(id) {
  const prod = lProduits.find(p => String(p.id) === String(id));
  if (!prod) return;
  document.getElementById('editProdId').value = id;
  document.getElementById('editProdNom').value = prod.nom || '';
  document.getElementById('editProdUnite').value = prod.unite || '';
  document.getElementById('editProdPrixActuel').textContent = prod.prix ? prod.prix.toLocaleString() + ' DA' : '‚Äî DA';
  document.getElementById('editProdNouveauPrix').value = prod.prix || '';
  document.getElementById('editProdNote').value = '';
  // Conditionnement
  const ctEl = document.getElementById('editProdCondType');
  const cqEl = document.getElementById('editProdCondQty');
  if (ctEl) ctEl.value = prod.cond_type || '';
  if (cqEl) cqEl.value = prod.cond_qty || '';
  // Image
  document.getElementById('editProdImgData').value = prod.image || '';
  const prev = document.getElementById('editProdImgPreview');
  if (prev) {
    if (prod.image) {
      prev.innerHTML = `<img src="${prod.image}" alt="${prod.nom}" style="width:100%;height:100%;object-fit:cover;border-radius:12px">`;
    } else {
      prev.innerHTML = '<div class="prod-img-placeholder" style="flex-direction:row;gap:8px"><span style="font-size:22px">üì∑</span><span>Changer la photo</span></div><div class="prod-img-badge" style="display:none" id="editProdImgBadge">‚úì Modifi√©e</div>';
    }
  }
  await loadHistoriquePrix(id);
  document.getElementById('editProdModal').classList.add('open');
}

async function loadHistoriquePrix(prodId) {
  const c = document.getElementById('historiquePrixList');
  c.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px 0;text-align:center">‚è≥</div>';
  if (!useSb) { c.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px 0">Connectez Supabase</div>'; return; }
  const { data } = await sb.from('historique_prix')
    .select('*').eq('produit_id', prodId)
    .order('created_at', { ascending: false }).limit(12);
  if (!data?.length) {
    c.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:10px 0;text-align:center">Aucun changement de prix enregistr√©</div>';
    return;
  }
  c.innerHTML = data.map(h => {
    const hausse = h.nouveau_prix > h.ancien_prix;
    const pct = h.ancien_prix > 0 ? Math.round(((h.nouveau_prix - h.ancien_prix) / h.ancien_prix) * 100) : 0;
    return `<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
      <div style="font-size:18px;flex-shrink:0">${hausse ? 'üìà' : 'üìâ'}</div>
      <div style="flex:1">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <span style="font-size:12px;color:var(--muted);text-decoration:line-through">${h.ancien_prix.toLocaleString()} DA</span>
          <span style="font-size:13px;font-weight:700;color:${hausse?'var(--danger)':'var(--accent3)'}">${h.nouveau_prix.toLocaleString()} DA</span>
          <span style="font-size:11px;padding:2px 7px;border-radius:10px;font-weight:700;background:${hausse?'rgba(239,68,68,0.12)':'rgba(16,185,129,0.12)'};color:${hausse?'var(--danger)':'var(--accent3)'}">${pct>0?'+':''}${pct}%</span>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px">
          ${new Date(h.created_at).toLocaleString('fr-DZ',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}
          ${h.note?' ¬∑ <em>'+h.note+'</em>':''}
        </div>
      </div>
    </div>`;
  }).join('');
}

async function saveProduit() {
  const id = document.getElementById('editProdId').value;
  const nom = document.getElementById('editProdNom').value.trim();
  const unite = document.getElementById('editProdUnite').value.trim();
  const nouveauPrix = parseInt(document.getElementById('editProdNouveauPrix').value) || 0;
  const note = document.getElementById('editProdNote').value.trim();
  const image = document.getElementById('editProdImgData').value || null;
  const condType = document.getElementById('editProdCondType')?.value || null;
  const condQty  = parseInt(document.getElementById('editProdCondQty')?.value)||null;
  if (!nom) { showToast('‚ö†Ô∏è Le nom est requis', true); return; }
  const btn = document.getElementById('editProdBtn');
  btn.disabled = true; btn.textContent = '‚è≥...';
  const prod = lProduits.find(p => String(p.id) === String(id));
  const ancienPrix = prod?.prix || 0;
  if (useSb) {
    await sb.from('produits').update({ nom, icone:'üì¶', unite, image, cond_type:condType, cond_qty:condQty }).eq('id', id);
    if (nouveauPrix > 0 && nouveauPrix !== ancienPrix) {
      await sb.rpc('changer_prix_produit', {
        p_produit_id: id, p_nouveau_prix: nouveauPrix,
        p_note: note || null, p_modifie_par: curUser?.nom || null
      });
    }
  } else {
    if (prod) { prod.nom = nom; prod.unite = unite; prod.prix = nouveauPrix; prod.image = image; prod.cond_type = condType; prod.cond_qty = condQty; }
  }
  btn.disabled = false; btn.textContent = 'üíæ Enregistrer';
  closeMod('editProdModal');
  showToast(`‚úÖ ${nom} mis √† jour`);
  await loadStock();
}

async function deleteProduit(id, nom) {
  if (!confirm(`Supprimer "${nom}" du catalogue ?\n\nLes livraisons pass√©es ne seront pas affect√©es.`)) return;
  if (useSb) {
    const { error } = await sb.from('produits').delete().eq('id', id);
    if (error) { showToast('‚ùå ' + error.message, true); return; }
  } else {
    const idx = lProduits.findIndex(p => String(p.id) === String(id));
    if (idx !== -1) lProduits.splice(idx, 1);
  }
  showToast(`üóëÔ∏è "${nom}" supprim√©`);
  await loadStock();
}

async function doApprov(){
  const pid=document.getElementById('approvProduit').value;
  const qty=parseInt(document.getElementById('approvQty').value);
  const note=document.getElementById('approvNote').value.trim();
  if(!pid||!qty||qty<=0){showToast('‚ö†Ô∏è S√©lectionnez un produit et une quantit√©',true);return}

  if(useSb){
    // Ajouter mouvement
    await sb.from('mouvements_stock').insert({produit_id:pid,type:'entree',quantite:qty,note});
    // Mettre √† jour stock
    const {data:prod}=await sb.from('produits').select('quantite').eq('id',pid).single();
    await sb.from('produits').update({quantite:(prod?.quantite||0)+qty}).eq('id',pid);
  } else {
    const p=lProduits.find(x=>x.id===pid);
    if(p){p.quantite+=qty;lStock.push({produit_id:pid,type:'entree',quantite:qty,note,date:new Date().toISOString()})}
  }
  document.getElementById('approvQty').value='';
  document.getElementById('approvNote').value='';
  await loadStock();
  showToast(`+${qty} unit√©s ajout√©es au stock ‚úì`);
}

async function doChargement(){
  const lid=document.getElementById('chargLivreur').value;
  if(!lid){showToast('‚ö†Ô∏è S√©lectionnez un livreur',true);return}

  const prods=(useSb?(await sb.from('produits').select('*').then(r=>r.data||[])):lProduits)
    .filter(p=>(p.quantite||0)>0);  // seulement les produits avec stock disponible
  const today=new Date().toISOString().split('T')[0];
  let hasAny=false;

  for(const p of prods){
    const q=parseInt(document.getElementById('charg-'+p.id)?.value)||0;
    if(q<=0) continue;
    hasAny=true;
    if(useSb){
      await sb.from('chargements').insert({livreur_id:lid,produit_id:p.id,quantite_initiale:q,quantite_livree:0,date:today});
      await sb.from('produits').update({quantite:Math.max(0,(p.quantite||0)-q)}).eq('id',p.id);
    } else {
      const prod=lProduits.find(x=>x.id===p.id);
      if(prod) prod.quantite=Math.max(0,prod.quantite-q);
    }
  }
  if(!hasAny){showToast('‚ö†Ô∏è Entrez au moins une quantit√©',true);return}
  document.querySelectorAll('[id^="charg-"]').forEach(i=>i.value='');
  await loadStock();
  showToast('Chargement valid√© ‚úì');
}

// ============================================================
// CLIENTS
// ============================================================
async function loadAllClients(){
  let clients=lClients;
  if(useSb){
    const {data}=await sb.from('commer√ßants').select('*').order('nom');
    if(data) clients=data;
  } else {
    // Construire liste clients depuis livraisons
    const seen={};
    lLivraisons.forEach(l=>{
      if(l.client_nom&&!seen[l.client_phone||l.client_nom]){
        seen[l.client_phone||l.client_nom]=true;
        clients.push({id:l.client_phone||l.client_nom,nom:l.client_nom,telephone:l.client_phone,adresse:l.client_adresse});
      }
    });
  }
  document.getElementById('totalClients').textContent=clients.length;
  const c=document.getElementById('clientsList');
  if(!clients.length){c.innerHTML='<div class="empty"><div class="eico">üë•</div>Aucun commer√ßant enregistr√©</div>';return}
  c.innerHTML=clients.map(cl=>`
    <div class="client-card ai" onclick="showClientModal('${cl.id}')">
      <div class="client-name">${cl.nom}</div>
      <div class="client-info">üìû ${cl.telephone||'‚Äî'}</div>
      <div class="client-info">üìç ${cl.adresse||'‚Äî'}</div>
      <div class="client-hist">Voir historique ‚Üí</div>
    </div>`).join('');
}

async function showClientModal(id){
  let cl, delivs=[];
  if(useSb){
    const {data}=await sb.from('commer√ßants').select('*').eq('id',id).single();
    cl=data;
    const {data:d}=await sb.from('livraisons').select('*').eq('client_id',id).order('created_at',{ascending:false}).limit(10);
    if(d) delivs=d;
  } else {
    cl=lClients.find(x=>x.id===id)||{nom:id,telephone:'',adresse:''};
    delivs=lLivraisons.filter(l=>l.client_phone===id||l.client_nom===id);
  }
  if(!cl) return;
  document.getElementById('cModName').textContent=cl.nom;
  document.getElementById('cModSub').textContent=`üìû ${cl.telephone||'‚Äî'} ¬∑ üìç ${cl.adresse||'‚Äî'}`;
  const totalMnt=delivs.reduce((s,d)=>s+(d.montant||0),0);
  document.getElementById('cModStats').innerHTML=`
    <div class="mst"><div class="msv" style="color:var(--accent)">${delivs.length}</div><div class="msl">Livraisons</div></div>
    <div class="mst"><div class="msv" style="color:var(--accent3)">${totalMnt.toLocaleString()}</div><div class="msl">DA total</div></div>`;
  document.getElementById('cModHistory').innerHTML=delivs.length?`
    <div style="font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">Historique</div>
    ${delivs.map(d=>`
      <div class="hcard" style="margin-bottom:8px">
        <div class="htim">${fmtTime(d.created_at||d.heure)} ¬∑ ${d.livreur||''}</div>
        <div class="hdet">üì¶ ${d.produits||''}</div>
        <div style="color:var(--accent3);font-weight:700;margin-top:6px">${(d.montant||0).toLocaleString()} DA</div>
      </div>`).join('')}`:'<div style="color:var(--muted);font-size:13px">Aucune livraison</div>';
  document.getElementById('clientModal').classList.add('open');
}

// ============================================================
// EXPORT
// ============================================================
function getPeriodDates(){
  const p=document.getElementById('exportPeriod').value;
  const now=new Date();
  let from,to=new Date();
  if(p==='month'){from=new Date(now.getFullYear(),now.getMonth(),1)}
  else if(p==='quarter'){const q=Math.floor(now.getMonth()/3);from=new Date(now.getFullYear(),q*3,1)}
  else if(p==='semester'){from=new Date(now.getFullYear(),now.getMonth()<6?0:6,1)}
  else if(p==='year'){from=new Date(now.getFullYear(),0,1)}
  else{from=new Date(document.getElementById('exportFrom').value);to=new Date(document.getElementById('exportTo').value)}
  return{from:from.toISOString(),to:to.toISOString()}
}

async function getExportData(){
  const{from,to}=getPeriodDates();
  let livraisons=[],clients=[],stock=[];

  if(useSb){
    const{data:l}=await sb.from('livraisons').select('*,livreurs(nom)').gte('created_at',from).lte('created_at',to).order('created_at',{ascending:false});
    livraisons=l||[];
    const{data:c}=await sb.from('commer√ßants').select('*');
    clients=c||[];
    const{data:s}=await sb.from('mouvements_stock').select('*,produits(nom)').gte('created_at',from).lte('created_at',to);
    stock=s||[];
  } else {
    livraisons=lLivraisons.filter(l=>new Date(l.created_at||'')>=new Date(from)&&new Date(l.created_at||'')<=new Date(to));
    clients=lClients;
    stock=lStock.filter(s=>new Date(s.date||'')>=new Date(from)&&new Date(s.date||'')<=new Date(to));
  }
  return{livraisons,clients,stock}
}

async function exportExcel(){
  if (planFeatureBlocked('export')) return;
  showToast('Pr√©paration du fichier...');
  const{livraisons,clients,stock}=await getExportData();
  const wb=XLSX.utils.book_new();

  if(document.getElementById('expLivraisons').checked&&livraisons.length){
    const rows=livraisons.map(l=>({
      'Date':fmtTime(l.created_at||l.heure),
      'Livreur':l.livreurs?.nom||l.livreur||'',
      'Commer√ßant':l.client_nom||l.client||'',
      'T√©l√©phone':l.client_phone||'',
      'Adresse':l.client_adresse||'',
      'Produits':l.produits||'',
      'Montant (DA)':l.montant||0,
      'Mode paiement':l.mode_paiement||'',
      'Latitude':l.lat||'',
      'Longitude':l.lng||'',
      'Notes':l.notes||'',
    }));
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(rows),'Livraisons');
  }

  if(document.getElementById('expClients').checked&&clients.length){
    const rows=clients.map(c=>({
      'Nom':c.nom||'',
      'T√©l√©phone':c.telephone||'',
      'Adresse':c.adresse||'',
    }));
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(rows),'Clients');
  }

  if(document.getElementById('expStock').checked&&stock.length){
    const rows=stock.map(s=>({
      'Date':fmtTime(s.created_at||s.date),
      'Produit':s.produits?.nom||s.produit||'',
      'Type':s.type||'',
      'Quantit√©':s.quantite||0,
      'Note':s.note||'',
    }));
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(rows),'Stock');
  }

  if(document.getElementById('expResume').checked&&livraisons.length){
    const resume={};
    livraisons.forEach(l=>{
      const n=l.livreurs?.nom||l.livreur||'Inconnu';
      if(!resume[n]) resume[n]={livreur:n,livraisons:0,montant:0};
      resume[n].livraisons++;
      resume[n].montant+=(l.montant||0);
    });
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(Object.values(resume)),'R√©sum√© livreurs');
  }

  if(!wb.SheetNames.length){showToast('‚ö†Ô∏è Aucune donn√©e √† exporter',true);return}

  const period=document.getElementById('exportPeriod').value;
  const labels={month:'mois',quarter:'trimestre',semester:'semestre',year:'annee',custom:'custom'};
  const filename=`DeliTrack_${labels[period]}_${new Date().toISOString().split('T')[0]}.xlsx`;
  XLSX.writeFile(wb,filename);
  showToast('Fichier Excel t√©l√©charg√© ‚úì');
}

async function exportCSV(){
  if (planFeatureBlocked('export')) return;
  showToast('Pr√©paration CSV...');
  const{livraisons}=await getExportData();
  if(!livraisons.length){showToast('‚ö†Ô∏è Aucune donn√©e',true);return}
  const headers=['Date','Livreur','Commer√ßant','T√©l√©phone','Montant DA','Mode paiement','Produits','Latitude','Longitude'];
  const rows=livraisons.map(l=>[
    fmtTime(l.created_at||l.heure),
    l.livreurs?.nom||l.livreur||'',
    l.client_nom||'',
    l.client_phone||'',
    l.montant||0,
    l.mode_paiement||'',
    l.produits||'',
    l.lat||'',
    l.lng||''
  ].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','));
  const csv=[headers.join(','),...rows].join('\n');
  const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`DeliTrack_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  showToast('CSV t√©l√©charg√© ‚úì');
}

function updateResumeStats(){
  const tl=lLivraisons.length;
  const tm=lLivraisons.reduce((s,l)=>s+(l.montant||0),0);
  document.getElementById('rL').textContent=tl;
  document.getElementById('rLiv').textContent=lLivreurs.length;
  document.getElementById('rM').textContent=tm>=1000?(tm/1000).toFixed(0)+'k':tm;
}

// ============================================================
// MODAL LIVREUR DETAIL
// ============================================================
async function showLivModal(id){
  trajetLivreurId = id; // Stocker pour le trajet
  let l=lLivreurs.find(x=>x.id===id);
  if(useSb){const{data}=await sb.from('livreurs').select('*').eq('id',id).single();if(data)l=data}
  if(!l) return;
  trajetLivreurNom = l.nom; // Pour le titre du modal trajet
  document.getElementById('modName').textContent=l.nom;
  document.getElementById('modSub').textContent=`üìç ${l.zone||''}`;
  document.getElementById('modStats').innerHTML=`
    <div class="mst"><div class="msv" style="color:var(--accent)">${l.livraisons||0}</div><div class="msl">Livraisons</div></div>
    <div class="mst"><div class="msv" style="color:var(--accent3)">${(l.montant||0).toLocaleString()}</div><div class="msl">DA</div></div>
    <div class="mst"><div class="msv" style="color:var(--accent2);font-size:13px">${Number(l.lat||0).toFixed(4)}</div><div class="msl">Latitude</div></div>
    <div class="mst"><div class="msv" style="color:var(--accent2);font-size:13px">${Number(l.lng||0).toFixed(4)}</div><div class="msl">Longitude</div></div>`;
  let d=lLivraisons.filter(x=>x.livreur_id===id||x.livreur===l.nom);
  if(useSb){const{data}=await sb.from('livraisons').select('*').eq('livreur_id',id).order('created_at',{ascending:false}).limit(5);if(data)d=data}
  document.getElementById('modDelivs').innerHTML=d.length?`
    <div style="font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">Derni√®res livraisons</div>
    ${d.map(x=>`<div class="hcard" style="margin-bottom:8px"><div class="hcli">${x.client_nom||x.client||''}</div><div class="htim">${fmtTime(x.created_at||x.heure)}</div><div style="color:var(--accent3);font-weight:700;margin-top:4px">${(x.montant||0).toLocaleString()} DA</div></div>`).join('')}`
    :'<div style="color:var(--muted);font-size:13px">Aucune livraison</div>';
  document.getElementById('livModal').classList.add('open');
}

// ============================================================
// REALTIME
// ============================================================
function subRealtime(){
  sb.channel('rt').on('postgres_changes',{event:'INSERT',schema:'public',table:'livraisons'},()=>{
    loadAllDeliveries();loadLivreurs();showToast('Nouvelle livraison üì¶');
  }).on('postgres_changes',{event:'UPDATE',schema:'public',table:'livreurs'},()=>{
    loadLivreurs();
  }).subscribe();
}

// ============================================================
// MAP LEAFLET
// ============================================================
let leafletMap = null;
let livMarkers = {};
let delivMarkers = [];

function initMap() {
  if (leafletMap) {
    // Carte d√©j√† cr√©√©e ‚Äî juste recalibrer
    setTimeout(() => { leafletMap.invalidateSize(true); updateMapMarkers(); }, 50);
    return;
  }

  const mapBox = document.querySelector('.map-box');
  const mapDiv = document.getElementById('realMap');
  if (!mapDiv || !mapBox) return;

  // Strat√©gie identique √† la version Canvas :
  // requestAnimationFrame garantit que le browser a PEINT le layout
  // puis on v√©rifie les dimensions r√©elles avant d'appeler L.map()
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      // Double rAF = le browser a appliqu√© tous les styles et peint une frame
      _buildMap(mapBox, mapDiv);
    });
  });
}

function _buildMap(mapBox, mapDiv) {
  if (leafletMap) return;

  const w = mapBox.offsetWidth;
  const h = mapBox.offsetHeight;

  if (w === 0 || h === 0) {
    // Pas encore rendu (tr√®s rare apr√®s double rAF) ‚Äî r√©essayer via ResizeObserver
    const ro = new ResizeObserver(entries => {
      for (const e of entries) {
        if (e.contentRect.width > 0 && e.contentRect.height > 0) {
          ro.disconnect();
          // Encore un rAF pour laisser le browser finaliser
          requestAnimationFrame(() => _buildMap(mapBox, mapDiv));
        }
      }
    });
    ro.observe(mapBox);
    return;
  }

  // Forcer la taille sur le div interne AVANT que Leaflet lise les dimensions
  mapDiv.style.width  = w + 'px';
  mapDiv.style.height = h + 'px';

  leafletMap = L.map('realMap', {
    center: [36.7538, 3.0588], zoom: 11,
    zoomControl: true, attributionControl: false, preferCanvas: false,
  });

  tileLayerMain = getTileLayer();
  tileLayerMain.addTo(leafletMap);

  // Retirer les dimensions forc√©es et laisser CSS reprendre
  setTimeout(() => {
    mapDiv.style.width  = '';
    mapDiv.style.height = '';
    leafletMap.invalidateSize(true);
    updateMapMarkers();
  }, 100);

  setInterval(async () => { if (useSb && leafletMap) await updateMapMarkers(); }, 15000);
}

async function updateMapMarkers() {
  if (!leafletMap) return;

  // Toujours recharger depuis Supabase si connect√©
  if (useSb) {
    const {data} = await sb.from('livreurs').select('*');
    if (data) lLivreurs = data;
  }

  // Supprimer TOUS les marqueurs existants de la carte
  Object.keys(livMarkers).forEach(id => {
    leafletMap.removeLayer(livMarkers[id]);
  });
  livMarkers = {}; // R√©initialiser compl√®tement

  const bounds = [];

  lLivreurs.forEach(l => {
    const lat = parseFloat(l.lat) || 36.7538;
    const lng = parseFloat(l.lng) || 3.0588;
    const col = l.couleur || '#F97316';
    const ini = l.initiales || l.nom?.substring(0,2).toUpperCase() || '?';
    const st = l.statut || 'actif';
    const isActive = st === 'actif' || st === 'active';

    bounds.push([lat, lng]);

    const icon = L.divIcon({
      className: '',
      html: `<div class="livreur-marker ${isActive ? 'pulse' : ''}" style="background:${col};position:relative">${ini}</div>`,
      iconSize: [36, 36],
      iconAnchor: [18, 18],
      popupAnchor: [0, -22],
    });

    const popup = `
      <div class="popup-name" style="color:${col}">${l.nom}</div>
      <div class="popup-info">üìç ${l.zone || '‚Äî'}</div>
      <div class="popup-info">üì¶ ${l.livraisons || 0} livraisons ¬∑ ${(l.montant||0).toLocaleString()} DA</div>
      <div class="popup-info" style="margin-top:6px">
        <span style="background:${isActive?'rgba(16,185,129,0.15)':'rgba(100,116,139,0.15)'};color:${isActive?'#10B981':'#64748B'};padding:2px 8px;border-radius:20px;font-size:11px;font-weight:600">
          ${isActive ? 'üü¢ En route' : st === 'pause' ? 'üü° En pause' : '‚ö™ Termin√©'}
        </span>
      </div>`;

    // Cr√©er un nouveau marqueur propre
    livMarkers[l.id] = L.marker([lat, lng], {icon})
      .bindPopup(popup, {className: 'dark-popup', maxWidth: 220})
      .addTo(leafletMap);
  });

  // Recentrer la carte pour afficher tous les livreurs
  if (bounds.length === 1) {
    leafletMap.setView(bounds[0], 12);
  } else if (bounds.length > 1) {
    leafletMap.fitBounds(bounds, {padding: [50, 50], maxZoom: 13});
  }

  // Forcer le recalcul de la taille
  setTimeout(() => leafletMap.invalidateSize(), 100);
}

function addDeliveryMarker(lat, lng, clientNom, montant) {
  if (!leafletMap) return;
  const icon = L.divIcon({
    className: '',
    html: `<div class="delivery-marker">‚úì</div>`,
    iconSize: [24, 24],
    iconAnchor: [12, 12],
  });
  const marker = L.marker([lat, lng], {icon})
    .bindPopup(`<div class="popup-name">${clientNom}</div><div class="popup-info" style="color:var(--accent3)">${montant.toLocaleString()} DA</div>`)
    .addTo(leafletMap);
  delivMarkers.push(marker);
}

// ============================================================
// LIVREUR INIT
// ============================================================
async function initL(){
  await loadCamion();
  renderProdCheck();
  await loadMyDeliveries();
  await loadMyClients();
  await loadCredits();
  await updateOfflineBadge();
  // Tenter de synchroniser les livraisons en attente d√®s le login
  if (isOnline && useSb) await syncPending();
  startGPS();
}

async function loadCamion(){
  camionProduits=[];
  if(useSb&&curLivreur?.id){
    const today=new Date().toISOString().split('T')[0];
    const{data}=await sb.from('chargements').select('*,produits(*)').eq('livreur_id',curLivreur.id).eq('date',today);
    if(data&&data.length){
      camionProduits=data.map(c=>({
        id:c.produit_id,nom:c.produits?.nom||'',icone:c.produits?.icone||'üì¶',
        quantite:c.quantite_initiale-(c.quantite_livree||0),unite:c.produits?.unite||'',couleur:c.produits?.couleur||'#F97316'
      }));
    }
  }
  if(!camionProduits.length) camionProduits=[...lProduits];
  document.getElementById('camionCount').textContent=camionProduits.length;
  const c=document.getElementById('camionList');
  if(!camionProduits.length){c.innerHTML='<div class="empty"><div class="eico">üöö</div>Aucun produit charg√© aujourd\'hui</div>';return}
  c.innerHTML=camionProduits.map(p=>`
    <div class="pitem ai">
      <div class="picon" style="background:${p.couleur||'#F97316'}22">${p.icone}</div>
      <div style="flex:1"><div class="pname">${p.nom}</div><div class="punit">${p.unite}</div></div>
      <div class="qbadge">${p.quantite}</div>
    </div>`).join('');
}

function renderProdCheck(){
  document.getElementById('prodCheck').innerHTML=camionProduits.map(p=>`
    <div class="pcitem" onclick="togProd('${p.id}',this)">
      <div class="cbox" id="cb-${p.id}"></div>
      <div style="flex:1">
        <div class="cname">${p.icone||'üì¶'} ${p.nom}</div>
        ${p.prix?`<div style="font-size:11px;color:var(--accent);font-weight:600">${(p.prix||0).toLocaleString()} DA / ${p.unite||'unit√©'}</div>`:''}
      </div>
      <input class="cqin" type="number" id="qi-${p.id}" placeholder="0" min="0" max="${p.quantite}" onclick="event.stopPropagation()" oninput="updQty('${p.id}',this.value);calcTotal()">
    </div>`).join('');
}

let _totalCommande = 0; // total global de la commande en cours

function calcTotal(){
  let total = 0;
  const details = [];
  Object.keys(chkProds).forEach(id => {
    const p = camionProduits.find(x => x.id === id);
    if (p && p.prix && chkProds[id] > 0) {
      const sub = (p.prix || 0) * chkProds[id];
      total += sub;
      details.push(`${p.nom} √ó${chkProds[id]} = ${sub.toLocaleString()} DA`);
    }
  });
  _totalCommande = total;
  const box = document.getElementById('totalCalcule');
  if (total > 0) {
    box.style.display = 'block';
    document.getElementById('totalCalcVal').textContent = total.toLocaleString() + ' DA';
    document.getElementById('totalCalcDetail').textContent = details.join(' ¬∑ ');
    // Pr√©-remplir le montant avec le total si vide ou si √©gal √† l'ancien total
    const montantEl = document.getElementById('montant');
    if (!montantEl.value || parseFloat(montantEl.value) === 0) {
      montantEl.value = total;
    }
    onMontantChange();
  } else {
    box.style.display = 'none';
    document.getElementById('resteIndicateur').style.display = 'none';
  }
}

function onMontantChange() {
  const verse = parseFloat(document.getElementById('montant').value) || 0;
  const total = _totalCommande;
  const ind = document.getElementById('resteIndicateur');
  if (total <= 0) { ind.style.display = 'none'; return; }

  const reste = total - verse;

  if (verse <= 0) {
    // Rien vers√©
    ind.style.display = 'none';
    return;
  }

  ind.style.display = 'block';

  if (reste > 0) {
    // Paiement partiel
    ind.style.background = 'rgba(239,68,68,0.08)';
    ind.style.border = '1.5px solid rgba(239,68,68,0.25)';
    document.getElementById('resteLabel').textContent = 'üìã Reste √† r√©gler lors de la prochaine livraison';
    document.getElementById('resteLabel').style.color = 'var(--danger)';
    document.getElementById('resteVal').textContent = reste.toLocaleString() + ' DA';
    document.getElementById('resteVal').style.color = 'var(--danger)';
    document.getElementById('resteInfo').textContent = `Versement : ${verse.toLocaleString()} DA sur ${total.toLocaleString()} DA`;
    document.getElementById('resteInfo').style.color = 'var(--muted)';
    // Auto-s√©lectionner "Esp√®ces" si pas encore s√©lectionn√©
    const modeEl = document.getElementById('modePay');
    if (!modeEl.value || modeEl.value === 'Total en cr√©dit') modeEl.value = 'Esp√®ces';
  } else if (reste < 0) {
    // Trop vers√© ‚Üí monnaie √† rendre
    ind.style.background = 'rgba(249,115,22,0.08)';
    ind.style.border = '1.5px solid rgba(249,115,22,0.25)';
    document.getElementById('resteLabel').textContent = 'üîÑ Monnaie √† rendre';
    document.getElementById('resteLabel').style.color = 'var(--accent)';
    document.getElementById('resteVal').textContent = Math.abs(reste).toLocaleString() + ' DA';
    document.getElementById('resteVal').style.color = 'var(--accent)';
    document.getElementById('resteInfo').textContent = `Client a pay√© ${verse.toLocaleString()} DA pour ${total.toLocaleString()} DA`;
    document.getElementById('resteInfo').style.color = 'var(--muted)';
  } else {
    // Compte exact
    ind.style.background = 'rgba(16,185,129,0.08)';
    ind.style.border = '1.5px solid rgba(16,185,129,0.25)';
    document.getElementById('resteLabel').textContent = '‚úÖ Compte exact';
    document.getElementById('resteLabel').style.color = 'var(--accent3)';
    document.getElementById('resteVal').textContent = '0 DA';
    document.getElementById('resteVal').style.color = 'var(--accent3)';
    document.getElementById('resteInfo').textContent = '';
  }
}

function togProd(id,el){
  const b=document.getElementById('cb-'+id);
  if(!b.classList.contains('ck')){b.classList.add('ck');b.innerHTML='‚úì';chkProds[id]=parseInt(document.getElementById('qi-'+id).value)||1;document.getElementById('qi-'+id).value=chkProds[id]}
  else{b.classList.remove('ck');b.innerHTML='';delete chkProds[id]}
  calcTotal();
}
function updQty(id,v){if(chkProds[id]!==undefined){chkProds[id]=parseInt(v)||0;}}

// ============================================================
// CLIENTS LIVREUR
// ============================================================
async function loadMyClients(){
  let clients=[];
  if(useSb&&curLivreur?.id){
    const{data}=await sb.from('commer√ßants').select('*').eq('livreur_id',curLivreur.id).order('nom');
    if(data) clients=data;
  } else {
    const seen={};
    lLivraisons.filter(l=>l.livreur_id===curLivreur?.id||l.livreur===curLivreur?.nom).forEach(l=>{
      if(l.client_nom&&!seen[l.client_nom]){seen[l.client_nom]=true;clients.push({id:l.client_phone||l.client_nom,nom:l.client_nom,telephone:l.client_phone||'',adresse:l.client_adresse||''})}
    });
  }
  document.getElementById('lClientCount').textContent=clients.length;
  const c=document.getElementById('lClientsList');
  if(!clients.length){c.innerHTML='<div class="empty"><div class="eico">üë•</div>Aucun commer√ßant pour le moment</div>';return}
  c.innerHTML=clients.map(cl=>`
    <div class="client-card ai" onclick="fillClient('${cl.nom}','${cl.telephone}','${cl.adresse}')">
      <div class="client-name">${cl.nom}</div>
      <div class="client-info">üìû ${cl.telephone||'‚Äî'}</div>
      <div class="client-info">üìç ${cl.adresse||'‚Äî'}</div>
      <div class="client-hist">üì¶ Cr√©er livraison ‚Üí</div>
    </div>`).join('');
}

function fillClient(nom,tel,addr){
  document.getElementById('clientName').value=nom;
  document.getElementById('clientPhone').value=tel;
  document.getElementById('clientAddr').value=addr;
  lNavTo('livrer');
  showToast('Commer√ßant s√©lectionn√© ‚úì');
}

// Recherche client dans le formulaire
async function searchClients(q){
  const sug=document.getElementById('clientSuggestions');
  if(!q||q.length<2){sug.style.display='none';return}
  let clients=[];
  if(useSb){
    const{data}=await sb.from('commer√ßants').select('*').ilike('nom','%'+q+'%').limit(5);
    if(data) clients=data;
  } else {
    clients=[...new Map(lLivraisons.filter(l=>l.client_nom?.toLowerCase().includes(q.toLowerCase())).map(l=>[l.client_nom,{nom:l.client_nom,telephone:l.client_phone||'',adresse:l.client_adresse||''}])).values()];
  }
  if(!clients.length){sug.style.display='none';return}
  sug.style.display='block';
  sug.innerHTML=clients.map(c=>`
    <div onclick="fillClient('${c.nom}','${c.telephone||''}','${c.adresse||''}')" style="padding:12px 14px;border-bottom:1px solid var(--border);cursor:pointer;font-size:13px">
      <strong>${c.nom}</strong><br><span style="color:var(--muted)">${c.telephone||''}</span>
    </div>`).join('');
}

// ============================================================
// GPS
// ============================================================
function startGPS(){
  if(!navigator.geolocation){document.getElementById('gpsStTxt').textContent='GPS non disponible';return}
  navigator.geolocation.getCurrentPosition(p=>updGPS(p.coords.latitude,p.coords.longitude,p.coords.speed||0));
  gpsWatchId=navigator.geolocation.watchPosition(
    p=>updGPS(p.coords.latitude,p.coords.longitude,p.coords.speed||0),
    null,
    {enableHighAccuracy:true,maximumAge:10000,timeout:30000}
  );
}
function stopGPS(){if(gpsWatchId)navigator.geolocation.clearWatch(gpsWatchId)}
let lastGPSSave = 0;
async function updGPS(lat, lng, vitesse=0) {
  gpsCoords = {lat, lng};
  document.getElementById('gpsStTxt').textContent = `GPS actif ‚Äî ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
  if (useSb && curLivreur?.id) {
    // Mettre √† jour position actuelle du livreur
    await sb.from('livreurs').update({lat, lng, derniere_position: new Date().toISOString()}).eq('id', curLivreur.id);
    // Enregistrer dans l'historique toutes les 30 secondes
    const now = Date.now();
    if (now - lastGPSSave > 30000) {
      lastGPSSave = now;
      await sb.from('positions_gps').insert({
        livreur_id: curLivreur.id,
        lat, lng,
        vitesse: vitesse || 0,
        date: new Date().toISOString().split('T')[0]
      });
    }
  }
}
function capGPS(){
  if(gpsCoords){document.getElementById('gpsDsp').textContent=`‚úÖ ${gpsCoords.lat.toFixed(6)}, ${gpsCoords.lng.toFixed(6)}`;showToast('Position captur√©e ‚úì')}
  else navigator.geolocation.getCurrentPosition(p=>{gpsCoords={lat:p.coords.latitude,lng:p.coords.longitude};document.getElementById('gpsDsp').textContent=`‚úÖ ${gpsCoords.lat.toFixed(6)}, ${gpsCoords.lng.toFixed(6)}`;showToast('Position captur√©e ‚úì')},()=>showToast('‚ö†Ô∏è Activez le GPS',true));
}

// ============================================================
// SOUMETTRE LIVRAISON
// ============================================================
async function submitLivraison(){
  const nom   = document.getElementById('clientName').value.trim();
  const tel   = document.getElementById('clientPhone').value.trim();
  const addr  = document.getElementById('clientAddr').value.trim();
  const verse = parseFloat(document.getElementById('montant').value) || 0;
  const mode  = document.getElementById('modePay').value;
  const notes = document.getElementById('notesLiv').value.trim();

  if (!nom || !tel)       { showToast('‚ö†Ô∏è Nom et t√©l√©phone requis', true); return; }
  if (!gpsCoords)         { showToast('‚ö†Ô∏è Capturez votre position GPS', true); return; }
  if (!Object.keys(chkProds).length) { showToast('‚ö†Ô∏è S√©lectionnez au moins un produit', true); return; }
  if (!mode)              { showToast('‚ö†Ô∏è Choisissez le mode de paiement', true); return; }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true; btn.textContent = '‚è≥ Envoi...';

  const detail   = Object.keys(chkProds).map(id => {
    const p = camionProduits.find(x => x.id === id);
    return { id, nom: p?.nom||id, icone: p?.icone||'üì¶', quantite: chkProds[id],
             prix_unitaire: p?.prix||0, total: (p?.prix||0)*chkProds[id], unite: p?.unite||'' };
  });
  const prodsTxt  = detail.map(p => `${p.nom} √ó${p.quantite}`).join(', ');
  const sousTotal = detail.reduce((s, l) => s + l.total, 0);
  const num       = 'FAC-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-5);

  // ‚îÄ‚îÄ D√©terminer le statut de paiement ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const modeTotal  = mode === 'Total en cr√©dit';
  const montantVerse = modeTotal ? 0 : verse;
  const resteDu    = sousTotal - montantVerse;
  const estPartiel = !modeTotal && resteDu > 0 && montantVerse > 0;
  const estCredit  = modeTotal || (verse <= 0);

  let statutFacture;
  if (estCredit)        statutFacture = 'credit';
  else if (estPartiel)  statutFacture = 'credit_partiel';
  else                  statutFacture = 'payee';

  const modePaiementReel = modeTotal ? 'Cr√©dit total' : mode;
  const offlineId = 'liv_' + Date.now() + '_' + Math.random().toString(36).slice(2, 7);

  const liv = {
    livreur_id: curLivreur?.id || 'demo', livreur: curLivreur?.nom || '',
    client_nom: nom, client_phone: tel, client_adresse: addr,
    montant: montantVerse,
    montant_total: sousTotal,
    reste_du: Math.max(0, resteDu),
    mode_paiement: modePaiementReel,
    produits: prodsTxt, produits_detail: JSON.stringify(detail),
    lat: gpsCoords.lat, lng: gpsCoords.lng, notes,
    heure: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
    created_at: new Date().toISOString(),
  };

  const facture = {
    numero: num,
    livreur_id: curLivreur?.id, livreur: curLivreur?.nom || '',
    client_nom: nom, client_phone: tel, client_adresse: addr,
    lignes: JSON.stringify(detail),
    sous_total: sousTotal,
    montant_verse: montantVerse,
    reste_du: Math.max(0, resteDu),
    remise: 0,
    total: sousTotal,
    mode_paiement: modePaiementReel,
    statut: statutFacture,
    montant_encaisse: montantVerse,
    notes,
  };

  let livId = null;
  let savedOffline = false;

  if (useSb && isOnline) {
    // ‚îÄ‚îÄ MODE EN LIGNE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    try {
      await sb.from('commer√ßants').upsert(
        { nom, telephone: tel, adresse: addr, livreur_id: curLivreur?.id },
        { onConflict: 'telephone', ignoreDuplicates: false }
      );
      const { data: livData, error } = await sb.from('livraisons').insert(liv).select().single();
      if (error) throw error;
      livId = livData?.id;
      await sb.from('factures').insert({ ...facture, livraison_id: livId });
    } catch(e) {
      // Erreur r√©seau ‚Üí sauvegarder offline m√™me si useSb=true
      await saveOffline(
        { ...liv, _offlineId: offlineId },
        { ...facture, _offlineId: offlineId }
      );
      savedOffline = true;
    }
  } else if (offlineDB) {
    // ‚îÄ‚îÄ MODE HORS LIGNE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    await saveOffline(
      { ...liv, _offlineId: offlineId },
      { ...facture, _offlineId: offlineId }
    );
    savedOffline = true;
    // Stocker aussi dans la m√©moire locale pour affichage imm√©diat
    lLivraisons.unshift({ ...liv, id: offlineId, _offline: true });
    if (!lClients.find(c => c.telephone === tel))
      lClients.push({ id: tel, nom, telephone: tel, adresse: addr });
  } else {
    // Pas de Supabase, pas d'IndexedDB ‚Äî mode d√©mo pure
    lLivraisons.unshift(liv);
    if (!lClients.find(c => c.telephone === tel))
      lClients.push({ id: tel, nom, telephone: tel, adresse: addr });
  }

  // D√©duire stock local
  Object.keys(chkProds).forEach(id => {
    const p = camionProduits.find(x => x.id === id);
    if (p) p.quantite = Math.max(0, p.quantite - (chkProds[id] || 0));
  });

  // Donn√©es pour impression
  const factureData = {
    num, nom, tel, addr, lignes: detail,
    sousTotal, montantVerse, resteDu: Math.max(0, resteDu),
    remise: 0, total: sousTotal,
    mode: modePaiementReel, notes,
    livreur: curLivreur?.nom || '',
    estPartiel, estCredit
  };
  lastLivraisonId = livId;

  // Reset
  ['clientName','clientPhone','clientAddr','montant','notesLiv','clientSearch']
    .forEach(id => document.getElementById(id).value = '');
  document.getElementById('modePay').value = '';
  document.getElementById('gpsDsp').textContent = 'Position non captur√©e';
  document.getElementById('clientSuggestions').style.display = 'none';
  document.getElementById('totalCalcule').style.display = 'none';
  document.getElementById('resteIndicateur').style.display = 'none';
  gpsCoords = null; chkProds = {}; _totalCommande = 0;
  renderProdCheck();
  await loadCamion();
  await loadMyDeliveries();
  await loadMyClients();
  await loadCredits();
  await updateOfflineBadge();
  btn.disabled = false; btn.textContent = '‚úÖ Valider';
  if (liv.lat && liv.lng) addDeliveryMarker(liv.lat, liv.lng, nom, montantVerse);

  // Toast contextuel selon mode
  let toastMsg;
  if (savedOffline) {
    toastMsg = `üìµ Sauvegard√©e hors ligne ‚Äî sera sync √† la reconnexion`;
  } else if (estCredit) {
    toastMsg = 'üìã Livraison cr√©dit enregistr√©e';
  } else if (estPartiel) {
    toastMsg = `üí∞ ${montantVerse.toLocaleString()} DA vers√©s ‚Äî reste ${Math.max(0,resteDu).toLocaleString()} DA`;
  } else {
    toastMsg = '‚úÖ Livraison enregistr√©e';
  }
  showToast(toastMsg);

  setTimeout(() => {
    document.getElementById('facturePreview').innerHTML = genFactureHTML(factureData);
    document.getElementById('factureModal').classList.add('open');
  }, 400);
}

async function loadMyDeliveries(){
  let d = lLivraisons.filter(x => x.livreur_id === curLivreur?.id || x.livreur === curLivreur?.nom);
  if (useSb && curLivreur?.id) {
    const today = new Date().toISOString().split('T')[0];
    const { data } = await sb.from('livraisons').select('*').eq('livreur_id', curLivreur.id)
      .gte('created_at', today).order('created_at', { ascending: false });
    if (data) d = data;
  }

  // Fusionner avec les livraisons en attente hors ligne
  const pending = await getPendingLivraisons();
  const pendingMine = pending.filter(p =>
    p.livreur_id === curLivreur?.id || p.livreur === curLivreur?.nom
  ).map(p => ({ ...p, _offline: true }));

  // Ajouter les offline en t√™te (les plus r√©centes)
  const all = [...pendingMine, ...d];
  document.getElementById('myCount').textContent = all.length;

  const c = document.getElementById('myDelivs');
  if (!all.length) { c.innerHTML = '<div class="empty"><div class="eico">üìã</div>Aucune livraison pour le moment</div>'; return; }

  c.innerHTML = all.map(x => `
    <div class="hcard ai" style="${x._offline ? 'border-left:3px solid rgba(239,68,68,0.5);opacity:0.85' : ''}">
      ${x._offline ? `<div style="font-size:10px;font-weight:700;color:#FCA5A5;background:rgba(239,68,68,0.12);border-radius:4px;padding:2px 8px;display:inline-block;margin-bottom:6px">‚è≥ En attente de sync</div>` : ''}
      <div class="hcli">${x.client_nom||x.client||''}</div>
      <div class="htim">üìû ${x.client_phone||''} ¬∑ ${fmtTime(x.created_at||x.heure)}</div>
      <div class="hdet">üì¶ ${x.produits||''}</div>
      <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:12px;color:var(--muted)">${x.mode_paiement||x.mode||''}</span>
        <div style="display:flex;align-items:center;gap:8px">
          ${!x._offline ? `<button onclick="reprintByLivraison('${x.id}')" style="padding:5px 12px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:8px;color:var(--accent2);font-size:12px;font-weight:600;cursor:pointer">üßæ Facture</button>` : ''}
          <span style="color:var(--accent3);font-weight:700;font-size:15px">${(x.montant||0).toLocaleString()} DA</span>
        </div>
      </div>
    </div>`).join('');
}

async function reprintByLivraison(livId){
  if(!useSb||!livId){showToast('‚ö†Ô∏è Connectez Supabase pour acc√©der aux factures',true);return}
  const{data:fac}=await sb.from('factures').select('*').eq('livraison_id',livId).single();
  if(!fac){showToast('‚ö†Ô∏è Facture introuvable',true);return}
  const fData={
    num:fac.numero, nom:fac.client_nom, tel:fac.client_phone||'', addr:fac.client_adresse||'',
    lignes:typeof fac.lignes==='string'?JSON.parse(fac.lignes):fac.lignes,
    sousTotal:fac.sous_total||fac.total, remise:fac.remise||0, total:fac.total,
    mode:fac.mode_paiement||'', notes:fac.notes||'', livreur:fac.livreur||curLivreur?.nom||''
  };
  document.getElementById('facturePreview').innerHTML=genFactureHTML(fData);
  document.getElementById('factureModal').classList.add('open');
}

// ============================================================
// TABS & UTILS
// ============================================================
// ============================================================
// FACTURATION
// ============================================================
let lastLivraisonId = null;

function buildFactureData() {
  const nom = document.getElementById('clientName').value.trim();
  const tel = document.getElementById('clientPhone').value.trim();
  const addr = document.getElementById('clientAddr').value.trim();
  const mnt = parseInt(document.getElementById('montant').value) || 0;
  const mode = document.getElementById('modePay').value;
  const notes = document.getElementById('notesLiv').value.trim();

  const lignes = Object.keys(chkProds).map(id => {
    const p = camionProduits.find(x => x.id === id);
    const qty = chkProds[id] || 0;
    const pu = p?.prix || 0;
    return { produit: p?.nom||id, unite: p?.unite||'', quantite: qty, prix_unitaire: pu, total: pu * qty };
  }).filter(l => l.quantite > 0);

  const sousTotal = lignes.reduce((s,l) => s+l.total, 0);
  const remise = sousTotal > mnt && mnt > 0 ? sousTotal - mnt : 0;
  const total = mnt || sousTotal;
  const num = 'FAC-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-5);

  return { num, nom, tel, addr, lignes, sousTotal, remise, total, mode, notes, livreur: curLivreur?.nom||'' };
}

function genFactureHTML(f, numFacture) {
  const date = new Date().toLocaleDateString('fr-DZ', { day:'2-digit', month:'long', year:'numeric' });
  const sousTotal   = f.sousTotal || f.total || 0;
  const montantVerse = f.montantVerse ?? f.total ?? sousTotal;
  const resteDu     = f.resteDu ?? Math.max(0, sousTotal - montantVerse);
  const estPartiel  = f.estPartiel || (resteDu > 0 && montantVerse > 0 && montantVerse < sousTotal);
  const estCredit   = f.estCredit  || (montantVerse === 0);

  // Tampon de statut
  let stampStyle, stampText;
  if (estCredit)       { stampStyle = 'border-color:#DC2626;color:#DC2626';  stampText = '‚è≥ CR√âDIT TOTAL'; }
  else if (estPartiel) { stampStyle = 'border-color:#F97316;color:#F97316';  stampText = '‚óë PAIEMENT PARTIEL'; }
  else                 { stampStyle = 'border-color:#10B981;color:#10B981';  stampText = '‚úì PAY√âE'; }

  return `
    <div class="facture-doc" id="factureContent">
      <div class="facture-header">
        <div>
          <div class="facture-logo">DeliTrack</div>
          <div style="font-size:12px;color:#64748B;margin-top:4px">${f.livreur}</div>
          <div style="font-size:12px;color:#64748B">${date}</div>
        </div>
        <div class="facture-num">
          <div style="font-size:18px;font-weight:800;color:#1A1A1A">FACTURE</div>
          <div style="margin-top:4px">${numFacture || f.num}</div>
        </div>
      </div>

      <div class="facture-parties">
        <div>
          <div class="facture-party-title">Vendeur</div>
          <div class="facture-party-name">${f.livreur}</div>
          <div class="facture-party-info">Livreur agr√©√©</div>
        </div>
        <div>
          <div class="facture-party-title">Commer√ßant</div>
          <div class="facture-party-name">${f.nom || '‚Äî'}</div>
          <div class="facture-party-info">üìû ${f.tel || '‚Äî'}</div>
          <div class="facture-party-info">üìç ${f.addr || '‚Äî'}</div>
        </div>
      </div>

      <table class="facture-table">
        <thead>
          <tr>
            <th>D√©signation</th>
            <th style="text-align:center">Qt√©</th>
            <th style="text-align:right">P.U (DA)</th>
            <th style="text-align:right">Total (DA)</th>
          </tr>
        </thead>
        <tbody>
          ${f.lignes.map(l => `
            <tr>
              <td><strong>${l.nom || l.produit}</strong><br><span style="font-size:11px;color:#64748B">${l.unite||''}</span></td>
              <td style="text-align:center;font-weight:700">${l.quantite}</td>
              <td style="text-align:right">${(l.prix_unitaire||0).toLocaleString()}</td>
              <td style="text-align:right;font-weight:700">${(l.total||0).toLocaleString()}</td>
            </tr>`).join('')}
        </tbody>
      </table>

      <div class="facture-totals">
        <div class="facture-total-row">
          <span>Total commande</span>
          <span style="font-weight:700">${sousTotal.toLocaleString()} DA</span>
        </div>
        <div class="facture-total-row" style="color:#2563EB">
          <span>Montant vers√©</span>
          <span style="font-weight:700">${montantVerse.toLocaleString()} DA</span>
        </div>
        ${resteDu > 0 ? `
        <div class="facture-total-final" style="background:#FEF2F2">
          <span style="color:#DC2626">Reste √† r√©gler</span>
          <span style="color:#DC2626">${resteDu.toLocaleString()} DA</span>
        </div>` : `
        <div class="facture-total-final">
          <span>TOTAL R√âGL√â</span>
          <span style="color:#2D6A4F">${montantVerse.toLocaleString()} DA</span>
        </div>`}
        <div style="margin-top:8px;font-size:12px;color:#64748B;text-align:right">
          Mode : <strong>${f.mode || '‚Äî'}</strong>
        </div>
        ${resteDu > 0 ? `<div style="margin-top:6px;font-size:11px;color:#DC2626;text-align:right;font-style:italic">‚ö†Ô∏è Le reste sera r√©gl√© lors de la prochaine livraison</div>` : ''}
      </div>

      ${f.notes ? `<div style="margin-top:16px;padding:10px 14px;background:#F8F7F4;border-radius:8px;font-size:12px;color:#64748B"><strong>Notes :</strong> ${f.notes}</div>` : ''}

      <div class="facture-footer">
        <span class="facture-stamp" style="${stampStyle}">${stampText}</span>
        <div style="margin-top:12px">Merci de votre confiance ¬∑ DeliTrack</div>
      </div>
    </div>`;
}

function previewFacture() {
  const f = buildFactureData();
  if (!f.nom) { showToast('‚ö†Ô∏è Remplissez les infos commer√ßant d\'abord', true); return; }
  if (!f.lignes.length) { showToast('‚ö†Ô∏è S√©lectionnez au moins un produit', true); return; }
  document.getElementById('facturePreview').innerHTML = genFactureHTML(f);
  document.getElementById('factureModal').classList.add('open');
}

function printFacture() {
  const content = document.getElementById('factureContent');
  if (!content) return;
  // Cr√©er zone impression temporaire
  let printArea = document.getElementById('printArea');
  if (!printArea) { printArea = document.createElement('div'); printArea.id = 'printArea'; document.body.appendChild(printArea); }
  printArea.innerHTML = content.outerHTML;
  window.print();
  setTimeout(() => { if (printArea) printArea.innerHTML = ''; }, 1000);
}

async function openHistFactures() {
  let factures = [];
  if (useSb && curLivreur?.id) {
    const today = new Date().toISOString().split('T')[0];
    const { data } = await sb.from('factures').select('*').eq('livreur_id', curLivreur.id).gte('created_at', today+'T00:00:00').order('created_at', { ascending: false });
    if (data) factures = data;
  }
  const c = document.getElementById('histFacturesList');
  if (!factures.length) {
    c.innerHTML = '<div class="empty"><div class="eico">üßæ</div>Aucune facture aujourd\'hui</div>';
  } else {
    c.innerHTML = factures.map(f => `
      <div class="hcard ai" style="cursor:pointer;margin-bottom:10px" onclick="reprintFacture('${f.id}')">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="hcli">${f.client_nom}</div>
            <div class="htim">${f.numero} ¬∑ ${fmtTime(f.created_at)}</div>
            <div class="hdet">üìû ${f.client_phone||'‚Äî'} ¬∑ ${f.mode_paiement||''}</div>
          </div>
          <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:16px;color:var(--accent3)">${(f.total||0).toLocaleString()} DA</div>
        </div>
      </div>`).join('');
  }
  document.getElementById('histFacturesModal').classList.add('open');
}

async function reprintFacture(id) {
  let f;
  if (useSb) {
    const { data } = await sb.from('factures').select('*').eq('id', id).single();
    f = data;
  }
  if (!f) return;
  const fData = {
    num: f.numero, nom: f.client_nom, tel: f.client_phone||'', addr: f.client_adresse||'',
    lignes: typeof f.lignes === 'string' ? JSON.parse(f.lignes) : f.lignes,
    sousTotal: f.sous_total||f.total, remise: f.remise||0, total: f.total,
    mode: f.mode_paiement||'', notes: f.notes||'', livreur: f.livreur||curLivreur?.nom||''
  };
  closeMod('histFacturesModal');
  document.getElementById('facturePreview').innerHTML = genFactureHTML(fData, f.numero);
  document.getElementById('factureModal').classList.add('open');
}

// ============================================================
// CR√âDITS LIVREUR ‚Äî Encaissement & Re√ßu
// ============================================================
let creditsData = []; // liste des factures en cr√©dit du livreur
let creditEnCours = null; // facture s√©lectionn√©e pour encaissement

async function loadCredits() {
  const c = document.getElementById('creditsList');
  const badge = document.getElementById('creditCount');
  const navBadge = document.getElementById('creditNavBadge');
  if (!c) return;
  c.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">‚è≥ Chargement...</div>';

  if (!useSb || !curLivreur?.id) {
    c.innerHTML = '<div class="empty"><div class="eico">üîå</div>Connectez Supabase pour voir les cr√©dits</div>';
    return;
  }

  const { data } = await sb.from('factures')
    .select('*')
    .eq('livreur_id', curLivreur.id)
    .in('statut', ['credit', 'credit_partiel'])
    .order('created_at', { ascending: false });

  creditsData = data || [];
  const total = creditsData.reduce((s, f) => s + (f.total || 0), 0);
  const nbClients = new Set(creditsData.map(f => f.client_nom)).size;

  // Badges
  badge.textContent = creditsData.length;
  if (navBadge) {
    navBadge.textContent = creditsData.length;
    navBadge.style.display = creditsData.length > 0 ? 'inline-flex' : 'none';
  }

  // R√©sum√©
  const resume = document.getElementById('creditResume');
  if (creditsData.length > 0) {
    resume.style.display = 'block';
    document.getElementById('creditTotal').textContent = total.toLocaleString() + ' DA';
    document.getElementById('creditNbClients').textContent = `${creditsData.length} livraison(s) ‚Ä¢ ${nbClients} client(s)`;
  } else {
    resume.style.display = 'none';
  }

  if (!creditsData.length) {
    c.innerHTML = '<div class="empty"><div class="eico">‚úÖ</div>Aucun cr√©dit en attente</div>';
    return;
  }

  c.innerHTML = creditsData.map(f => {
    const date = new Date(f.created_at).toLocaleDateString('fr-DZ', { day:'2-digit', month:'short', year:'numeric' });
    const lignes = typeof f.lignes === 'string' ? JSON.parse(f.lignes) : (f.lignes || []);
    const detail = lignes.map(l => `${l.icone||'üì¶'} ${l.nom} √ó ${l.quantite}`).join(', ');
    const resteDu = f.reste_du || f.total || 0;
    const verse   = f.montant_verse || f.montant_encaisse || 0;
    const isPartiel = f.statut === 'credit_partiel';
    const badgeColor = isPartiel ? 'var(--accent)' : 'var(--danger)';
    const badgeText  = isPartiel ? '‚óë Partiel' : '‚è≥ Cr√©dit';
    return `
      <div class="hcard" style="margin-bottom:12px;border-left:3px solid ${badgeColor}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
          <div>
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
              <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:15px">${f.client_nom}</div>
              <span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:8px;background:rgba(0,0,0,0.06);color:${badgeColor}">${badgeText}</span>
            </div>
            <div style="font-size:12px;color:var(--muted)">${f.client_phone||''} ‚Ä¢ ${date}</div>
            ${f.client_adresse ? `<div style="font-size:11px;color:var(--muted)">üìç ${f.client_adresse}</div>` : ''}
          </div>
          <div style="text-align:right">
            <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:18px;color:${badgeColor}">${resteDu.toLocaleString()} DA</div>
            ${isPartiel ? `<div style="font-size:10px;color:var(--muted)">vers√© : ${verse.toLocaleString()} DA</div>` : ''}
          </div>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:10px">${detail}</div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:10px">Facture : ${f.numero}</div>
        <div style="display:flex;gap:8px">
          <button onclick="openEncaisser('${f.id}')" style="flex:1;padding:10px;background:rgba(16,185,129,0.15);border:1.5px solid rgba(16,185,129,0.3);border-radius:10px;color:var(--accent3);font-size:13px;font-weight:700;cursor:pointer">üí∞ Encaisser</button>
          <button onclick="imprimerRecu('${f.id}')" style="flex:1;padding:10px;background:rgba(59,130,246,0.1);border:1.5px solid rgba(59,130,246,0.25);border-radius:10px;color:var(--accent2);font-size:13px;font-weight:700;cursor:pointer">üñ®Ô∏è Re√ßu</button>
        </div>
      </div>`;
  }).join('');
}

function openEncaisser(factureId) {
  creditEnCours = creditsData.find(f => f.id === factureId);
  if (!creditEnCours) return;
  // Le montant d√ª = reste_du (paiement partiel) ou total (cr√©dit complet)
  const montantDu = creditEnCours.reste_du || creditEnCours.total || 0;
  const verse     = creditEnCours.montant_verse || creditEnCours.montant_encaisse || 0;
  // On stocke le vrai montant restant sur l'objet pour le calcul
  creditEnCours._montantDu = montantDu;

  document.getElementById('encaisserSub').textContent = creditEnCours.client_nom;
  document.getElementById('encaisserMontantDu').textContent = montantDu.toLocaleString() + ' DA';
  const isPartiel = creditEnCours.statut === 'credit_partiel';
  const date = new Date(creditEnCours.created_at).toLocaleDateString('fr-DZ', { day:'2-digit', month:'long', year:'numeric' });
  document.getElementById('encaisserDateDette').textContent =
    `Livraison du ${date} ‚Ä¢ ${creditEnCours.numero}` +
    (isPartiel ? ` ‚Ä¢ d√©j√† vers√© : ${verse.toLocaleString()} DA` : '');
  document.getElementById('encaisserMontant').value = montantDu;
  document.getElementById('encaisserMode').value = 'Esp√®ces';
  document.getElementById('encaisserNotes').value = '';
  document.getElementById('encaisserResteBox').style.display = 'none';
  document.getElementById('encaisserModal').classList.add('open');
  updateEncaisserReste();
}

function updateEncaisserReste() {
  if (!creditEnCours) return;
  const saisi = parseFloat(document.getElementById('encaisserMontant').value) || 0;
  const du = creditEnCours._montantDu || creditEnCours.reste_du || creditEnCours.total || 0;
  const reste = du - saisi;
  const box = document.getElementById('encaisserResteBox');
  const resteEl = document.getElementById('encaisserReste');
  box.style.display = 'block';
  resteEl.textContent = Math.abs(reste).toLocaleString() + ' DA';
  if (reste > 0) {
    box.style.background = 'rgba(239,68,68,0.08)'; box.style.border = '1px solid rgba(239,68,68,0.2)';
    resteEl.style.color = 'var(--danger)';
    resteEl.previousElementSibling.textContent = 'Reste √† payer';
  } else if (reste < 0) {
    box.style.background = 'rgba(249,115,22,0.08)'; box.style.border = '1px solid rgba(249,115,22,0.2)';
    resteEl.style.color = 'var(--accent)';
    resteEl.previousElementSibling.textContent = 'Monnaie √† rendre';
  } else {
    box.style.background = 'rgba(16,185,129,0.08)'; box.style.border = '1px solid rgba(16,185,129,0.2)';
    resteEl.style.color = 'var(--accent3)';
    resteEl.previousElementSibling.textContent = '‚úÖ Compte exact';
  }
}

async function confirmerEncaissement(imprimer = false) {
  if (!creditEnCours) return;
  const montant = parseFloat(document.getElementById('encaisserMontant').value);
  if (!montant || montant <= 0) { showToast('‚ö†Ô∏è Entrez un montant', true); return; }
  const mode = document.getElementById('encaisserMode').value;
  const notes = document.getElementById('encaisserNotes').value.trim();
  const btn = document.getElementById('btnEncaisserConfirm');
  btn.disabled = true; btn.textContent = '‚è≥';

  // D√©terminer si partiellement ou totalement pay√©
  const montantDu     = creditEnCours._montantDu || creditEnCours.reste_du || creditEnCours.total || 0;
  const nouveauReste  = Math.max(0, montantDu - montant);
  const nouveauVerse  = (creditEnCours.montant_verse || creditEnCours.montant_encaisse || 0) + montant;
  const nouveauStatut = nouveauReste <= 0 ? 'payee' : 'credit_partiel';

  if (useSb) {
    await sb.from('factures').update({
      statut: nouveauStatut,
      mode_paiement: mode,
      montant_encaisse: montant,
      montant_verse: nouveauVerse,
      reste_du: nouveauReste,
      notes_encaissement: notes,
      date_encaissement: new Date().toISOString(),
    }).eq('id', creditEnCours.id);
  }

  if (imprimer) {
    imprimerRecuData(creditEnCours, montant, mode, notes);
  }

  closeMod('encaisserModal');
  btn.disabled = false; btn.textContent = '‚úÖ Encaisser';
  showToast(nouveauReste <= 0
    ? '‚úÖ Cr√©dit sold√© enti√®rement !'
    : `üí∞ ${montant.toLocaleString()} DA encaiss√©s ‚Äî reste ${nouveauReste.toLocaleString()} DA`);
  await loadCredits();
}

function confirmerEncaisserImprimer() {
  confirmerEncaissement(true);
}

async function imprimerRecu(factureId) {
  // Imprimer le re√ßu sans encaisser (si d√©j√† encaiss√© ou juste pour rappel)
  const f = creditsData.find(x => x.id === factureId) ||
    (useSb ? (await sb.from('factures').select('*').eq('id', factureId).single())?.data : null);
  if (!f) return;
  imprimerRecuData(f, f.montant_encaisse || f.total, f.mode_paiement || 'Cr√©dit', f.notes || '');
}

function imprimerRecuData(facture, montantEncaisse, mode, notes) {
  const date = new Date().toLocaleDateString('fr-DZ', { day:'2-digit', month:'long', year:'numeric' });
  const heure = new Date().toLocaleTimeString('fr-DZ', { hour:'2-digit', minute:'2-digit' });
  const lignes = typeof facture.lignes === 'string' ? JSON.parse(facture.lignes) : (facture.lignes || []);
  const reste = (facture.total || 0) - montantEncaisse;

  const recuHTML = `
    <div style="font-family:'Courier New',monospace;width:280px;max-width:100%;margin:0 auto;padding:10px;font-size:12px;color:#000;background:#fff">
      <div style="text-align:center;border-bottom:1px dashed #000;padding-bottom:8px;margin-bottom:8px">
        <div style="font-size:18px;font-weight:800;letter-spacing:2px">DELITRACK</div>
        <div style="font-size:10px">${curLivreur?.nom || facture.livreur || ''}</div>
        <div style="font-size:10px">${date} ${heure}</div>
      </div>

      <div style="border-bottom:1px dashed #000;padding-bottom:8px;margin-bottom:8px">
        <div><strong>Client :</strong> ${facture.client_nom}</div>
        ${facture.client_phone ? `<div><strong>T√©l :</strong> ${facture.client_phone}</div>` : ''}
        ${facture.client_adresse ? `<div><strong>Adresse :</strong> ${facture.client_adresse}</div>` : ''}
      </div>

      <div style="border-bottom:1px dashed #000;padding-bottom:8px;margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;font-weight:700;margin-bottom:4px;border-bottom:1px solid #ccc;padding-bottom:3px">
          <span>Article</span><span>Qt√©</span><span>Prix</span>
        </div>
        ${lignes.map(l => `
          <div style="display:flex;justify-content:space-between;margin-bottom:2px">
            <span style="flex:1">${l.nom}</span>
            <span style="width:30px;text-align:center">${l.quantite}</span>
            <span style="width:70px;text-align:right">${((l.prix_unitaire||0)*(l.quantite||0)).toLocaleString()} DA</span>
          </div>`).join('')}
      </div>

      <div style="border-bottom:1px dashed #000;padding-bottom:8px;margin-bottom:8px">
        <div style="display:flex;justify-content:space-between"><span>Total commande</span><span><strong>${(facture.total||0).toLocaleString()} DA</strong></span></div>
        <div style="display:flex;justify-content:space-between"><span>Montant re√ßu</span><span><strong>${montantEncaisse.toLocaleString()} DA</strong></span></div>
        ${reste > 0 ? `<div style="display:flex;justify-content:space-between;color:#e00"><span>Reste √† payer</span><span><strong>${reste.toLocaleString()} DA</strong></span></div>` : ''}
        ${reste < 0 ? `<div style="display:flex;justify-content:space-between"><span>Monnaie rendue</span><span><strong>${Math.abs(reste).toLocaleString()} DA</strong></span></div>` : ''}
        <div style="display:flex;justify-content:space-between;margin-top:4px"><span>Mode paiement</span><span>${mode}</span></div>
      </div>

      ${notes ? `<div style="margin-bottom:8px;font-size:11px">Note : ${notes}</div>` : ''}

      <div style="text-align:center;font-size:10px;margin-top:6px">
        <div>R√©f : ${facture.numero}</div>
        <div style="margin-top:4px">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>
        <div style="margin-top:4px">Merci de votre confiance</div>
      </div>
    </div>`;

  let printArea = document.getElementById('printArea');
  if (!printArea) { printArea = document.createElement('div'); printArea.id = 'printArea'; document.body.appendChild(printArea); }
  printArea.innerHTML = recuHTML;
  window.print();
  setTimeout(() => { if (printArea) printArea.innerHTML = ''; }, 1500);
}

// ============================================================
// GESTION √âQUIPE (LIVREURS)
// ============================================================
let deleteLivreurId = null;

async function loadEquipe() {
  let livs = lLivreurs;
  if (useSb) {
    const {data} = await sb.from('livreurs').select('*').order('nom');
    if (data) livs = data;
  }
  const c = document.getElementById('equipeList');
  if (!livs.length) {
    c.innerHTML = '<div class="empty"><div class="eico">üë•</div>Aucun livreur</div>';
    return;
  }
  c.innerHTML = livs.map(l => {
    const col = l.couleur || '#F97316';
    const ini = l.initiales || l.nom?.substring(0,2).toUpperCase() || '??';
    const st = l.statut || 'actif';
    return `
    <div class="lcard ai" style="cursor:default">
      <div class="lhdr">
        <div class="avatar" style="background:${col}22;color:${col}">${ini}</div>
        <div class="linfo">
          <div class="lname">${l.nom}</div>
          <div class="lzone">üìç ${l.zone||'‚Äî'} ¬∑ üîë ${l.identifiant||'‚Äî'}</div>
        </div>
        <span class="spill ${st==='actif'?'pa':st==='pause'?'pp':'pd'}">${st==='actif'?'Actif':st==='pause'?'Pause':'Inactif'}</span>
      </div>
      <div style="display:flex;gap:8px;margin-top:4px">
        <button onclick="openEditLivreur('${l.id}')" style="flex:1;padding:10px;background:rgba(59,130,246,0.1);border:1.5px solid rgba(59,130,246,0.3);border-radius:10px;color:var(--accent2);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer">‚úèÔ∏è Modifier</button>
        <button onclick="openDeleteLivreur('${l.id}','${l.nom}')" style="flex:1;padding:10px;background:rgba(239,68,68,0.1);border:1.5px solid rgba(239,68,68,0.3);border-radius:10px;color:var(--danger);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer">üóëÔ∏è Supprimer</button>
        <select onchange="changeStatut('${l.id}',this.value)" style="flex:1;padding:10px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:12px;outline:none">
          <option value="actif" ${st==='actif'?'selected':''}>üü¢ Actif</option>
          <option value="pause" ${st==='pause'?'selected':''}>üü° Pause</option>
          <option value="termine" ${st==='termine'?'selected':''}>‚ö™ Inactif</option>
        </select>
      </div>
    </div>`;
  }).join('');
}

function onVilleChange(sel) {
  const val = sel.value;
  const custom = document.getElementById('customCoordsDiv');
  if (val === 'custom') {
    custom.style.display = 'block';
  } else if (val) {
    custom.style.display = 'none';
    const [lat, lng] = val.split(',');
    document.getElementById('livLat').value = lat;
    document.getElementById('livLng').value = lng;
  } else {
    custom.style.display = 'none';
  }
}

function openAddLivreur() {
  // V√©rifier limite plan
  if (PLAN.maxLivreurs !== Infinity) {
    const livs = useSb ? null : lLivreurs; // count checked in planCheck call
    const currentLivs = document.querySelectorAll('#livreursList .lcard').length;
    if (!planCheck('maxLivreurs', currentLivs, PLAN.maxLivreurs, 'livreurs')) return;
  }
  document.getElementById('addLivTitle').textContent = '‚ûï Nouveau livreur';
  document.getElementById('editLivId').value = '';
  document.getElementById('livNom').value = '';
  document.getElementById('livInitiales').value = '';
  document.getElementById('livZone').value = '';
  document.getElementById('livIdentifiant').value = '';
  document.getElementById('livPassword').value = '';
  document.getElementById('livVille').value = '';
  document.getElementById('livLat').value = '36.7538';
  document.getElementById('livLng').value = '3.0588';
  document.getElementById('customCoordsDiv').style.display = 'none';
  document.getElementById('livCouleur').value = '#F97316';
  document.querySelectorAll('.color-opt').forEach(o => o.style.border = o.dataset.color === '#F97316' ? '3px solid white' : '3px solid transparent');
  document.getElementById('addLivModal').classList.add('open');
}

async function openEditLivreur(id) {
  let l = lLivreurs.find(x => x.id === id);
  if (useSb) {
    const {data} = await sb.from('livreurs').select('*').eq('id', id).single();
    if (data) l = data;
  }
  if (!l) return;
  document.getElementById('addLivTitle').textContent = '‚úèÔ∏è Modifier le livreur';
  document.getElementById('editLivId').value = l.id;
  document.getElementById('livNom').value = l.nom || '';
  document.getElementById('livInitiales').value = l.initiales || '';
  document.getElementById('livZone').value = l.zone || '';
  document.getElementById('livIdentifiant').value = l.identifiant || '';
  document.getElementById('livPassword').value = l.mot_de_passe || '';
  document.getElementById('livLat').value = l.lat || '36.7538';
  document.getElementById('livLng').value = l.lng || '3.0588';
  document.getElementById('livVille').value = 'custom';
  document.getElementById('customCoordsDiv').style.display = 'block';
  document.getElementById('livLatManual').value = l.lat || '';
  document.getElementById('livLngManual').value = l.lng || '';
  document.getElementById('livCouleur').value = l.couleur || '#F97316';
  document.querySelectorAll('.color-opt').forEach(o => o.style.border = o.dataset.color === (l.couleur||'#F97316') ? '3px solid white' : '3px solid transparent');
  document.getElementById('addLivModal').classList.add('open');
}

function selColor(el) {
  document.querySelectorAll('.color-opt').forEach(o => o.style.border = '3px solid transparent');
  el.style.border = '3px solid white';
  document.getElementById('livCouleur').value = el.dataset.color;
}

async function saveLivreur() {
  const nom = document.getElementById('livNom').value.trim();
  const initiales = document.getElementById('livInitiales').value.trim().toUpperCase();
  const zone = document.getElementById('livZone').value.trim();
  const identifiant = document.getElementById('livIdentifiant').value.trim();
  const password = document.getElementById('livPassword').value.trim();
  const couleur = document.getElementById('livCouleur').value;
  const editId = document.getElementById('editLivId').value;

  const lat = parseFloat(document.getElementById('livLat').value) || 36.7538;
  const lng = parseFloat(document.getElementById('livLng').value) || 3.0588;

  if (!nom || !identifiant || !password) {
    showToast('‚ö†Ô∏è Nom, identifiant et mot de passe requis', true);
    return;
  }

  // Donn√©es sans mot de passe (le mdp sera chiffr√© s√©par√©ment)
  const dataBase = {nom, initiales: initiales || nom.substring(0,2).toUpperCase(), zone, identifiant, couleur, statut: 'actif', lat, lng};

  if (useSb) {
    if (editId) {
      // Mise √† jour sans mot de passe d'abord
      const {error} = await sb.from('livreurs').update(dataBase).eq('id', editId);
      if (error) { showToast('‚ùå ' + error.message, true); return; }
      // Chiffrer le nouveau mot de passe via RPC
      await sb.rpc('changer_mot_de_passe', {p_table: 'livreurs', p_id: editId, p_nouveau: password});
    } else {
      // Ins√©rer avec mot de passe temporaire, puis chiffrer
      const {data: newLiv, error} = await sb.from('livreurs').insert({...dataBase, mot_de_passe: 'tmp'}).select().single();
      if (error) { showToast('‚ùå ' + (error.message.includes('unique') ? 'Identifiant d√©j√† utilis√©' : error.message), true); return; }
      // Chiffrer le mot de passe via RPC
      await sb.rpc('changer_mot_de_passe', {p_table: 'livreurs', p_id: newLiv.id, p_nouveau: password});
    }
  } else {
    const data = {...dataBase, mot_de_passe: password};
    if (editId) {
      const l = lLivreurs.find(x => x.id === editId);
      if (l) Object.assign(l, data);
    } else {
      lLivreurs.push({id: 'l' + Date.now(), ...data, livraisons: 0, montant: 0});
    }
  }

  closeMod('addLivModal');
  await loadLivreurs();
  await loadEquipe();
  await updateMapMarkers();
  showToast(editId ? 'Livreur modifi√© ‚úì' : 'Livreur ajout√© ‚úì');
}

function openDeleteLivreur(id, nom) {
  deleteLivreurId = id;
  document.getElementById('delLivNom').textContent = `Vous allez supprimer : ${nom}`;
  document.getElementById('delLivModal').classList.add('open');
}

async function confirmDeleteLivreur() {
  if (!deleteLivreurId) return;
  if (useSb) {
    const {error} = await sb.from('livreurs').delete().eq('id', deleteLivreurId);
    if (error) { showToast('‚ùå ' + error.message, true); return; }
  } else {
    lLivreurs = lLivreurs.filter(l => l.id !== deleteLivreurId);
  }
  closeMod('delLivModal');
  deleteLivreurId = null;
  await loadLivreurs();
  await loadEquipe();
  await updateMapMarkers();
  showToast('Livreur supprim√© ‚úì');
}

async function changeStatut(id, statut) {
  if (useSb) {
    await sb.from('livreurs').update({statut}).eq('id', id);
  } else {
    const l = lLivreurs.find(x => x.id === id);
    if (l) l.statut = statut;
  }
  await loadLivreurs();
  showToast('Statut mis √† jour ‚úì');
}

// ============================================================
// TRAJET GPS
// ============================================================
let trajetMap = null;
let trajetLivreurId = null;
let trajetLivreurNom = '';
let trajetPolyline = null;
let trajetMarkers = [];

function openTrajet() {
  closeMod('livModal');
  document.getElementById('trajetDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('trajetTitle').textContent = `üó∫Ô∏è Trajet ‚Äî ${trajetLivreurNom}`;
  document.getElementById('trajetSub').textContent = `Historique GPS du livreur`;
  document.getElementById('trajetModal').classList.add('open');

  // Si carte d√©j√† cr√©√©e : nettoyer + recalibrer
  if (trajetMap) {
    if (trajetPolyline) { trajetMap.removeLayer(trajetPolyline); trajetPolyline = null; }
    trajetMarkers.forEach(m => { try { trajetMap.removeLayer(m); } catch(e){} });
    trajetMarkers = [];
    setTimeout(() => { trajetMap.invalidateSize(true); loadTrajet(); }, 150);
    return;
  }

  // Attendre que le div trajetMap ait une vraie taille
  function initTrajetCarte() {
    if (trajetMap) return;
    const el = document.getElementById('trajetMap');
    if (!el) return;

    function _buildTrajet() {
      if (trajetMap) return;
      const w = el.offsetWidth;
      const h = el.offsetHeight;

      if (w === 0 || h === 0) {
        const ro = new ResizeObserver(entries => {
          for (const e of entries) {
            if (e.contentRect.width > 0 && e.contentRect.height > 0) {
              ro.disconnect();
              requestAnimationFrame(() => _buildTrajet());
            }
          }
        });
        ro.observe(el);
        return;
      }

      // Forcer dimensions avant L.map()
      el.style.width  = w + 'px';
      el.style.height = h + 'px';

      trajetMap = L.map('trajetMap', {
        center: [36.7538, 3.0588], zoom: 11,
        zoomControl: true, attributionControl: false, preferCanvas: false,
      });
      tileLayerTrajet = getTileLayer();
      tileLayerTrajet.addTo(trajetMap);

      setTimeout(() => {
        el.style.width  = '';
        el.style.height = '';
        trajetMap.invalidateSize(true);
        loadTrajet();
      }, 100);
    }

    // Double rAF ‚Äî le modal vient d'√™tre ouvert
    requestAnimationFrame(() => requestAnimationFrame(() => _buildTrajet()));
  }

  setTimeout(initTrajetCarte, 50);
}

async function loadTrajet() {
  if (!trajetLivreurId || !trajetMap) return;
  const date = document.getElementById('trajetDate').value;
  if (!date) return;

  // Nettoyer
  if (trajetPolyline) { trajetMap.removeLayer(trajetPolyline); trajetPolyline = null; }
  trajetMarkers.forEach(m => { try { trajetMap.removeLayer(m); } catch(e){} });
  trajetMarkers = [];

  document.getElementById('trajetStats').innerHTML =
    `<div style="grid-column:1/-1;text-align:center;padding:16px;color:var(--muted)">‚è≥ Chargement...</div>`;

  if (!useSb) {
    document.getElementById('trajetStats').innerHTML =
      '<div style="color:var(--muted);font-size:13px;grid-column:1/-1;text-align:center;padding:20px">Connectez Supabase</div>';
    return;
  }

  const [posRes, livRes] = await Promise.all([
    sb.from('positions_gps')
      .select('lat,lng,created_at,vitesse')
      .eq('livreur_id', trajetLivreurId)
      .eq('date', date)
      .order('created_at', { ascending: true }),
    sb.from('livraisons')
      .select('*')
      .eq('livreur_id', trajetLivreurId)
      .gte('created_at', date + 'T00:00:00Z')
      .lte('created_at', date + 'T23:59:59Z')
      .order('created_at', { ascending: true })
  ]);

  // Filtrer les coordonn√©es valides et convertir en nombres purs
  const pts = (posRes.data || [])
    .map(p => ({ lat: parseFloat(p.lat), lng: parseFloat(p.lng), created_at: p.created_at }))
    .filter(p => !isNaN(p.lat) && !isNaN(p.lng) && p.lat !== 0);

  const livs = livRes.data || [];

  // Stats
  let distKm = 0;
  for (let i = 1; i < pts.length; i++) {
    distKm += haversine(pts[i-1].lat, pts[i-1].lng, pts[i].lat, pts[i].lng);
  }
  const totalDA = livs.reduce((s,l) => s + (l.montant||0), 0);
  const duree = pts.length >= 2
    ? Math.round((new Date(pts[pts.length-1].created_at) - new Date(pts[0].created_at)) / 60000)
    : 0;

  document.getElementById('trajetStats').innerHTML = `
    <div class="mstat" style="background:var(--card);border-radius:10px;padding:10px;text-align:center">
      <div class="msv" style="color:var(--accent2)">${pts.length}</div><div class="msl">Points GPS</div>
    </div>
    <div class="mstat" style="background:var(--card);border-radius:10px;padding:10px;text-align:center">
      <div class="msv" style="color:var(--accent3)">${distKm.toFixed(1)} km</div><div class="msl">Distance</div>
    </div>
    <div class="mstat" style="background:var(--card);border-radius:10px;padding:10px;text-align:center">
      <div class="msv" style="color:var(--accent)">${livs.length}</div><div class="msl">Livraisons</div>
    </div>
    <div class="mstat" style="background:var(--card);border-radius:10px;padding:10px;text-align:center">
      <div class="msv" style="color:var(--yellow)">${duree > 0 ? Math.floor(duree/60)+'h'+String(duree%60).padStart(2,'0') : '‚Äî'}</div><div class="msl">Dur√©e</div>
    </div>
    <div class="mstat" style="background:var(--card);border-radius:10px;padding:10px;text-align:center">
      <div class="msv" style="color:var(--accent3)">${totalDA.toLocaleString()}</div><div class="msl">DA</div>
    </div>`;

  if (pts.length === 0 && livs.length === 0) {
    document.getElementById('trajetLivraisons').innerHTML =
      '<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px">Aucune donn√©e GPS pour cette date.</div>';
    return;
  }

  const allLatLngs = [];

  // ‚îÄ‚îÄ Ligne bleue du trajet ‚îÄ‚îÄ
  if (pts.length >= 2) {
    const latlngs = pts.map(p => [p.lat, p.lng]);
    allLatLngs.push(...latlngs);

    trajetPolyline = L.polyline(latlngs, {
      color: '#3B82F6',
      weight: 5,
      opacity: 1,
      smoothFactor: 1,
    });
    trajetPolyline.addTo(trajetMap);   // addTo s√©par√© du constructeur = plus fiable

    // Marqueur d√©part vert
    const mDep = L.marker([pts[0].lat, pts[0].lng], {
      icon: L.divIcon({
        className: '',
        html: `<div style="width:16px;height:16px;background:#10B981;border:3px solid white;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.6)"></div>`,
        iconSize:[16,16], iconAnchor:[8,8]
      })
    });
    mDep.addTo(trajetMap);
    mDep.bindPopup(`<b style="color:#10B981">üü¢ D√©part</b><br>${fmtTime(pts[0].created_at)}`);
    trajetMarkers.push(mDep);

    // Marqueur fin rouge
    const last = pts[pts.length-1];
    const mFin = L.marker([last.lat, last.lng], {
      icon: L.divIcon({
        className: '',
        html: `<div style="width:16px;height:16px;background:#EF4444;border:3px solid white;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.6)"></div>`,
        iconSize:[16,16], iconAnchor:[8,8]
      })
    });
    mFin.addTo(trajetMap);
    mFin.bindPopup(`<b style="color:#EF4444">üî¥ Derni√®re position</b><br>${fmtTime(last.created_at)}`);
    trajetMarkers.push(mFin);
  }

  // ‚îÄ‚îÄ Marqueurs livraisons ‚îÄ‚îÄ
  livs.forEach((l, i) => {
    const lat = parseFloat(l.lat), lng = parseFloat(l.lng);
    if (isNaN(lat) || isNaN(lng)) return;
    allLatLngs.push([lat, lng]);
    const m = L.marker([lat, lng], {
      icon: L.divIcon({
        className: '',
        html: `<div style="width:28px;height:28px;background:#F97316;border:2px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:white;box-shadow:0 2px 8px rgba(0,0,0,0.5)">${i+1}</div>`,
        iconSize:[28,28], iconAnchor:[14,14], popupAnchor:[0,-16]
      })
    });
    m.addTo(trajetMap);
    m.bindPopup(`<b>${l.client_nom||''}</b><br>${fmtTime(l.created_at)}<br><b style="color:#10B981">${(l.montant||0).toLocaleString()} DA</b>`, {maxWidth:200});
    trajetMarkers.push(m);
  });

  // ‚îÄ‚îÄ Centrage ‚îÄ‚îÄ apr√®s un d√©lai pour laisser SVG se dessiner
  if (allLatLngs.length > 0) {
    setTimeout(() => {
      trajetMap.invalidateSize(true);
      try {
        if (allLatLngs.length === 1) {
          trajetMap.setView(allLatLngs[0], 14);
        } else {
          trajetMap.fitBounds(L.latLngBounds(allLatLngs), { padding:[40,40], maxZoom:16, animate:false });
        }
      } catch(e) {
        trajetMap.setView(allLatLngs[0], 13);
      }
    }, 250);
  }

  // Timeline livraisons
  document.getElementById('trajetLivraisons').innerHTML = livs.length
    ? livs.map((l, i) => `
        <div class="hcard ai" style="margin-bottom:8px">
          <div style="display:flex;align-items:center;gap:10px">
            <div style="width:28px;height:28px;background:rgba(249,115,22,0.15);color:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;flex-shrink:0">${i+1}</div>
            <div style="flex:1">
              <div class="hcli">${l.client_nom||''}</div>
              <div class="htim">${fmtTime(l.created_at)}</div>
              <div class="hdet">üì¶ ${l.produits||''}</div>
            </div>
            <div style="font-family:'Syne',sans-serif;font-weight:800;color:var(--accent3)">${(l.montant||0).toLocaleString()} DA</div>
          </div>
        </div>`).join('')
    : '<div style="color:var(--muted);font-size:13px;padding:14px 0">Aucune livraison ce jour</div>';
}

// Calcul distance entre 2 points GPS (formule haversine)
function haversine(lat1, lng1, lat2, lng2) {
  const R = 6371;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLng = (lng2-lng1) * Math.PI/180;
  const a = Math.sin(dLat/2)*Math.sin(dLat/2) +
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)*Math.sin(dLng/2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function fTab(n,el){
  document.querySelectorAll('#fApp .tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#fApp .tc').forEach(t=>t.classList.remove('active'));
  if(el)el.classList.add('active');
  document.getElementById('tf-'+n).classList.add('active');
  if(n==='equipe') loadEquipe();
  // Recalibrer la carte quand on revient sur l'onglet Livreurs
  if(n==='livreurs' && leafletMap) {
    setTimeout(() => leafletMap.invalidateSize(true), 50);
  }
}
// ‚îÄ‚îÄ Navigation livreur visuelle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function lNavTo(section) {
  // Cacher toutes les sections
  document.querySelectorAll('#lApp .tc').forEach(t => {
    t.classList.remove('active');
    t.style.display = 'none';
  });
  // Afficher la section cible
  const target = document.getElementById('lt-' + section);
  if (target) { target.classList.add('active'); target.style.display = ''; }
  // Activer le bon item de nav
  document.querySelectorAll('#lApp .nitem').forEach(n => n.classList.remove('active'));
  const navItem = document.getElementById('lnav-' + section);
  if (navItem) navItem.classList.add('active');
  // Retour √† accueil = camion
  if (section === 'camion') {
    const acc = document.getElementById('lnav-accueil');
    if (acc) acc.classList.add('active');
  }
}

function lTab(n,el){
  document.querySelectorAll('#lApp .tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#lApp .tc').forEach(t=>t.classList.remove('active'));
  if(el)el.classList.add('active');
  document.getElementById('lt-'+n).classList.add('active');
}
function navAct(el){document.querySelectorAll('#lApp .nitem').forEach(n=>n.classList.remove('active'));el.classList.add('active')}
function closeMod(id){document.getElementById(id).classList.remove('open')}
function fmtTime(v){if(!v)return '';if(String(v).includes('T'))return new Date(v).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});return v}
function showToast(msg,err=false){const t=document.getElementById('toast');t.textContent=msg;t.style.background=err?'var(--danger)':'var(--accent3)';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}

// ============================================================
// FOURNISSEUR ‚Äî GESTION COMMANDES CLIENTS
// ============================================================
async function loadCommandesFournisseur() {
  const filtre = document.getElementById('filtreStatutCmd')?.value || '';
  let commandes = [];

  if (useSb && curUser?.id) {
    let q = sb.from('commandes').select('*').eq('fournisseur_id', curUser.id).order('created_at', { ascending: false });
    if (filtre) q = q.eq('statut', filtre);
    const { data } = await q;
    if (data) commandes = data;
  }

  // Recharger livreurs frais depuis Supabase pour la liste d'assignation
  let livreursDispo = lLivreurs;
  if (useSb) {
    const { data } = await sb.from('livreurs').select('id,nom,zone,statut');
    if (data) { livreursDispo = data; lLivreurs = data; }
  }
  // Tous les livreurs actifs (statut actif OU active)
  const livActifs = livreursDispo.filter(l => {
    const st = (l.statut || '').toLowerCase();
    return st === 'actif' || st === 'active' || st === '';
  });

  // Badge
  const enAttente = commandes.filter(c => c.statut === 'en_attente').length;
  const badge = document.getElementById('cmdBadge');
  if (badge) { badge.textContent = enAttente; badge.style.display = enAttente > 0 ? 'inline-flex' : 'none'; }

  const c = document.getElementById('commandesFournisseurList');
  if (!c) return;
  if (!commandes.length) {
    c.innerHTML = '<div class="empty"><div class="eico">üì¨</div>Aucune commande re√ßue</div>';
    return;
  }

  const statutLabel = { en_attente:'‚è≥ En attente', confirmee:'‚úÖ Confirm√©e', en_preparation:'‚öôÔ∏è En pr√©paration', en_livraison:'üöö En livraison', livree:'üì¶ Livr√©e', annulee:'‚ùå Annul√©e' };
  const statutColor = { en_attente:'var(--yellow)', confirmee:'var(--accent2)', en_preparation:'var(--accent)', en_livraison:'var(--accent2)', livree:'var(--accent3)', annulee:'var(--danger)' };

  c.innerHTML = commandes.map(cmd => {
    const lignes = typeof cmd.lignes === 'string' ? JSON.parse(cmd.lignes) : (cmd.lignes || []);
    const st = cmd.statut || 'en_attente';
    const date = new Date(cmd.created_at).toLocaleDateString('fr-DZ', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
    const mode = cmd.mode_reception || 'livraison';
    const modeBadge = mode === 'retrait'
      ? `<span style="font-size:11px;font-weight:700;padding:3px 8px;border-radius:10px;background:rgba(16,185,129,0.12);color:var(--accent3);margin-left:6px">üè™ Retrait</span>`
      : `<span style="font-size:11px;font-weight:700;padding:3px 8px;border-radius:10px;background:rgba(59,130,246,0.12);color:var(--accent2);margin-left:6px">üöö Livraison</span>`;
    const gpsLink = (cmd.client_lat && cmd.client_lng)
      ? `<a href="https://maps.google.com/?q=${cmd.client_lat},${cmd.client_lng}" target="_blank"
           style="display:inline-flex;align-items:center;gap:5px;font-size:12px;color:var(--accent2);text-decoration:none;padding:5px 10px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.25);border-radius:8px">
           üìç Voir position client ‚Üí</a>`
      : '';
    return `
      <div class="hcard" style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
          <div>
            <div style="display:flex;align-items:center;flex-wrap:wrap;gap:4px">
              <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:14px">${cmd.numero}</div>
              ${modeBadge}
            </div>
            <div style="font-size:13px;font-weight:600;margin-top:2px">${cmd.client_nom}</div>
            <div style="font-size:11px;color:var(--muted)">${date}</div>
          </div>
          <span style="font-size:11px;font-weight:700;padding:5px 10px;border-radius:20px;background:${statutColor[st]}22;color:${statutColor[st]}">${statutLabel[st]||st}</span>
        </div>

        <div style="background:var(--bg);border-radius:8px;padding:10px;margin-bottom:10px">
          ${lignes.map(l => `
            <div style="display:flex;justify-content:space-between;font-size:12px;padding:3px 0">
              <span>${l.icone||'üì¶'} ${l.nom} √ó <strong>${l.quantite}</strong></span>
              <span style="color:var(--accent3)">${((l.prix_unitaire||0)*(l.quantite||0)).toLocaleString()} DA</span>
            </div>`).join('')}
          <div style="display:flex;justify-content:space-between;font-family:'Syne',sans-serif;font-weight:800;padding-top:6px;border-top:1px solid var(--border);margin-top:4px">
            <span>Total</span><span style="color:var(--accent3)">${(cmd.total||0).toLocaleString()} DA</span>
          </div>
        </div>

        ${cmd.notes ? `<div style="font-size:12px;color:var(--muted);margin-bottom:8px">üìù ${cmd.notes}</div>` : ''}
        ${cmd.date_souhaitee ? `<div style="font-size:12px;color:var(--accent2);margin-bottom:8px">üìÖ Souhait√© le ${new Date(cmd.date_souhaitee).toLocaleDateString('fr-DZ')}</div>` : ''}
        ${cmd.livreur_nom ? `<div style="font-size:12px;color:var(--accent2);margin-bottom:8px">üöö Livreur : <strong>${cmd.livreur_nom}</strong></div>` : ''}
        ${gpsLink ? `<div style="margin-bottom:10px">${gpsLink}</div>` : ''}

        <div style="display:flex;gap:8px;flex-wrap:wrap">
          ${st === 'en_attente' ? `
            <button onclick="majStatutCommande('${cmd.id}','confirmee')" style="flex:1;padding:8px;background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3);border-radius:8px;color:var(--accent2);font-size:12px;font-weight:700;cursor:pointer">‚úÖ Confirmer</button>
            <button onclick="majStatutCommande('${cmd.id}','annulee')" style="flex:1;padding:8px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;color:var(--danger);font-size:12px;font-weight:700;cursor:pointer">‚ùå Annuler</button>
          ` : ''}
          ${st === 'confirmee' ? `
            <button onclick="majStatutCommande('${cmd.id}','en_preparation')" style="flex:1;padding:8px;background:rgba(249,115,22,0.15);border:1px solid rgba(249,115,22,0.3);border-radius:8px;color:var(--accent);font-size:12px;font-weight:700;cursor:pointer">‚öôÔ∏è En pr√©paration</button>
          ` : ''}
          ${st === 'en_preparation' && mode === 'livraison' ? `
            <select onchange="assignerLivreurCommande('${cmd.id}',this.value)" style="flex:1;padding:8px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;cursor:pointer">
              <option value="">üöö Assigner un livreur (${livActifs.length} dispo)</option>
              ${livActifs.map(l=>`<option value="${l.id}|${l.nom}">${l.nom}${l.zone ? ' ‚Äî '+l.zone : ''}</option>`).join('')}
            </select>
          ` : ''}
          ${st === 'en_preparation' && mode === 'retrait' ? `
            <button onclick="majStatutCommande('${cmd.id}','livree')" style="flex:1;padding:8px;background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);border-radius:8px;color:var(--accent3);font-size:12px;font-weight:700;cursor:pointer">üè™ Marquer r√©cup√©r√©</button>
          ` : ''}
          ${st === 'en_livraison' ? `
            <button onclick="majStatutCommande('${cmd.id}','livree')" style="flex:1;padding:8px;background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);border-radius:8px;color:var(--accent3);font-size:12px;font-weight:700;cursor:pointer">üì¶ Marquer livr√©e</button>
          ` : ''}
        </div>
      </div>`;
  }).join('');
}

async function majStatutCommande(cmdId, nouveauStatut) {
  if (!useSb) return;
  await sb.from('commandes').update({ statut: nouveauStatut, updated_at: new Date().toISOString() }).eq('id', cmdId);
  showToast('Commande mise √† jour ‚úì');
  await loadCommandesFournisseur();
}

async function assignerLivreurCommande(cmdId, valeur) {
  if (!valeur || !useSb) return;
  const [livId, livNom] = valeur.split('|');
  await sb.from('commandes').update({ statut: 'en_livraison', livreur_id: livId, livreur_nom: livNom, updated_at: new Date().toISOString() }).eq('id', cmdId);
  showToast(`üöö Assign√© √† ${livNom} ‚úì`);
  await loadCommandesFournisseur();
}

// ============================================================
// ADMIN
// ============================================================
let curAdmin = null;

function enterAdmin() {
  document.getElementById('login').classList.remove('active');
  document.getElementById('adminApp').classList.add('active');
  document.getElementById('adminWelcome').textContent = curAdmin?.nom || 'Admin';
  loadAdminAbonnements();
}

function aTab(n, el) {
  document.querySelectorAll('#adminApp .tc').forEach(t => t.classList.remove('active'));
  document.getElementById('ta-' + n).classList.add('active');
  document.querySelectorAll('#adminApp .tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
}

async function loadAdminAbonnements() {
  const c = document.getElementById('adminAbonnementsList');
  if (!useSb) { c.innerHTML = '<div class="empty">Connectez Supabase</div>'; return; }

  const [{ data: fours }, { data: clients }] = await Promise.all([
    sb.from('fournisseurs').select('id,nom,abonnement_statut,abonnement_fin').order('nom'),
    sb.from('commer√ßants').select('id,nom,abonnement_statut,abonnement_fin').order('nom')
  ]);

  const today = new Date();
  const renderCard = (e, type) => {
    const fin = e.abonnement_fin ? new Date(e.abonnement_fin) : null;
    const jours = fin ? Math.ceil((fin - today) / 86400000) : null;
    const st = e.abonnement_statut || 'inactif';
    const badgeClass = st === 'actif' ? (jours < 30 ? 'abo-bientot' : 'abo-actif') : st === 'essai' ? 'abo-essai' : 'abo-expire';
    const badgeTxt = st === 'actif' ? (jours < 30 ? `‚ö†Ô∏è ${jours}j restants` : `‚úì Actif ‚Äî ${jours}j`) : st === 'essai' ? 'üîµ Essai' : '‚ùå Expir√©';
    return `
      <div class="admin-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700;font-size:14px">${type === 'fournisseur' ? 'üè≠' : 'üõí'} ${e.nom}</div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px">${fin ? 'Expire le ' + fin.toLocaleDateString('fr-DZ') : 'Aucune date'}</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
            <span class="abo-badge ${badgeClass}">${badgeTxt}</span>
            <button onclick="ouvrirRenouvellement('${type}','${e.id}','${e.nom.replace(/'/g,'')}')" style="padding:5px 12px;background:rgba(139,92,246,0.15);border:1px solid rgba(139,92,246,0.3);border-radius:8px;color:#8B5CF6;font-size:11px;font-weight:700;cursor:pointer">üîÑ Renouveler</button>
          </div>
        </div>
      </div>`;
  };

  c.innerHTML = `
    <div style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">Fournisseurs (${(fours||[]).length})</div>
    ${(fours||[]).map(f => renderCard(f,'fournisseur')).join('') || '<div class="empty"><div class="eico">üè≠</div>Aucun fournisseur</div>'}
    <div style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin:20px 0 10px">Commer√ßants (${(clients||[]).length})</div>
    ${(clients||[]).map(c => renderCard(c,'client')).join('') || '<div class="empty"><div class="eico">üõí</div>Aucun commer√ßant</div>'}`;
}

async function loadAdminFournisseurs() {
  const c = document.getElementById('adminFournisseursList');
  if (!useSb) return;
  const { data } = await sb.from('fournisseurs').select('*').order('nom');
  if (!data?.length) { c.innerHTML = '<div class="empty"><div class="eico">üè≠</div>Aucun fournisseur</div>'; return; }
  const today = new Date();
  c.innerHTML = data.map(f => {
    const fin = f.abonnement_fin ? new Date(f.abonnement_fin) : null;
    const jours = fin ? Math.ceil((fin - today) / 86400000) : null;
    const st = f.abonnement_statut || 'inactif';
    return `
      <div class="admin-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <div style="font-weight:700;font-size:14px">üè≠ ${f.nom}</div>
            <div style="font-size:12px;color:var(--accent2);margin-top:2px">@${f.identifiant}</div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px">${fin ? 'Expire: ' + fin.toLocaleDateString('fr-DZ') : '‚Äî'}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <span class="abo-badge ${st==='actif'?(jours<30?'abo-bientot':'abo-actif'):st==='essai'?'abo-essai':'abo-expire'}">${st==='actif'?'Actif':st==='essai'?'Essai':'Expir√©'}</span>
            <button onclick="suspendreCompte('fournisseur','${f.id}','${st}')" style="padding:4px 10px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;color:var(--danger);font-size:11px;font-weight:700;cursor:pointer">${st==='suspendu'?'üü¢ R√©activer':'‚è∏Ô∏è Suspendre'}</button>
          </div>
        </div>
      </div>`;
  }).join('');
}

async function loadAdminClients() {
  const c = document.getElementById('adminClientsList');
  if (!useSb) return;
  const { data } = await sb.from('commer√ßants').select('*').order('nom');
  if (!data?.length) { c.innerHTML = '<div class="empty"><div class="eico">üõí</div>Aucun commer√ßant</div>'; return; }
  const today = new Date();
  c.innerHTML = data.map(cl => {
    const fin = cl.abonnement_fin ? new Date(cl.abonnement_fin) : null;
    const jours = fin ? Math.ceil((fin - today) / 86400000) : null;
    const st = cl.abonnement_statut || 'inactif';
    return `
      <div class="admin-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <div style="font-weight:700;font-size:14px">üõí ${cl.nom}</div>
            <div style="font-size:12px;color:var(--accent2);margin-top:2px">@${cl.identifiant||'‚Äî'}</div>
            <div style="font-size:11px;color:var(--muted)">üìû ${cl.telephone||'‚Äî'}</div>
            <div style="font-size:11px;color:var(--muted)">${fin ? 'Expire: ' + fin.toLocaleDateString('fr-DZ') : '‚Äî'}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <span class="abo-badge ${st==='actif'?(jours<30?'abo-bientot':'abo-actif'):st==='inactif'?'abo-expire':'abo-expire'}">${st==='actif'?'Actif':st==='inactif'?'Inactif':'Expir√©'}</span>
            <button onclick="suspendreCompte('client','${cl.id}','${st}')" style="padding:4px 10px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;color:var(--danger);font-size:11px;font-weight:700;cursor:pointer">${st==='suspendu'?'üü¢ R√©activer':'‚è∏Ô∏è Suspendre'}</button>
          </div>
        </div>
      </div>`;
  }).join('');
}

async function adminCreerFournisseur() {
  const nom = document.getElementById('aFNom').value.trim();
  const ident = document.getElementById('aFIdent').value.trim();
  const mdp = document.getElementById('aFMdp').value.trim();
  const dateFin = document.getElementById('aFDateFin').value;
  const prix = parseInt(document.getElementById('aFPrix').value) || 0;
  if (!nom || !ident || !mdp || !dateFin) { showToast('‚ö†Ô∏è Remplissez tous les champs requis', true); return; }
  const btn = document.getElementById('aFBtn');
  btn.disabled = true; btn.textContent = '‚è≥...';
  const { data, error } = await sb.rpc('admin_creer_fournisseur', {
    p_nom: nom, p_identifiant: ident, p_mot_de_passe: mdp,
    p_date_fin: dateFin, p_prix: prix
  });
  btn.disabled = false; btn.textContent = '‚úÖ Cr√©er le compte';
  if (error) { showToast('‚ùå ' + (error.message.includes('IDENTIFIANT_EXISTE') ? 'Identifiant d√©j√† utilis√©' : error.message), true); return; }
  ['aFNom','aFIdent','aFMdp','aFDateFin','aFPrix'].forEach(id => document.getElementById(id).value = '');
  closeMod('adminAddFournisseurModal');
  showToast(`‚úÖ Fournisseur "${nom}" cr√©√© avec succ√®s`);
  loadAdminAbonnements();
}

async function adminCreerClient() {
  const nom = document.getElementById('aCNom').value.trim();
  const tel = document.getElementById('aCTel').value.trim();
  const addr = document.getElementById('aCAddr').value.trim();
  const ident = document.getElementById('aCIdent').value.trim();
  const mdp = document.getElementById('aCMdp').value.trim();
  const dateFin = document.getElementById('aCDateFin').value;
  const prix = parseInt(document.getElementById('aCPrix').value) || 0;
  if (!nom || !tel || !ident || !mdp || !dateFin) { showToast('‚ö†Ô∏è Remplissez tous les champs requis', true); return; }
  const btn = document.getElementById('aCBtn');
  btn.disabled = true; btn.textContent = '‚è≥...';
  const { data, error } = await sb.rpc('admin_creer_client', {
    p_nom: nom, p_telephone: tel, p_adresse: addr,
    p_identifiant: ident, p_mot_de_passe: mdp,
    p_date_fin: dateFin, p_prix: prix
  });
  btn.disabled = false; btn.textContent = '‚úÖ Cr√©er le compte';
  if (error) { showToast('‚ùå ' + (error.message.includes('IDENTIFIANT_EXISTE') ? 'Identifiant d√©j√† utilis√©' : error.message), true); return; }
  ['aCNom','aCTel','aCAddr','aCIdent','aCMdp','aCDateFin','aCPrix'].forEach(id => document.getElementById(id).value = '');
  closeMod('adminAddClientModal');
  showToast(`‚úÖ Client "${nom}" cr√©√© avec succ√®s`);
  loadAdminAbonnements();
}

function ouvrirRenouvellement(type, id, nom) {
  document.getElementById('renouvelerType').value = type;
  document.getElementById('renouvelerId').value = id;
  document.getElementById('renouvelerNom').textContent = (type === 'fournisseur' ? 'üè≠ ' : 'üõí ') + nom;
  document.getElementById('renouvelerModal').classList.add('open');
}

async function confirmerRenouvellement() {
  const type = document.getElementById('renouvelerType').value;
  const id = document.getElementById('renouvelerId').value;
  const mois = parseInt(document.getElementById('renouvelerDuree').value);
  const prix = parseInt(document.getElementById('renouvelerPrix').value) || 0;
  const { error } = await sb.rpc('renouveler_abonnement', {
    p_entite_type: type, p_entite_id: id, p_mois: mois, p_prix: prix
  });
  if (error) { showToast('‚ùå ' + error.message, true); return; }
  closeMod('renouvelerModal');
  showToast(`‚úÖ Abonnement renouvel√© pour ${mois} mois`);
  loadAdminAbonnements();
}

async function suspendreCompte(type, id, statut) {
  const nouveau = statut === 'suspendu' ? 'actif' : 'suspendu';
  const table = type === 'fournisseur' ? 'fournisseurs' : 'commer√ßants';
  await sb.from(table).update({ abonnement_statut: nouveau }).eq('id', id);
  showToast(nouveau === 'suspendu' ? '‚è∏Ô∏è Compte suspendu' : 'üü¢ Compte r√©activ√©');
  if (type === 'fournisseur') loadAdminFournisseurs(); else loadAdminClients();
}

// ============================================================
// CLIENT ‚Äî APP
// ============================================================
let curClient = null;
let catalogueProduits = [];
let panier = {};
let mesCommandes = [];
let clientFournisseurActif = null; // fournisseur s√©lectionn√© pour commander

async function enterC() {
  document.getElementById('login').classList.remove('active');
  document.getElementById('cApp').classList.add('active');
  document.getElementById('cWelcome').textContent = curClient?.nom || 'Commer√ßant';
  await initC();
}

async function initC() {
  await loadMesFournisseurs();
  await loadMesCommandes();
  // Charger les annonces en arri√®re-plan pour mettre √† jour le badge
  loadAnnoncesClient();
  cSwitchTab('catalogue', document.querySelector('#cApp .cnitem'));
}

function cSwitchTab(n, el) {
  document.querySelectorAll('#cApp .ctc').forEach(t => { t.classList.remove('active'); t.style.display = 'none'; });
  document.getElementById('ctc-' + n).classList.add('active');
  document.getElementById('ctc-' + n).style.display = 'block';
  document.querySelectorAll('#cApp .cnitem').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  if (n === 'catalogue') renderCatalogueAvecSelector();
}

// ‚îÄ‚îÄ Fournisseurs du client ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadMesFournisseurs() {
  if (!useSb || !curClient?.id) return;
  const { data } = await sb.from('client_fournisseurs')
    .select('*, fournisseurs(id,nom,abonnement_statut)')
    .eq('client_id', curClient.id)
    .eq('statut', 'actif');

  const mesF = (data || []).filter(r => r.fournisseurs?.abonnement_statut === 'actif');

  // Si le client a au moins un fournisseur, s√©lectionner le premier par d√©faut
  if (mesF.length && !clientFournisseurActif) {
    clientFournisseurActif = mesF[0].fournisseurs;
  }

  // Afficher dans l'onglet fournisseurs
  const cMes = document.getElementById('mesFournisseursList');
  if (cMes) {
    cMes.innerHTML = mesF.length
      ? mesF.map(r => `
          <div class="admin-card" style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">üè≠ ${r.fournisseurs?.nom}</div>
              <div style="font-size:11px;color:var(--accent3);margin-top:2px">‚úì Abonnement actif</div>
            </div>
            <button onclick="retirerFournisseur('${r.id}')" style="padding:5px 10px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;color:var(--danger);font-size:11px;cursor:pointer">Retirer</button>
          </div>`).join('')
      : '<div style="color:var(--muted);font-size:13px;padding:12px 0">Aucun fournisseur li√©. Ajoutez-en un ci-dessous.</div>';
  }

  // Charger tous les fournisseurs disponibles pour en ajouter
  const mesIds = mesF.map(r => r.fournisseurs?.id);
  const { data: tous } = await sb.from('fournisseurs').select('id,nom').eq('abonnement_statut','actif');
  const cTous = document.getElementById('tousFournisseursList');
  if (cTous) {
    const disponibles = (tous || []).filter(f => !mesIds.includes(f.id));
    cTous.innerHTML = disponibles.length
      ? disponibles.map(f => `
          <div class="admin-card" style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:600">üè≠ ${f.nom}</div>
            <button onclick="ajouterFournisseur('${f.id}','${f.nom.replace(/'/g,'')}')" style="padding:7px 16px;background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);border-radius:8px;color:var(--accent3);font-size:12px;font-weight:700;cursor:pointer">+ Ajouter</button>
          </div>`).join('')
      : '<div style="color:var(--muted);font-size:13px;padding:12px 0">Tous les fournisseurs disponibles sont d√©j√† li√©s.</div>';
  }

  await loadCatalogue();
}

async function ajouterFournisseur(fouId, fouNom) {
  if (!useSb || !curClient?.id) return;
  await sb.from('client_fournisseurs').upsert({ client_id: curClient.id, fournisseur_id: fouId, statut: 'actif' }, { onConflict: 'client_id,fournisseur_id' });
  showToast(`‚úÖ ${fouNom} ajout√©`);
  await loadMesFournisseurs();
}

async function retirerFournisseur(relationId) {
  await sb.from('client_fournisseurs').delete().eq('id', relationId);
  showToast('Fournisseur retir√©');
  await loadMesFournisseurs();
}

// ‚îÄ‚îÄ Catalogue ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadCatalogue() {
  if (!useSb || !clientFournisseurActif?.id) {
    catalogueProduits = lProduits.filter(p => (p.quantite||0) > 0);
  } else {
    // Charger uniquement les produits du fournisseur s√©lectionn√©
    // On passe par les livraisons/produits li√©s √† ce fournisseur via les livreurs
    const { data } = await sb.from('produits').select('*').gt('quantite', 0);
    catalogueProduits = data || [];
  }
}

// ============================================================
// ANNONCES FOURNISSEUR
// ============================================================
let annonceTypeActif = 'info';
const ANNONCE_STYLES = {
  info:           { emoji:'‚ÑπÔ∏è', color:'var(--accent2)',  bg:'rgba(59,130,246,0.1)',  border:'rgba(59,130,246,0.25)'  },
  promo:          { emoji:'üè∑Ô∏è', color:'var(--accent)',   bg:'rgba(249,115,22,0.1)',  border:'rgba(249,115,22,0.25)'  },
  nouveau_produit:{ emoji:'üÜï', color:'var(--accent3)',  bg:'rgba(16,185,129,0.1)',  border:'rgba(16,185,129,0.25)'  },
  alerte:         { emoji:'‚ö†Ô∏è', color:'var(--danger)',   bg:'rgba(239,68,68,0.1)',   border:'rgba(239,68,68,0.25)'   },
};

function selAnnonceType(type, btn) {
  annonceTypeActif = type;
  document.getElementById('annonceType').value = type;
  document.querySelectorAll('.annonce-type-btn').forEach(b => {
    b.style.border = '1.5px solid var(--border)';
    b.style.background = 'var(--card)';
    b.style.color = 'var(--muted)';
  });
  const s = ANNONCE_STYLES[type];
  btn.style.border    = `1.5px solid ${s.border}`;
  btn.style.background = s.bg;
  btn.style.color     = s.color;
}

async function loadAnnonces() {
  const c = document.getElementById('annoncesList');
  if (!c) return;
  if (!useSb || !curUser?.id) {
    c.innerHTML = '<div class="empty"><div class="eico">üîå</div>Connectez Supabase</div>'; return;
  }
  const { data } = await sb.from('annonces')
    .select('*').eq('fournisseur_id', curUser.id)
    .order('created_at', { ascending: false });
  const liste = data || [];
  document.getElementById('annoncesBadge').textContent = `${liste.filter(a=>a.actif).length} active(s)`;
  if (!liste.length) {
    c.innerHTML = '<div class="empty"><div class="eico">üì¢</div>Aucune annonce publi√©e</div>'; return;
  }
  c.innerHTML = liste.map(a => {
    const s = ANNONCE_STYLES[a.type] || ANNONCE_STYLES.info;
    const date = new Date(a.created_at).toLocaleDateString('fr-DZ',{day:'2-digit',month:'short',year:'numeric'});
    const expire = a.expire_at ? new Date(a.expire_at) : null;
    const expiree = expire && expire < new Date();
    return `
      <div style="background:var(--card);border:1.5px solid ${expiree||!a.actif?'var(--border)':s.border};border-radius:14px;padding:14px;margin-bottom:10px;opacity:${a.actif&&!expiree?1:0.55}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
              <span style="font-size:16px">${s.emoji}</span>
              <span style="font-family:'Syne',sans-serif;font-weight:800;font-size:14px">${a.titre}</span>
            </div>
            <div style="font-size:13px;color:var(--text);margin-bottom:6px">${a.contenu}</div>
            <div style="font-size:11px;color:var(--muted)">
              ${date}${expire?` ¬∑ expire ${expire.toLocaleDateString('fr-DZ',{day:'2-digit',month:'short'})}`:''} 
              <span style="margin-left:6px;padding:2px 8px;border-radius:6px;font-weight:700;background:${a.actif&&!expiree?s.bg:'rgba(0,0,0,0.05)'};color:${a.actif&&!expiree?s.color:'var(--muted)'}">
                ${expiree?'Expir√©e':a.actif?'Active':'D√©sactiv√©e'}
              </span>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0">
            <button onclick="toggleAnnonce('${a.id}',${!a.actif})" style="padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:12px;cursor:pointer">
              ${a.actif?'‚è∏Ô∏è Pause':'‚ñ∂Ô∏è Activer'}
            </button>
            <button onclick="supprimerAnnonce('${a.id}')" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(239,68,68,0.3);background:rgba(239,68,68,0.08);color:var(--danger);font-size:12px;cursor:pointer">üóëÔ∏è</button>
          </div>
        </div>
      </div>`;
  }).join('');
}

async function publierAnnonce() {
  const titre   = document.getElementById('annonceTitre').value.trim();
  const contenu = document.getElementById('annonceContenu').value.trim();
  const type    = document.getElementById('annonceType').value || 'info';
  const expire  = document.getElementById('annonceExpire').value;
  if (!titre || !contenu) { showToast('‚ö†Ô∏è Titre et message requis', true); return; }
  if (!useSb || !curUser?.id) { showToast('‚ö†Ô∏è Connectez Supabase', true); return; }

  const { error } = await sb.from('annonces').insert({
    fournisseur_id: curUser.id, titre, contenu, type, actif: true,
    expire_at: expire ? new Date(expire).toISOString() : null,
  });
  if (error) { showToast('‚ùå ' + error.message, true); return; }

  document.getElementById('annonceTitre').value = '';
  document.getElementById('annonceContenu').value = '';
  document.getElementById('annonceExpire').value = '';
  showToast('üì¢ Annonce publi√©e !');
  await loadAnnonces();
}

async function toggleAnnonce(id, actif) {
  if (!useSb) return;
  await sb.from('annonces').update({ actif }).eq('id', id);
  await loadAnnonces();
}

async function supprimerAnnonce(id) {
  if (!confirm('Supprimer cette annonce ?')) return;
  await sb.from('annonces').delete().eq('id', id);
  await loadAnnonces();
}

// ============================================================
// PARAM√àTRES FOURNISSEUR ‚Äî commandes en ligne
// ============================================================
let _accepteCommandes = true;

async function loadParametres() {
  if (!useSb || !curUser?.id) return;
  const { data } = await sb.from('fournisseurs').select('*').eq('id', curUser.id).single();
  if (!data) return;
  _accepteCommandes = data.accepte_commandes !== false; // d√©faut true
  document.getElementById('paramNom').value     = data.nom    || '';
  document.getElementById('paramAdresse').value = data.adresse|| '';
  document.getElementById('paramTel').value     = data.telephone || '';
  document.getElementById('cmdMessage').value   = data.message_commandes || '';
  _renderToggle();
}

function _renderToggle() {
  const tog   = document.getElementById('cmdToggle');
  const knob  = document.getElementById('cmdToggleKnob');
  const label = document.getElementById('cmdToggleLabel');
  const sub   = document.getElementById('cmdToggleSub');
  const msgBox= document.getElementById('cmdMessageBox');
  if (_accepteCommandes) {
    tog.style.background = 'var(--accent3)';
    knob.style.left      = '27px';
    label.textContent    = '‚úÖ Commandes activ√©es';
    sub.textContent      = 'Vos commer√ßants peuvent commander en ligne';
    msgBox.style.display = 'none';
  } else {
    tog.style.background = 'var(--danger)';
    knob.style.left      = '3px';
    label.textContent    = 'üö´ Commandes d√©sactiv√©es';
    sub.textContent      = 'Vos commer√ßants voient un message de refus';
    msgBox.style.display = 'block';
  }
}

async function toggleCommandes() {
  _accepteCommandes = !_accepteCommandes;
  _renderToggle();
  await sauvegarderParametres();
}

async function sauvegarderParametres() {
  if (!useSb || !curUser?.id) { showToast('‚ö†Ô∏è Connectez Supabase', true); return; }
  const nom     = document.getElementById('paramNom').value.trim();
  const adresse = document.getElementById('paramAdresse').value.trim();
  const tel     = document.getElementById('paramTel').value.trim();
  const message = document.getElementById('cmdMessage').value.trim();
  const { error } = await sb.from('fournisseurs').update({
    nom:               nom     || undefined,
    adresse:           adresse || undefined,
    telephone:         tel     || undefined,
    accepte_commandes: _accepteCommandes,
    message_commandes: message || null,
  }).eq('id', curUser.id);
  if (error) { showToast('‚ùå ' + error.message, true); return; }
  showToast(_accepteCommandes ? '‚úÖ Commandes activ√©es' : 'üö´ Commandes d√©sactiv√©es');
}

// ============================================================
// ANNONCES C√îT√â CLIENT
// ============================================================
async function loadAnnoncesClient() {
  const c = document.getElementById('annoncesClientList');
  if (!c) return;
  if (!useSb || !curClient?.id) {
    c.innerHTML = '<div class="empty"><div class="eico">üîå</div>Connectez Supabase</div>'; return;
  }
  // R√©cup√©rer les fournisseurs du client
  const { data: cfData } = await sb.from('client_fournisseurs')
    .select('fournisseur_id').eq('client_id', curClient.id).eq('statut','actif');
  const fouIds = (cfData||[]).map(r => r.fournisseur_id);
  if (!fouIds.length) {
    c.innerHTML = '<div class="empty"><div class="eico">üè≠</div>Abonnez-vous √† un fournisseur pour voir ses annonces</div>'; return;
  }
  const now = new Date().toISOString();
  const { data } = await sb.from('annonces')
    .select('*, fournisseurs(nom)')
    .in('fournisseur_id', fouIds)
    .eq('actif', true)
    .or(`expire_at.is.null,expire_at.gt.${now}`)
    .order('created_at', { ascending: false });
  const liste = data || [];

  // Badge
  const badge = document.getElementById('annonceClientBadge');
  if (badge) { badge.textContent = liste.length; badge.style.display = liste.length ? 'inline-flex' : 'none'; }

  if (!liste.length) {
    c.innerHTML = '<div class="empty"><div class="eico">üîî</div>Aucune annonce pour le moment</div>'; return;
  }
  c.innerHTML = liste.map(a => {
    const s = ANNONCE_STYLES[a.type] || ANNONCE_STYLES.info;
    const date = new Date(a.created_at).toLocaleDateString('fr-DZ',{day:'2-digit',month:'long',year:'numeric'});
    const expire = a.expire_at ? new Date(a.expire_at) : null;
    const joursRestants = expire ? Math.ceil((expire-new Date())/(1000*60*60*24)) : null;
    return `
      <div style="background:${s.bg};border:1.5px solid ${s.border};border-radius:16px;padding:16px;margin-bottom:12px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <span style="font-size:22px">${s.emoji}</span>
          <div>
            <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:15px;color:var(--text)">${a.titre}</div>
            <div style="font-size:11px;color:${s.color};font-weight:700">${a.fournisseurs?.nom||''}</div>
          </div>
        </div>
        <div style="font-size:14px;color:var(--text);line-height:1.5;margin-bottom:8px">${a.contenu}</div>
        <div style="font-size:11px;color:var(--muted);display:flex;gap:12px;flex-wrap:wrap">
          <span>üìÖ ${date}</span>
          ${joursRestants!==null ? `<span style="color:${joursRestants<=3?'var(--danger)':'var(--muted)'}">‚è≥ Expire dans ${joursRestants}j</span>` : ''}
        </div>
      </div>`;
  }).join('');
}

async function renderCatalogueAvecSelector() {
  // Charger fournisseurs li√©s avec infos commandes
  let mesF = [];
  if (useSb && curClient?.id) {
    const { data } = await sb.from('client_fournisseurs')
      .select('*, fournisseurs(id,nom,accepte_commandes,message_commandes)')
      .eq('client_id', curClient.id).eq('statut', 'actif');
    mesF = (data || []).map(r => r.fournisseurs).filter(Boolean);
  }

  const sel = document.getElementById('fournisseurSelector');
  if (mesF.length === 0) {
    sel.innerHTML = `<div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:10px;padding:12px;font-size:13px;color:var(--yellow);margin-bottom:16px">
      ‚ö†Ô∏è Aucun fournisseur li√©. Allez dans l'onglet <strong>üè≠ Fournisseurs</strong> pour en ajouter un.
    </div>`;
    document.getElementById('catalogueList').innerHTML = '';
    return;
  }

  if (mesF.length > 1) {
    sel.innerHTML = `
      <div style="margin-bottom:16px">
        <label class="fl">Commander chez</label>
        <select class="di" onchange="changerFournisseurActif(this.value)" style="margin-top:6px">
          ${mesF.map(f => `<option value="${f.id}" ${clientFournisseurActif?.id===f.id?'selected':''}>${f.nom}</option>`).join('')}
        </select>
      </div>`;
  } else {
    clientFournisseurActif = mesF[0];
    sel.innerHTML = `<div style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);border-radius:10px;padding:10px 14px;font-size:13px;margin-bottom:16px">
      üè≠ <strong>${mesF[0].nom}</strong>
    </div>`;
  }

  // V√©rifier si le fournisseur actif accepte les commandes
  const fouActif = mesF.find(f => f.id === clientFournisseurActif?.id) || mesF[0];
  clientFournisseurActif = fouActif;
  const accepte = fouActif?.accepte_commandes !== false;
  const banner = document.getElementById('cmdDesactiveeBanner');
  const msgEl  = document.getElementById('cmdDesactiveeMessage');
  if (banner) {
    banner.style.display = accepte ? 'none' : 'block';
    if (!accepte && msgEl) {
      msgEl.textContent = fouActif?.message_commandes ||
        'Ce fournisseur n\'accepte pas les commandes en ligne pour le moment.';
    }
  }
  // M√©moriser pour bloquer le panier
  window._commandesActives = accepte;

  await loadCatalogue();
  renderCatalogue();
}

async function changerFournisseurActif(fouId) {
  if (!useSb) return;
  const { data } = await sb.from('fournisseurs')
    .select('id,nom,accepte_commandes,message_commandes').eq('id', fouId).single();
  if (data) clientFournisseurActif = data;
  // Mettre √† jour banni√®re
  const accepte = data?.accepte_commandes !== false;
  window._commandesActives = accepte;
  const banner = document.getElementById('cmdDesactiveeBanner');
  const msgEl  = document.getElementById('cmdDesactiveeMessage');
  if (banner) {
    banner.style.display = accepte ? 'none' : 'block';
    if (!accepte && msgEl) msgEl.textContent = data?.message_commandes || 'Commandes non disponibles.';
  }
  panier = {};
  updatePanierBadge();
  await loadCatalogue();
  renderCatalogue();
}

function renderCatalogue() {
  const c = document.getElementById('catalogueList');
  if (!catalogueProduits.length) {
    c.innerHTML = '<div class="empty"><div class="eico">üõí</div>Catalogue vide pour le moment</div>';
    return;
  }
  c.innerHTML = catalogueProduits.map(p => {
    const inPanier = panier[p.id]?.quantite || 0;
    return `
      <div class="c-prod-card" id="cprod-${p.id}">
        <div style="display:flex;align-items:center;gap:12px">
          ${p.image
            ? `<img src="${p.image}" class="c-prod-img" alt="${p.nom}">`
            : `<div class="c-prod-icon">${p.icone||'üì¶'}</div>`}
          <div style="flex:1;min-width:0">
            <div style="font-weight:700;font-size:14px">${p.nom}</div>
            <div style="font-size:12px;color:var(--muted)">${p.unite||'unit√©'}</div>
            ${p.cond_type && p.cond_qty ? `<div class="cond-badge">üì¶ ${p.cond_type} de ${p.cond_qty} ${p.unite||'u.'}</div>` : ''}
            <div style="font-size:15px;font-weight:800;color:var(--accent3);margin-top:4px">${p.prix?(p.prix).toLocaleString()+' DA':'Prix sur demande'}</div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <button onclick="changerQty('${p.id}',-1)" style="width:30px;height:30px;border-radius:50%;background:var(--border);border:none;color:var(--text);font-size:16px;cursor:pointer">‚àí</button>
            <span id="qty-${p.id}" style="font-family:'Syne',sans-serif;font-weight:800;font-size:16px;min-width:20px;text-align:center">${inPanier}</span>
            <button onclick="changerQty('${p.id}',1)" style="width:30px;height:30px;border-radius:50%;background:var(--accent);border:none;color:white;font-size:16px;cursor:pointer">+</button>
          </div>
        </div>
      </div>`;
  }).join('');
  updatePanierBadge();
}

function changerQty(id, delta) {
  const p = catalogueProduits.find(x => x.id === id);
  if (!p) return;
  if (!panier[id]) panier[id] = { quantite: 0, nom: p.nom, prix: p.prix||0, unite: p.unite||'', icone: p.icone||'üì¶' };
  panier[id].quantite = Math.max(0, panier[id].quantite + delta);
  if (panier[id].quantite === 0) delete panier[id];
  document.getElementById('qty-' + id).textContent = panier[id]?.quantite || 0;
  updatePanierBadge();
}

function updatePanierBadge() {
  const total = Object.values(panier).reduce((s, p) => s + p.quantite, 0);
  const montant = Object.values(panier).reduce((s, p) => s + (p.prix * p.quantite), 0);
  const badge = document.getElementById('panierBadge');
  const btn = document.getElementById('btnPanier');
  if (badge) { badge.textContent = total; badge.style.display = total > 0 ? 'flex' : 'none'; }
  if (btn) btn.textContent = total > 0 ? `üõí Panier (${montant.toLocaleString()} DA)` : 'üõí Panier vide';
}

function openPanier() {
  if (window._commandesActives === false) {
    showToast('üö´ Ce fournisseur n\'accepte pas les commandes en ligne', true); return;
  }
  const lignes = Object.entries(panier);
  if (!lignes.length) { showToast('‚ö†Ô∏è Votre panier est vide', true); return; }
  const total = lignes.reduce((s, [,p]) => s + (p.prix * p.quantite), 0);
  document.getElementById('panierContenu').innerHTML = `
    <div style="margin-bottom:16px">
      ${lignes.map(([id, p]) => `
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
          <span style="font-size:18px">${p.icone}</span>
          <div style="flex:1">
            <div style="font-weight:600;font-size:14px">${p.nom}</div>
            <div style="font-size:12px;color:var(--muted)">${p.quantite} √ó ${(p.prix).toLocaleString()} DA</div>
          </div>
          <div style="font-family:'Syne',sans-serif;font-weight:800;color:var(--accent3)">${(p.prix*p.quantite).toLocaleString()} DA</div>
          <button onclick="delete panier['${id}'];document.getElementById('qty-${id}')&&(document.getElementById('qty-${id}').textContent=0);updatePanierBadge();openPanier()" style="background:transparent;border:none;color:var(--danger);font-size:16px;cursor:pointer">‚úï</button>
        </div>`).join('')}
    </div>
    <div style="background:rgba(16,185,129,0.1);border-radius:10px;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <span style="font-weight:700">Total estim√©</span>
      <span style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--accent3)">${total.toLocaleString()} DA</span>
    </div>`;
  document.getElementById('panierModal').classList.add('open');
}

// ‚îÄ‚îÄ Mode livraison / retrait ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let modeCmdActif = 'livraison'; // 'livraison' | 'retrait'
let clientGeoLat = null;
let clientGeoLng = null;

function selectModeCmd(mode) {
  modeCmdActif = mode;
  const bL = document.getElementById('btnModeLivraison');
  const bR = document.getElementById('btnModeRetrait');
  const sL = document.getElementById('sectionLivraison');
  const sR = document.getElementById('sectionRetrait');
  if (mode === 'livraison') {
    bL.style.borderColor='var(--accent)'; bL.style.background='rgba(249,115,22,0.1)'; bL.style.color='var(--accent)';
    bR.style.borderColor='var(--border)'; bR.style.background='var(--card)'; bR.style.color='var(--muted)';
    sL.style.display='block'; sR.style.display='none';
  } else {
    bR.style.borderColor='var(--accent3)'; bR.style.background='rgba(16,185,129,0.1)'; bR.style.color='var(--accent3)';
    bL.style.borderColor='var(--border)'; bL.style.background='var(--card)'; bL.style.color='var(--muted)';
    sL.style.display='none'; sR.style.display='block';
    // Charger adresse d√©p√¥t du fournisseur actif
    const f = clientFournisseurActif;
    document.getElementById('adresseDepot').textContent = f?.adresse || f?.nom || 'Adresse non renseign√©e ‚Äî contactez le fournisseur';
  }
}

async function capturerPositionClient() {
  const btn = document.getElementById('btnGeoClient');
  const status = document.getElementById('geoClientStatus');
  if (!navigator.geolocation) {
    status.textContent = '‚ùå G√©olocalisation non support√©e';
    status.style.color = 'var(--danger)'; return;
  }
  btn.disabled = true; btn.textContent = '‚è≥ Localisation en cours...';
  status.textContent = 'üì° Acquisition GPS...';
  navigator.geolocation.getCurrentPosition(
    pos => {
      clientGeoLat = pos.coords.latitude;
      clientGeoLng = pos.coords.longitude;
      document.getElementById('cmdLat').value = clientGeoLat;
      document.getElementById('cmdLng').value = clientGeoLng;
      const acc = Math.round(pos.coords.accuracy);
      status.innerHTML = `‚úÖ <strong>Position captur√©e</strong> ‚Äî pr√©cision ¬±${acc}m<br>
        <a href="https://maps.google.com/?q=${clientGeoLat},${clientGeoLng}" target="_blank"
           style="color:var(--accent2);font-size:11px">Voir sur Google Maps ‚Üí</a>`;
      status.style.color = 'var(--accent3)';
      btn.disabled = false; btn.textContent = 'üîÑ Actualiser la position';
    },
    err => {
      const msgs = { 1:'Acc√®s refus√© ‚Äî autorisez la localisation', 2:'Position indisponible', 3:'D√©lai d√©pass√©' };
      status.textContent = '‚ùå ' + (msgs[err.code] || err.message);
      status.style.color = 'var(--danger)';
      btn.disabled = false; btn.textContent = 'üìç R√©essayer';
    },
    { enableHighAccuracy: true, timeout: 12000, maximumAge: 60000 }
  );
}

async function passerCommande() {
  const lignes = Object.entries(panier);
  if (!lignes.length) return;
  if (!clientFournisseurActif?.id) { showToast('‚ö†Ô∏è S√©lectionnez un fournisseur', true); return; }

  const notes = modeCmdActif === 'retrait'
    ? (document.getElementById('cmdNotesRetrait')?.value?.trim() || '')
    : (document.getElementById('cmdNotes')?.value?.trim() || '');
  const dateSouhaitee = document.getElementById('cmdDate').value;
  const lat = clientGeoLat;
  const lng = clientGeoLng;
  const total = lignes.reduce((s,[,p]) => s + (p.prix*p.quantite), 0);
  const num = 'CMD-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-5);
  const lignesArr = lignes.map(([id, p]) => ({
    produit_id:id, nom:p.nom, quantite:p.quantite,
    prix_unitaire:p.prix, total:p.prix*p.quantite, unite:p.unite, icone:p.icone
  }));

  const btn = document.getElementById('btnPasserCmd');
  btn.disabled = true; btn.textContent = '‚è≥ Envoi...';

  if (useSb) {
    const { error } = await sb.from('commandes').insert({
      numero: num,
      client_id: curClient?.id,
      client_nom: curClient?.nom || '',
      fournisseur_id: clientFournisseurActif.id,
      lignes: JSON.stringify(lignesArr),
      total, statut: 'en_attente',
      notes,
      date_souhaitee: dateSouhaitee || null,
      mode_reception: modeCmdActif,       // 'livraison' | 'retrait'
      client_lat: lat || null,
      client_lng: lng || null,
    });
    if (error) { showToast('‚ùå ' + error.message, true); btn.disabled=false; btn.textContent='‚úÖ Confirmer'; return; }
  }

  // Reset
  panier = {}; clientGeoLat = null; clientGeoLng = null;
  updatePanierBadge();
  renderCatalogue();
  closeMod('panierModal');
  btn.disabled=false; btn.textContent='‚úÖ Confirmer la commande';
  showToast(modeCmdActif === 'retrait' ? 'üè™ Commande retrait envoy√©e !' : 'üéâ Commande envoy√©e !');
  await loadMesCommandes();
  cSwitchTab('commandes', document.querySelectorAll('#cApp .cnitem')[1]);
  document.querySelectorAll('#cApp .cnitem').forEach((n,i) => n.classList.toggle('active', i===1));
}

async function loadMesCommandes() {
  if (!useSb || !curClient?.id) return;
  const { data } = await sb.from('commandes').select('*').eq('client_id', curClient.id).order('created_at', { ascending: false });
  if (data) mesCommandes = data;
  renderMesCommandes();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BON DE COMMANDE ‚Äî TICKET THERMIQUE COMMER√áANT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function imprimerBonCommande(cmd) {
  const date  = new Date(cmd.created_at || Date.now()).toLocaleDateString('fr-DZ',{day:'2-digit',month:'long',year:'numeric'});
  const heure = new Date(cmd.created_at || Date.now()).toLocaleTimeString('fr-DZ',{hour:'2-digit',minute:'2-digit'});
  const lignes = typeof cmd.lignes === 'string' ? JSON.parse(cmd.lignes) : (cmd.lignes || []);
  const total  = cmd.total || lignes.reduce((s,l)=>s+(l.total||l.prix_unitaire*l.quantite||0),0);
  const fournisseurNom = clientFournisseurActif?.nom || cmd.fournisseur_nom || 'Votre fournisseur';
  const modeLabel = cmd.mode_reception === 'retrait' ? 'üè™ Retrait d√©p√¥t' : 'üöö Livraison √† domicile';

  const statutLabel = {
    en_attente:    '‚è≥ En attente de confirmation',
    confirmee:     '‚úÖ Confirm√©e',
    en_preparation:'‚öôÔ∏è En pr√©paration',
    en_livraison:  'üöö En cours de livraison',
    livree:        'üì¶ Livr√©e',
    annulee:       '‚ùå Annul√©e',
  };

  const ticketHTML = `
    <div style="font-family:'Courier New',Courier,monospace;width:300px;max-width:100%;margin:0 auto;padding:12px 10px;font-size:12px;color:#000;background:#fff;line-height:1.6">

      <!-- EN-T√äTE -->
      <div style="text-align:center;padding-bottom:10px;border-bottom:2px dashed #000;margin-bottom:10px">
        <div style="font-size:22px;font-weight:900;letter-spacing:3px">DELITRACK</div>
        <div style="font-size:11px;font-weight:700;letter-spacing:1px;margin-top:2px">BON DE COMMANDE</div>
        <div style="font-size:10px;margin-top:4px;color:#333">${date} √† ${heure}</div>
      </div>

      <!-- NUM√âRO + STATUT -->
      <div style="text-align:center;margin-bottom:10px;padding:6px;border:1px solid #000;border-radius:4px">
        <div style="font-weight:900;font-size:15px;letter-spacing:1px">${cmd.numero || 'CMD-' + String(Date.now()).slice(-5)}</div>
        <div style="font-size:10px;margin-top:2px">${statutLabel[cmd.statut] || cmd.statut || '‚è≥ En attente'}</div>
      </div>

      <!-- FOURNISSEUR -->
      <div style="border-bottom:1px dashed #000;padding-bottom:8px;margin-bottom:8px">
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:3px">Fournisseur</div>
        <div style="font-weight:700">${fournisseurNom}</div>
      </div>

      <!-- COMMER√áANT -->
      <div style="border-bottom:1px dashed #000;padding-bottom:8px;margin-bottom:8px">
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:3px">Commer√ßant</div>
        <div style="font-weight:700">${curClient?.nom || cmd.client_nom || '‚Äî'}</div>
        ${curClient?.telephone ? `<div style="font-size:11px">üìû ${curClient.telephone}</div>` : ''}
        ${curClient?.adresse  ? `<div style="font-size:11px">üìç ${curClient.adresse}</div>`   : ''}
      </div>

      <!-- ARTICLES -->
      <div style="border-bottom:1px dashed #000;padding-bottom:8px;margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;font-weight:700;font-size:11px;border-bottom:1px solid #aaa;padding-bottom:3px;margin-bottom:6px">
          <span style="flex:1">Article</span>
          <span style="width:32px;text-align:center">Qt√©</span>
          <span style="width:36px;text-align:center">P.U</span>
          <span style="width:64px;text-align:right">Total</span>
        </div>
        ${lignes.map(l => {
          const pu  = l.prix_unitaire || l.prix || 0;
          const tot = l.total || pu * (l.quantite || 1);
          return `<div style="display:flex;justify-content:space-between;margin-bottom:3px;font-size:11px">
            <span style="flex:1;overflow:hidden;white-space:nowrap;max-width:100px">${l.nom}</span>
            <span style="width:32px;text-align:center">${l.quantite}</span>
            <span style="width:36px;text-align:center;color:#444">${pu>0?pu.toLocaleString():'-'}</span>
            <span style="width:64px;text-align:right;font-weight:700">${tot.toLocaleString()} DA</span>
          </div>`;
        }).join('')}
      </div>

      <!-- TOTAL -->
      <div style="border-bottom:1px dashed #000;padding-bottom:10px;margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;font-size:15px;font-weight:900">
          <span>TOTAL</span>
          <span>${total.toLocaleString()} DA</span>
        </div>
      </div>

      <!-- MODE LIVRAISON -->
      <div style="border-bottom:1px dashed #000;padding-bottom:8px;margin-bottom:8px;font-size:11px">
        <div style="font-weight:700">Mode de r√©ception</div>
        <div>${modeLabel}</div>
        ${cmd.date_souhaitee ? `<div>üìÖ Date souhait√©e : ${new Date(cmd.date_souhaitee).toLocaleDateString('fr-DZ')}</div>` : ''}
        ${cmd.notes ? `<div>üìù Note : ${cmd.notes}</div>` : ''}
        ${cmd.livreur_nom ? `<div>üöö Livreur : ${cmd.livreur_nom}</div>` : ''}
      </div>

      <!-- PIED DE PAGE -->
      <div style="text-align:center;font-size:10px;color:#444">
        <div>‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>
        <div style="margin-top:6px">Conservez ce bon comme preuve de commande</div>
        <div style="margin-top:2px">DeliTrack ‚Äî Gestion livraison en temps r√©el</div>
        <div style="margin-top:4px;font-size:9px;color:#888">Imprim√© le ${new Date().toLocaleString('fr-DZ')}</div>
      </div>

    </div>`;

  let printArea = document.getElementById('printArea');
  if (!printArea) { printArea = document.createElement('div'); printArea.id = 'printArea'; document.body.appendChild(printArea); }
  printArea.innerHTML = ticketHTML;
  window.print();
  setTimeout(() => { if (printArea) printArea.innerHTML = ''; }, 1500);
}

function renderMesCommandes() {
  const c = document.getElementById('mesCommandesList');
  if (!mesCommandes.length) { c.innerHTML = '<div class="empty"><div class="eico">üìã</div>Aucune commande</div>'; return; }
  const statutLabel = { en_attente:'‚è≥ En attente', confirmee:'‚úÖ Confirm√©e', en_preparation:'‚öôÔ∏è En pr√©paration', en_livraison:'üöö En livraison', livree:'üì¶ Livr√©e', annulee:'‚ùå Annul√©e' };
  const statutColor = { en_attente:'var(--yellow)', confirmee:'var(--accent2)', en_preparation:'var(--accent)', en_livraison:'var(--accent2)', livree:'var(--accent3)', annulee:'var(--danger)' };
  c.innerHTML = mesCommandes.map(cmd => {
    const lignes = typeof cmd.lignes==='string' ? JSON.parse(cmd.lignes) : (cmd.lignes||[]);
    const st = cmd.statut||'en_attente';
    const mode = cmd.mode_reception || 'livraison';
    const modeBadge = mode === 'retrait'
      ? `<span style="font-size:10px;font-weight:700;padding:2px 7px;border-radius:8px;background:rgba(16,185,129,0.12);color:var(--accent3)">üè™ Retrait d√©p√¥t</span>`
      : `<span style="font-size:10px;font-weight:700;padding:2px 7px;border-radius:8px;background:rgba(59,130,246,0.12);color:var(--accent2)">üöö Livraison</span>`;
    const hasGps = cmd.client_lat && cmd.client_lng;
    return `
      <div class="hcard" style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
          <div>
            <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:14px">${cmd.numero}</div>
            <div style="display:flex;align-items:center;gap:6px;margin-top:3px">
              ${modeBadge}
              ${hasGps ? `<span style="font-size:10px;color:var(--accent3)">üìç GPS partag√©</span>` : ''}
            </div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px">${new Date(cmd.created_at).toLocaleDateString('fr-DZ')}</div>
          </div>
          <span style="font-size:11px;font-weight:700;padding:4px 10px;border-radius:20px;background:${statutColor[st]}22;color:${statutColor[st]}">${statutLabel[st]||st}</span>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">${lignes.map(l=>`${l.icone||'üì¶'} ${l.nom} √ó ${l.quantite}`).join(' ¬∑ ')}</div>
        ${cmd.livreur_nom ? `<div style="font-size:12px;color:var(--accent2);margin-bottom:4px">üöö Livreur : ${cmd.livreur_nom}</div>` : ''}
        ${cmd.notes ? `<div style="font-size:12px;color:var(--muted);margin-bottom:4px">üìù ${cmd.notes}</div>` : ''}
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <button onclick="imprimerBonCommande(${JSON.stringify(cmd).replace(/"/g,'&quot;')})" style="padding:8px 14px;background:rgba(139,92,246,0.1);border:1.5px solid rgba(139,92,246,0.3);border-radius:10px;color:#8B5CF6;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px">üñ®Ô∏è Bon de commande</button>
          <span style="font-family:'Syne',sans-serif;font-weight:800;color:var(--accent3)">${(cmd.total||0).toLocaleString()} DA</span>
        </div>
      </div>`;
  }).join('');
}

// Triple-tap sur le logo pour r√©v√©ler le bouton admin
let adminTapCount = 0, adminTapTimer = null;
function adminTap() {
  adminTapCount++;
  clearTimeout(adminTapTimer);
  adminTapTimer = setTimeout(() => { adminTapCount = 0; }, 1000);
  if (adminTapCount >= 3) {
    adminTapCount = 0;
    const box = document.getElementById('roleA');
    const visible = box.style.display !== 'none';
    box.style.display = visible ? 'none' : 'flex';
    box.style.flexDirection = 'column';
    box.style.alignItems = 'center';
    if (!visible) showToast('Mode administration d√©verrouill√©');
  }
}

// Fonction selRole mise √† jour (suppression du lien inscription)
function selRole(r, el) {
  selectedRole = r;
  document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}


</script>

<!-- ======== CLIENT APP ======== -->
<div id="cApp" class="screen">
  <div class="topbar">
    <div>
      <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px">Portail Commer√ßant</div>
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800" id="cWelcome">Commer√ßant</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <div style="position:relative">
        <button id="btnPanier" onclick="openPanier()" style="padding:9px 16px;background:var(--accent);border:none;border-radius:10px;color:white;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer">üõí Panier vide</button>
        <span id="panierBadge" style="display:none;position:absolute;top:-6px;right:-6px;background:var(--danger);color:white;font-size:10px;font-weight:800;width:18px;height:18px;border-radius:50%;align-items:center;justify-content:center;font-family:'Syne',sans-serif">0</span>
      </div>
      <button class="theme-toggle-btn" onclick="toggleTheme()" style="padding:9px 12px;background:var(--card);border:1.5px solid var(--border);border-radius:10px;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:15px;cursor:pointer" title="Changer le th√®me">‚òÄÔ∏è</button>
      <button onclick="openChangeMdp()" style="padding:9px 12px;background:var(--card);border:1.5px solid var(--border);border-radius:10px;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:15px;cursor:pointer" title="Changer le mot de passe">üîë</button>
      <button onclick="logout()" style="padding:9px 14px;background:var(--card);border:1.5px solid var(--border);border-radius:10px;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer">üîì</button>
    </div>
  </div>

  <div style="display:flex;background:var(--surface);border-bottom:1px solid var(--border)">
    <div class="cnitem active" onclick="cSwitchTab('catalogue',this)" style="flex:1;padding:14px;text-align:center;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s">üõí Catalogue</div>
    <div class="cnitem" onclick="cSwitchTab('annonces',this);loadAnnoncesClient()" style="flex:1;padding:14px;text-align:center;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s;position:relative">
      üîî Annonces
      <span id="annonceClientBadge" style="display:none;position:absolute;top:8px;right:8px;background:var(--danger);color:white;font-size:9px;font-weight:800;min-width:16px;height:16px;border-radius:8px;padding:0 4px;align-items:center;justify-content:center">0</span>
    </div>
    <div class="cnitem" onclick="cSwitchTab('commandes',this);loadMesCommandes()" style="flex:1;padding:14px;text-align:center;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s">üìã Commandes</div>
    <div class="cnitem" onclick="cSwitchTab('fournisseurs',this);loadMesFournisseurs()" style="flex:1;padding:14px;text-align:center;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s">üè≠ Fournisseurs</div>
  </div>

  <div style="flex:1;overflow-y:auto;padding:20px">
    <div id="ctc-catalogue" class="ctc active">
      <!-- Banni√®re commandes d√©sactiv√©es -->
      <div id="cmdDesactiveeBanner" style="display:none;background:rgba(239,68,68,0.1);border:1.5px solid rgba(239,68,68,0.3);border-radius:14px;padding:14px 16px;margin-bottom:16px">
        <div style="display:flex;gap:10px;align-items:flex-start">
          <span style="font-size:22px;flex-shrink:0">üö´</span>
          <div>
            <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:14px;color:var(--danger);margin-bottom:4px">Commandes en ligne d√©sactiv√©es</div>
            <div style="font-size:13px;color:var(--text)" id="cmdDesactiveeMessage">Ce fournisseur n'accepte pas les commandes en ligne pour le moment.</div>
          </div>
        </div>
      </div>
      <!-- S√©lecteur fournisseur actif -->
      <div id="fournisseurSelector" style="margin-bottom:16px"></div>
      <div id="catalogueList"></div>
    </div>

    <div id="ctc-annonces" class="ctc" style="display:none">
      <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:4px">Annonces</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:16px">Nouveaut√©s et promotions de vos fournisseurs</div>
      <div id="annoncesClientList"><div class="empty"><div class="eico">üîî</div>Aucune annonce</div></div>
    </div>

    <div id="ctc-commandes" class="ctc" style="display:none">
      <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:4px">Mes commandes</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:20px">Suivi en temps r√©el</div>
      <div id="mesCommandesList"></div>
    </div>
    <div id="ctc-fournisseurs" class="ctc" style="display:none">
      <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:4px">Mes fournisseurs</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:16px">G√©rez vos fournisseurs actifs</div>
      <div id="mesFournisseursList"></div>
      <div style="margin-top:20px">
        <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px">Ajouter un fournisseur</div>
        <div id="tousFournisseursList"></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PANIER -->
<div class="mover" id="panierModal" onclick="closeMod('panierModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhandle"></div>
    <div class="mtitle">üõí Mon panier</div>
    <div id="panierContenu"></div>

    <!-- Choix mode de r√©ception -->
    <div style="margin-bottom:16px">
      <label class="fl" style="margin-bottom:8px;display:block">Mode de r√©ception</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <button id="btnModeLivraison" onclick="selectModeCmd('livraison')"
          style="padding:14px 10px;border-radius:12px;border:2px solid var(--accent);background:rgba(249,115,22,0.1);color:var(--accent);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;text-align:center;transition:all 0.2s">
          üöö Livraison<br><span style="font-size:11px;font-weight:400;color:var(--muted)">√† mon adresse</span>
        </button>
        <button id="btnModeRetrait" onclick="selectModeCmd('retrait')"
          style="padding:14px 10px;border-radius:12px;border:2px solid var(--border);background:var(--card);color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;text-align:center;transition:all 0.2s">
          üè™ Retrait d√©p√¥t<br><span style="font-size:11px;font-weight:400">r√©cup√©rer sur place</span>
        </button>
      </div>
    </div>

    <!-- Section livraison -->
    <div id="sectionLivraison">
      <div style="margin-bottom:12px">
        <label class="fl">Adresse de livraison</label>
        <textarea class="fi" id="cmdNotes" rows="2" placeholder="Ex: Rue des Acacias, B√¢timent B, Appartement 12..." style="margin-top:6px;resize:none"></textarea>
      </div>
      <div style="margin-bottom:14px">
        <label class="fl" style="margin-bottom:8px;display:block">Ma position GPS <span style="color:var(--muted);font-weight:400">(optionnel ‚Äî aide le livreur)</span></label>
        <div id="geoClientStatus" style="font-size:12px;color:var(--muted);margin-bottom:8px">Non captur√©e</div>
        <button onclick="capturerPositionClient()" id="btnGeoClient"
          style="width:100%;padding:11px;background:rgba(59,130,246,0.1);border:1.5px solid rgba(59,130,246,0.3);border-radius:10px;color:var(--accent2);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px">
          üìç Capturer ma position
        </button>
        <input type="hidden" id="cmdLat">
        <input type="hidden" id="cmdLng">
      </div>
    </div>

    <!-- Section retrait -->
    <div id="sectionRetrait" style="display:none">
      <div style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);border-radius:12px;padding:14px;margin-bottom:14px">
        <div style="font-size:13px;font-weight:600;color:var(--accent3);margin-bottom:6px">üè™ Adresse du d√©p√¥t</div>
        <div id="adresseDepot" style="font-size:13px;color:var(--text)">Chargement...</div>
      </div>
      <div style="margin-bottom:14px">
        <label class="fl">Notes (optionnel)</label>
        <textarea class="fi" id="cmdNotesRetrait" rows="2" placeholder="Ex: disponible le matin..." style="margin-top:6px;resize:none"></textarea>
      </div>
    </div>

    <div style="margin-bottom:16px">
      <label class="fl">Date souhait√©e (optionnel)</label>
      <input class="fi" type="date" id="cmdDate" style="margin-top:6px">
    </div>

    <button class="btn-p" style="max-width:100%;margin-bottom:10px" id="btnPasserCmd" onclick="passerCommande()">‚úÖ Confirmer la commande</button>
    <button class="cbtn" onclick="closeMod('panierModal')">Continuer mes achats</button>
  </div>
</div>

<!-- ======== ADMIN APP ======== -->
<div id="adminApp" class="screen">
  <div class="topbar">
    <div>
      <div style="font-size:11px;color:#8B5CF6;text-transform:uppercase;letter-spacing:1px">Administration</div>
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800" id="adminWelcome">Admin</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="theme-toggle-btn" onclick="toggleTheme()" style="padding:9px 12px;background:var(--card);border:1.5px solid var(--border);border-radius:10px;color:var(--muted);font-size:15px;cursor:pointer" title="Changer le th√®me">‚òÄÔ∏è</button>
      <button onclick="logout()" style="padding:9px 14px;background:var(--card);border:1.5px solid var(--border);border-radius:10px;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer">üîì</button>
    </div>
  </div>

  <div class="tabs" style="overflow-x:auto;white-space:nowrap">
    <div class="tab active" onclick="aTab('abonnements',this)">üí≥ Abonnements</div>
    <div class="tab" onclick="aTab('fournisseurs',this);loadAdminFournisseurs()">üè≠ Fournisseurs</div>
    <div class="tab" onclick="aTab('commer√ßants',this);loadAdminClients()">üõí Commer√ßants</div>
  </div>

  <div class="main" style="flex:1;overflow-y:auto;padding:16px">

    <!-- ABONNEMENTS -->
    <div id="ta-abonnements" class="tc active">
      <div class="sec-title">Vue d'ensemble
        <button class="add-btn" onclick="aTab('fournisseurs',document.querySelector('#adminApp .tab'));loadAdminFournisseurs()">+ Fournisseur</button>
      </div>
      <div id="adminAbonnementsList"></div>
    </div>

    <!-- FOURNISSEURS ADMIN -->
    <div id="ta-fournisseurs" class="tc">
      <div class="sec-title">Fournisseurs
        <button class="add-btn" onclick="document.getElementById('adminAddFournisseurModal').classList.add('open')">+ Nouveau</button>
      </div>
      <div id="adminFournisseursList"></div>
    </div>

    <!-- CLIENTS ADMIN -->
    <div id="ta-clients" class="tc">
      <div class="sec-title">Clients
        <button class="add-btn" onclick="document.getElementById('adminAddClientModal').classList.add('open')">+ Nouveau</button>
      </div>
      <div id="adminClientsList"></div>
    </div>

  </div>
</div>

<!-- MODAL ADMIN ‚Äî Ajouter Fournisseur -->
<div class="mover" id="adminAddFournisseurModal" onclick="closeMod('adminAddFournisseurModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhandle"></div>
    <div class="mtitle">üè≠ Nouveau fournisseur</div>
    <div class="msub">Cr√©er un compte et activer l'abonnement</div>
    <div style="margin-bottom:10px">
      <label class="fl">Nom de l'entreprise *</label>
      <input class="fi" id="aFNom" placeholder="SARL Brahim Distribution" style="margin-top:6px">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div><label class="fl">Identifiant *</label><input class="fi" id="aFIdent" placeholder="brahim_dist" style="margin-top:6px"></div>
      <div><label class="fl">Mot de passe *</label><input class="fi" type="password" id="aFMdp" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="margin-top:6px"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">
      <div><label class="fl">Fin d'abonnement *</label><input class="fi" type="date" id="aFDateFin" style="margin-top:6px"></div>
      <div><label class="fl">Prix abonnement (DA)</label><input class="fi" type="number" id="aFPrix" placeholder="15000" style="margin-top:6px"></div>
    </div>
    <button class="btn-p" style="max-width:100%;margin-bottom:10px" id="aFBtn" onclick="adminCreerFournisseur()">‚úÖ Cr√©er le compte</button>
    <button class="cbtn" onclick="closeMod('adminAddFournisseurModal')">Annuler</button>
  </div>
</div>

<!-- MODAL ADMIN ‚Äî Ajouter Client -->
<div class="mover" id="adminAddClientModal" onclick="closeMod('adminAddClientModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhandle"></div>
    <div class="mtitle">üõí Nouveau commer√ßant</div>
    <div class="msub">Cr√©er un compte et activer l'abonnement</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div><label class="fl">Nom *</label><input class="fi" id="aCNom" placeholder="√âpicerie Karim" style="margin-top:6px"></div>
      <div><label class="fl">T√©l√©phone *</label><input class="fi" id="aCTel" placeholder="0555123456" style="margin-top:6px" type="tel"></div>
    </div>
    <div style="margin-bottom:10px">
      <label class="fl">Adresse</label>
      <input class="fi" id="aCAddr" placeholder="Rue, quartier, ville" style="margin-top:6px">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div><label class="fl">Identifiant *</label><input class="fi" id="aCIdent" placeholder="karim_epicerie" style="margin-top:6px"></div>
      <div><label class="fl">Mot de passe *</label><input class="fi" type="password" id="aCMdp" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="margin-top:6px"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">
      <div><label class="fl">Fin d'abonnement *</label><input class="fi" type="date" id="aCDateFin" style="margin-top:6px"></div>
      <div><label class="fl">Prix abonnement (DA)</label><input class="fi" type="number" id="aCPrix" placeholder="8000" style="margin-top:6px"></div>
    </div>
    <button class="btn-p" style="max-width:100%;margin-bottom:10px" id="aCBtn" onclick="adminCreerClient()">‚úÖ Cr√©er le compte</button>
    <button class="cbtn" onclick="closeMod('adminAddClientModal')">Annuler</button>
  </div>
</div>

<!-- MODAL RENOUVELER ABONNEMENT -->
<div class="mover" id="renouvelerModal" onclick="closeMod('renouvelerModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mhandle"></div>
    <div class="mtitle">üîÑ Renouveler l'abonnement</div>
    <div class="msub" id="renouvelerNom"></div>
    <input type="hidden" id="renouvelerType">
    <input type="hidden" id="renouvelerId">
    <div style="margin-bottom:12px">
      <label class="fl">Dur√©e</label>
      <select class="fi" id="renouvelerDuree" style="margin-top:6px">
        <option value="3">3 mois</option>
        <option value="6">6 mois</option>
        <option value="12" selected>12 mois (annuel)</option>
      </select>
    </div>
    <div style="margin-bottom:16px">
      <label class="fl">Prix encaiss√© (DA)</label>
      <input class="fi" type="number" id="renouvelerPrix" placeholder="15000" style="margin-top:6px">
    </div>
    <button class="btn-p" style="max-width:100%;margin-bottom:10px" onclick="confirmerRenouvellement()">‚úÖ Confirmer le renouvellement</button>
    <button class="cbtn" onclick="closeMod('renouvelerModal')">Annuler</button>
  </div>
</div>

<style>
.admin-card{background:var(--card);border:1.5px solid var(--border);border-radius:14px;padding:16px;margin-bottom:10px}
.abo-badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px}
.abo-actif{background:rgba(16,185,129,0.15);color:#10B981}
.abo-expire{background:rgba(239,68,68,0.15);color:#EF4444}
.abo-bientot{background:rgba(245,158,11,0.15);color:#F59E0B}
.abo-essai{background:rgba(139,92,246,0.15);color:#8B5CF6}

/* ‚îÄ‚îÄ LIVREUR INTERFACE VISUELLE ‚îÄ‚îÄ */
.lnav-lbl { font-size: 10px; }
#lApp .bnav .nitem.active { color: var(--accent); }
#lApp .content { padding-bottom: 90px; }

</style>

<style>
/* CLIENT APP */
.ctc{display:none}.ctc.active{display:block}
.c-prod-card{background:var(--card);border:1.5px solid var(--border);border-radius:14px;padding:14px 16px;margin-bottom:10px;transition:border-color 0.2s}
.c-prod-card:hover{border-color:var(--accent)}
.cnitem.active{color:var(--accent)!important;border-bottom-color:var(--accent)!important}
</style>

<script>

// ============================================================
// BILINGUE FR / AR
// ============================================================

// ============================================================
// BILINGUE FR / AR ‚Äî VERSION CORRIG√âE
// ============================================================
const T = {
  fr: {
    loginSub: 'Gestion livraison en temps r√©el',
    roleFourn: 'Fournisseur', roleLivr: 'Livreur', roleClient: 'Commer√ßant',
    labelId: 'Identifiant', placeholderId: 'Votre identifiant',
    labelPass: 'Mot de passe', btnLogin: 'Connexion ‚Üí',
    tabLivreurs: 'Livreurs', tabLivraisons: 'Livraisons', tabStock: 'üì¶ Stock',
    tabClients: 'Commer√ßants', tabEquipe: 'üë• √âquipe', tabCommandes: 'üì¨ Commandes',
    tabAnnonces: 'üì¢ Annonces', tabParams: '‚öôÔ∏è Param√®tres', tabExport: 'üì• Export',
    tabCamion: 'üöö Camion', tabHistorique: 'üìã Historique', tabCredits: 'üí∞ Cr√©dits',
    bonjour: 'Bonjour üëã', gpsWait: 'GPS en attente...', gpsPos: 'Position non captur√©e',
    creditsAtt: 'Cr√©dits en attente',
    infoComm: 'üë§ Informations Commer√ßant', nomComm: 'Nom du commer√ßant / √âpicerie',
    valider: '‚úÖ Valider', tableau: 'Tableau de bord', portalComm: 'Portail Commer√ßant',
    catalogue: 'üõí Catalogue', monPanier: 'üõí Mon panier',
    mesCommandes: 'üìã Commandes', mesAnnonces: 'üîî Annonces',
    navAccueil: 'Accueil', navLivrer: 'Livrer', navComm: 'Commer√ßants',
    navHist: 'Historique', navCredits: 'Cr√©dits', navQuitter: 'Quitter',
    btnCardLivraison: 'Nouvelle<br>livraison', btnCardComm: 'Mes<br>commer√ßants',
    btnCardHist: 'Mes<br>livraisons', btnCardCredits: 'Cr√©dits',
    searchComm: 'üîç Rechercher un commer√ßant existant...',
    rechercherComm: 'Rechercher un commer√ßant existant...',
  },
  ar: {
    loginSub: 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ŸàÿµŸäŸÑ ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ŸÇŸäŸÇŸä',
    roleFourn: 'ŸÖŸàÿ±ŸëÿØ', roleLivr: 'ÿ≥ÿßÿ¶ŸÇ', roleClient: 'ÿ™ÿßÿ¨ÿ±',
    labelId: 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ', placeholderId: 'ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ',
    labelPass: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±', btnLogin: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ‚Üê',
    tabLivreurs: 'ÿßŸÑÿ≥ÿßÿ¶ŸÇŸàŸÜ', tabLivraisons: 'ÿßŸÑÿ™ŸàÿµŸäŸÑÿßÿ™', tabStock: 'üì¶ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ',
    tabClients: 'ÿßŸÑÿ™ÿ¨ÿßÿ±', tabEquipe: 'üë• ÿßŸÑŸÅÿ±ŸäŸÇ', tabCommandes: 'üì¨ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™',
    tabAnnonces: 'üì¢ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™', tabParams: '‚öôÔ∏è ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™', tabExport: 'üì• ÿ™ÿµÿØŸäÿ±',
    tabCamion: 'üöö ÿßŸÑÿ¥ÿßÿ≠ŸÜÿ©', tabHistorique: 'üìã ÿßŸÑÿ≥ÿ¨ŸÑ', tabCredits: 'üí∞ ÿßŸÑÿØŸäŸàŸÜ',
    bonjour: 'ŸÖÿ±ÿ≠ÿ®ÿßŸã üëã', gpsWait: 'ÿßŸÜÿ™ÿ∏ÿßÿ± GPS...', gpsPos: 'ÿßŸÑŸÖŸàŸÇÿπ ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
    creditsAtt: 'ÿØŸäŸàŸÜ ŸÖÿπŸÑŸëŸÇÿ©',
    infoComm: 'üë§ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿßÿ¨ÿ±', nomComm: 'ÿßÿ≥ŸÖ ÿßŸÑÿ™ÿßÿ¨ÿ± / ÿßŸÑÿ®ŸÇÿßŸÑÿ©',
    valider: '‚úÖ ÿ™ÿ£ŸÉŸäÿØ', tableau: 'ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ', portalComm: 'ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿ™ÿßÿ¨ÿ±',
    catalogue: 'üõí ÿßŸÑŸÉÿ™ÿßŸÑŸàÿ¨', monPanier: 'üõí ÿ≥ŸÑÿ© ÿßŸÑÿ¥ÿ±ÿßÿ°',
    mesCommandes: 'üìã ÿ∑ŸÑÿ®ÿßÿ™Ÿä', mesAnnonces: 'üîî ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™',
    navAccueil: 'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©', navLivrer: 'ÿ™ŸàÿµŸäŸÑ', navComm: 'ÿßŸÑÿ™ÿ¨ÿßÿ±',
    navHist: 'ÿßŸÑÿ≥ÿ¨ŸÑ', navCredits: 'ÿßŸÑÿØŸäŸàŸÜ', navQuitter: 'ÿÆÿ±Ÿàÿ¨',
    btnCardLivraison: 'ÿ™ŸàÿµŸäŸÑ<br>ÿ¨ÿØŸäÿØ', btnCardComm: 'ÿ™ÿ¨ÿßÿ±Ÿä',
    btnCardHist: 'ÿ™ŸàÿµŸäŸÑÿßÿ™Ÿä', btnCardCredits: 'ÿßŸÑÿØŸäŸàŸÜ',
    searchComm: 'üîç ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ™ÿßÿ¨ÿ±...',
    rechercherComm: 'ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ™ÿßÿ¨ÿ±...',
  }
};

let currentLang = localStorage.getItem('deliLang') || 'fr';

function toggleLang() {
  currentLang = currentLang === 'fr' ? 'ar' : 'fr';
  localStorage.setItem('deliLang', currentLang);
  applyLang();
}

function applyLang() {
  const lang = currentLang;
  const t = T[lang];

  // Direction RTL/LTR
  document.documentElement.lang = lang;
  document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

  // ‚îÄ‚îÄ Boutons langue : montre toujours la langue CIBLE ‚îÄ‚îÄ
  // En FR ‚Üí bouton üá©üáø ÿπÿ±  |  En AR ‚Üí bouton üá´üá∑ FR
  const nextFlag = lang === 'fr' ? 'üá©üáø' : 'üá´üá∑';
  const nextTxt  = lang === 'fr' ? 'ÿπÿ±'   : 'FR';
  ['', 'F', 'L'].forEach(sfx => {
    const flag = document.getElementById('langBtn' + sfx + 'Flag');
    const txt  = document.getElementById('langBtn' + sfx + 'Txt');
    if (flag) flag.textContent = nextFlag;
    if (txt)  txt.textContent  = nextTxt;
  });

  // ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
  const loginSub = document.querySelector('.login-sub');
  if (loginSub) loginSub.textContent = t.loginSub;

  const roleF = document.getElementById('roleF');
  if (roleF) roleF.innerHTML = '<span class="role-icon">üè≠</span>' + t.roleFourn;
  const roleL = document.getElementById('roleL');
  if (roleL) roleL.innerHTML = '<span class="role-icon">üöö</span>' + t.roleLivr;
  const roleC = document.getElementById('roleC');
  if (roleC) roleC.innerHTML = '<span class="role-icon">üõí</span>' + t.roleClient;

  document.querySelectorAll('label.fl').forEach(lbl => {
    const tx = lbl.textContent.trim();
    if (tx === 'Identifiant'    || tx === 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ')  lbl.textContent = t.labelId;
    if (tx === 'Mot de passe'   || tx === 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±')   lbl.textContent = t.labelPass;
  });
  const lu = document.getElementById('loginUser');
  if (lu) lu.placeholder = t.placeholderId;
  const bl = document.querySelector('.btn-p[onclick="doLogin()"]');
  if (bl) bl.textContent = t.btnLogin;

  // ‚îÄ‚îÄ FOURNISSEUR tabs ‚îÄ‚îÄ
  const fTabMap = {
    livreurs: t.tabLivreurs, livraisons: t.tabLivraisons, stock: t.tabStock,
    clients: t.tabClients, "commer√ßants": t.tabClients, equipe: t.tabEquipe, commandes: t.tabCommandes,
    annonces: t.tabAnnonces, parametres: t.tabParams, export: t.tabExport,
  };
  document.querySelectorAll('#fApp .tab').forEach(tab => {
    const oc = tab.getAttribute('onclick') || '';
    for (const [key, label] of Object.entries(fTabMap)) {
      if (oc.includes("'" + key + "'")) { tab.textContent = label; break; }
    }
  });

  // Topbar fournisseur "Tableau de bord"
  document.querySelectorAll('#fApp .topbar div').forEach(d => {
    const tx = d.textContent.trim();
    if (tx === 'Tableau de bord' || tx === 'ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ') d.textContent = t.tableau;
  });

  // ‚îÄ‚îÄ LIVREUR ‚îÄ‚îÄ
  // Salutation
  const greet = document.querySelector('.greeting');
  if (greet) greet.textContent = t.bonjour;

  // GPS
  const gpsTxt = document.getElementById('gpsStTxt');
  if (gpsTxt && !gpsTxt.textContent.includes('actif') && !gpsTxt.textContent.includes('ŸÜÿ¥ÿ∑'))
    gpsTxt.textContent = t.gpsWait;
  const gpsDsp = document.getElementById('gpsDsp');
  if (gpsDsp && (gpsDsp.textContent.includes('non captur√©e') || gpsDsp.textContent.includes('ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ')))
    gpsDsp.textContent = t.gpsPos;

  // Formulaire livraison
  const fsTitle = document.querySelector('#lt-livrer .fstitle');
  if (fsTitle) fsTitle.textContent = t.infoComm;
  const cni = document.getElementById('clientName');
  if (cni) cni.placeholder = t.nomComm;
  const cs = document.getElementById('clientSearch');
  if (cs) cs.placeholder = t.searchComm;
  const sb = document.getElementById('submitBtn');
  if (sb && !sb.disabled) sb.textContent = t.valider;

  // Cr√©dits titre
  const credSec = document.querySelector('#lt-credits .sec-title');
  if (credSec) {
    const badge = credSec.querySelector('.bcnt');
    credSec.innerHTML = t.creditsAtt + ' ';
    if (badge) credSec.appendChild(badge);
  }

  // Boutons cards visuels livreur (accueil)
  // Boutons cards visuels livreur (accueil)
  const cards = [
    { sel: `[onclick*="lNavTo('livrer')"]`,    txt: t.btnCardLivraison },
    { sel: `[onclick*="lNavTo('clients')"]`,   txt: t.btnCardComm },
    { sel: `[onclick*="lNavTo('historique')"]`,txt: t.btnCardHist },
    { sel: `[onclick*="lNavTo('credits')"]`,   txt: t.btnCardCredits },
  ];
  cards.forEach(({sel, txt}) => {
    try {
      const btn = document.querySelector(sel);
      if (btn) {
        const label = btn.querySelectorAll('div')[1];
        if (label) label.innerHTML = txt;
      }
    } catch(e) {}
  });

  // Nav labels bas livreur
  const navLabels = {
    'lnav-accueil':   t.navAccueil,
    'lnav-livrer':    t.navLivrer,
    'lnav-clients':   t.navComm,
    'lnav-historique':t.navHist,
    'lnav-credits':   t.navCredits,
  };
  Object.entries(navLabels).forEach(([id, label]) => {
    const el = document.getElementById(id);
    if (el) {
      const lbl = el.querySelector('.lnav-lbl');
      if (lbl) lbl.textContent = label;
    }
  });

  // ‚îÄ‚îÄ PORTAIL COMMER√áANT ‚îÄ‚îÄ
  document.querySelectorAll('#cApp .topbar div').forEach(d => {
    const tx = d.textContent.trim();
    if (tx === 'Portail Commer√ßant' || tx === 'ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿ™ÿßÿ¨ÿ±') d.textContent = t.portalComm;
  });
  document.querySelectorAll('#cApp .cnitem').forEach(tab => {
    const oc = tab.getAttribute('onclick') || '';
    if (oc.includes("'catalogue'"))    tab.textContent = t.catalogue;
    else if (oc.includes("'panier'"))  tab.textContent = t.monPanier;
    else if (oc.includes('commandes')) tab.textContent = t.mesCommandes;
    else if (oc.includes('annonces'))  tab.textContent = t.mesAnnonces;
  });
}

document.addEventListener('DOMContentLoaded', applyLang);
window.addEventListener('load', () => { setTimeout(applyLang, 700); });


</script>
</body>
</html>
